(this.webpackJsonpdiagexp1=this.webpackJsonpdiagexp1||[]).push([[0],{50:function(t,e,i){t.exports=i(82)},55:function(t,e,i){},56:function(t,e,i){},82:function(t,e,i){"use strict";i.r(e);var o,n,r,a,c,l,s,u,h,d,p,m,y,g,f=i(1),b=i.n(f),k=i(17),v=i.n(k),O=(i(55),i(56),i(47)),w=i(12),S=i(5),j=i(3),B=i(4),x=i(7),C=i(6),E=i(9),D=i(8),P=i(2),M=(i(14),i(18)),z=i(19),U=i(11),R=Object(U.a)(o=function(t){function e(){return Object(j.a)(this,e),Object(x.a)(this,Object(C.a)(e).apply(this,arguments))}return Object(D.a)(e,t),Object(B.a)(e,[{key:"render",value:function(){var t=this;return b.a.createElement("g",{transform:"translate(".concat(this.props.slot.position.x,",").concat(this.props.slot.position.y,") rotate(0)"),onClick:function(e){return t.onClick(e)}},b.a.createElement("circle",{r:"3",fill:"gray"}))}},{key:"onClick",value:function(t){}}]),e}(b.a.Component))||o,W=i(0),T=Object(U.a)(n=function(t){function e(){var t,i;Object(j.a)(this,e);for(var o=arguments.length,n=new Array(o),r=0;r<o;r++)n[r]=arguments[r];return(i=Object(x.a)(this,(t=Object(C.a)(e)).call.apply(t,[this].concat(n)))).myRef=b.a.createRef(),i}return Object(D.a)(e,t),Object(B.a)(e,[{key:"componentDidMount",value:function(){if(this.myRef.current){var t=this.myRef.current.getBoundingClientRect();this.props.onSize({x:t.width,y:t.height})}}},{key:"componentDidUpdate",value:function(){if(this.myRef.current){var t=this.myRef.current.getBoundingClientRect();this.props.onSize({x:t.width,y:t.height})}}},{key:"render",value:function(){return this.props.block.image?b.a.createElement("image",{width:"100",ref:this.myRef,xlinkHref:this.props.block.image.image}):null}}]),e}(b.a.Component))||n,_=Object(U.a)((a=function(t){function e(t){var i;return Object(j.a)(this,e),i=Object(x.a)(this,Object(C.a)(e).call(this,t)),Object(S.a)(i,"size",c,Object(E.a)(i)),i.myRef=b.a.createRef(),i}return Object(D.a)(e,t),Object(B.a)(e,[{key:"componentDidMount",value:function(){this.myRef.current&&this.props.onSize({x:this.myRef.current.getBBox().width,y:this.myRef.current.getBBox().height})}},{key:"render",value:function(){return b.a.createElement("text",{ref:this.myRef,style:{pointerEvents:"none",userSelect:"none"},x:this.props.block.rect.width/2,y:this.props.block.rect.height/2,dominantBaseline:"middle",textAnchor:"middle"},this.props.block.name)}}]),e}(b.a.Component),c=Object(P.a)(a.prototype,"size",[W.y],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return{x:0,y:0}}}),r=a))||r,F=Object(U.a)((s=function(t){function e(t){var i;return Object(j.a)(this,e),i=Object(x.a)(this,Object(C.a)(e).call(this,t)),Object(S.a)(i,"imageSize",u,Object(E.a)(i)),Object(S.a)(i,"textSize",h,Object(E.a)(i)),i.onTextSize=function(t){i.textSize=t,i.updateRequestedSize()},i.onImageSize=function(t){i.imageSize=t,i.updateRequestedSize()},i}return Object(D.a)(e,t),Object(B.a)(e,[{key:"render",value:function(){var t=this;return b.a.createElement("g",{transform:"translate(".concat(this.props.block.rect.x+this.props.block.translate.x,",").concat(this.props.block.rect.y+this.props.block.translate.y,") rotate(0)"),onMouseDown:function(e){return t.onMouseDown(e)},onClick:function(e){return t.onClick(e)},onDoubleClick:function(e){return t.onDoubleClick(e)}},b.a.createElement("rect",{width:this.props.block.rect.width,height:this.props.block.rect.height,fill:"white",style:{stroke:"#006600"},rx:5}),this.props.isSelected&&b.a.createElement("rect",{x:-3,y:-3,width:this.props.block.rect.width+6,height:this.props.block.rect.height+6,fill:"none",style:{stroke:"#0000FF",strokeWidth:2},rx:5}),this.props.isHovered&&b.a.createElement("rect",{x:-3,y:-3,width:this.props.block.rect.width+6,height:this.props.block.rect.height+6,fill:"none",style:{stroke:"#00FF00",strokeWidth:2},rx:5}),"mmroot"===this.props.block.type?b.a.createElement("rect",{x:"3",y:"3",width:this.props.block.rect.width-6,height:this.props.block.rect.height-6,fill:"white",style:{stroke:"#006600"},rx:5}):null,this.props.isEdited?null:b.a.createElement(_,{block:this.props.block,onSize:this.onTextSize}),b.a.createElement(T,{block:this.props.block,onSize:this.onImageSize}),this.props.block.slots.map((function(t){return b.a.createElement(R,{key:t.key,slot:t})})))}},{key:"updateRequestedSize",value:function(){this.props.block.requestedWidth=this.textSize.x+20}},{key:"onMouseDown",value:function(t){this.props.onSelect(this.props.block,{x:t.clientX,y:t.clientY}),t.stopPropagation()}},{key:"onClick",value:function(t){this.props.block.click(),t.stopPropagation()}},{key:"onDoubleClick",value:function(t){this.props.block.doubleClick()}},{key:"fullSize",get:function(){return this.textSize}}]),e}(b.a.Component),u=Object(P.a)(s.prototype,"imageSize",[W.y],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return{x:0,y:0}}}),h=Object(P.a)(s.prototype,"textSize",[W.y],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return{x:0,y:0}}}),Object(P.a)(s.prototype,"fullSize",[W.j],Object.getOwnPropertyDescriptor(s.prototype,"fullSize"),s.prototype),l=s))||l,I=(d=function(){function t(e,i,o,n){Object(j.a)(this,t),Object(S.a)(this,"x",p,this),Object(S.a)(this,"y",m,this),Object(S.a)(this,"width",y,this),Object(S.a)(this,"height",g,this),this.x=e,this.y=i,this.width=o,this.height=n}return Object(B.a)(t,[{key:"contains",value:function(t){return!(t.x<this.x||t.x>this.x+this.width||t.y<this.y||t.y>this.y+this.height)}}],[{key:"copy",value:function(e){return new t(e.x,e.y,e.width,e.height)}}]),t}(),p=Object(P.a)(d.prototype,"x",[W.y],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),m=Object(P.a)(d.prototype,"y",[W.y],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),y=Object(P.a)(d.prototype,"width",[W.y],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),g=Object(P.a)(d.prototype,"height",[W.y],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),d),L=function(){function t(){Object(j.a)(this,t),this.map=new Map}return Object(B.a)(t,[{key:"push",value:function(t,e){var i=this.map.get(t)||[];i.push(e),this.map.set(t,i)}},{key:"get",value:function(t){return this.map.get(t)||[]}},{key:"empty",value:function(t){return 0===this.get(t).length}},{key:"keys",value:function(){return this.map.keys()}}]),t}();function q(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(t){var e=16*Math.random()|0;return("x"===t?e:3&e|8).toString(16)}))}function H(t){for(var e=arguments.length,i=new Array(e>1?e-1:0),o=1;o<e;o++)i[o-1]=arguments[o];for(var n=0,r=i;n<r.length;n++){var a=r[n],c=t.indexOf(a);-1!==c&&t.splice(c,1)}return t}function J(t){return Math.sqrt(t.x*t.x+t.y*t.y)}var A,N=function(t){function e(){return Object(j.a)(this,e),Object(x.a)(this,Object(C.a)(e).apply(this,arguments))}return Object(D.a)(e,t),Object(B.a)(e,[{key:"render",value:function(){return b.a.createElement("g",null,b.a.createElement("g",{id:"g3979",transform:"translate(-0.10620686,-0.56696429)"},b.a.createElement("rect",{ry:"1.0444876",y:"-9.3742828",x:"-9.8492556",height:"19.63636",width:"19.425177",id:"rect3942",style:{fill:"white",stroke:"#000000",strokeWidth:"1"}}),b.a.createElement("path",{id:"rect3944",d:"m -3.3174074,-7.0890472 c -0.5786464,0 -1.0443792,0.4657354 -1.0443792,1.0443818 v 2.1626565 h -2.1626592 c -0.5786464,0 -1.0443818,0.4657355 -1.0443818,1.0443819 v 6.7313729 c 0,0.5786438 0.4657354,1.0443792 1.0443818,1.0443792 h 2.1626592 v 2.1626592 c 0,0.5786464 0.4657328,1.0443792 1.0443792,1.0443792 h 6.7313729 c 0.5786464,0 1.0443819,-0.4657328 1.0443819,-1.0443792 V 4.9381251 h 2.1626565 c 0.5786464,0 1.0443818,-0.4657354 1.0443818,-1.0443792 V -2.837627 c 0,-0.5786464 -0.4657354,-1.0443819 -1.0443818,-1.0443819 H 4.4583474 v -2.1626565 c 0,-0.5786464 -0.4657355,-1.0443818 -1.0443819,-1.0443818 z",style:{fill:"purple",stroke:"#000000",strokeWidth:"1"}})))}}]),e}(b.a.Component),K=function(t){function e(){return Object(j.a)(this,e),Object(x.a)(this,Object(C.a)(e).apply(this,arguments))}return Object(D.a)(e,t),Object(B.a)(e,[{key:"render",value:function(){return b.a.createElement("g",null,b.a.createElement("g",{id:"g3979",transform:"translate(-0.10620686,-0.56696429)"},b.a.createElement("rect",{ry:"1.0444876",y:"-9.3742828",x:"-9.8492556",height:"19.63636",width:"19.425177",id:"rect3942",style:{fill:"white",stroke:"#000000",strokeWidth:"1"}}),b.a.createElement("rect",{style:{fill:"white",stroke:"#000000",strokeWidth:"1"},id:"rect4021",width:"15.485204",height:"8.2242823",x:"-7.7426019",y:"-4.1617403",ry:"0.98811853"})))}}]),e}(b.a.Component),X=function(t){function e(){return Object(j.a)(this,e),Object(x.a)(this,Object(C.a)(e).apply(this,arguments))}return Object(D.a)(e,t),Object(B.a)(e,[{key:"render",value:function(){var t=this,e=b.a.createElement("rect",{width:10,height:10,fill:this.props.button.color});switch(this.props.button.icon){case"add":e=b.a.createElement(N,null);break;case"remove":e=b.a.createElement(K,null)}return b.a.createElement("g",{transform:"translate(".concat(this.props.button.position.x,",").concat(this.props.button.position.y,") rotate(0)"),onClick:function(e){return t.onClick(e)}},e)}},{key:"onClick",value:function(t){this.props.button.click()}}]),e}(b.a.Component),Y=Object(U.a)(A=function(t){function e(){return Object(j.a)(this,e),Object(x.a)(this,Object(C.a)(e).apply(this,arguments))}return Object(D.a)(e,t),Object(B.a)(e,[{key:"render",value:function(){var t=this.props.connection.fromPoint.x,e=this.props.connection.fromPoint.y,i=this.props.connection.toPoint.x,o=this.props.connection.toPoint.y;return b.a.createElement("path",{style:{stroke:"rgb(255,0,0)",strokeWidth:"2",fill:"none"},d:"M ".concat(t," ").concat(e," C ").concat(i," ").concat(e," ").concat(t," ").concat(o," ").concat(i," ").concat(o)})}}]),e}(b.a.Component))||A,V=i(15);V.CategoryServiceFactory.setDefaultConfiguration(new V.CategoryConfiguration(V.LogLevel.Info));var $,G,Q,Z,tt,et,it,ot,nt,rt,at,ct,lt,st,ut,ht,dt,pt,mt,yt,gt,ft,bt,kt,vt,Ot,wt,St,jt,Bt,xt,Ct,Et,Dt,Pt,Mt=new V.Category("mindMap"),zt=new V.Category("draging",Mt),Ut=new V.Category("diagramBlockLayout",Mt),Rt=new V.Category("DiagramSceneComponent"),Wt=Object(U.a)((G=function(t){function e(){var t,i;Object(j.a)(this,e);for(var o=arguments.length,n=new Array(o),r=0;r<o;r++)n[r]=arguments[r];return(i=Object(x.a)(this,(t=Object(C.a)(e)).call.apply(t,[this].concat(n)))).x0=0,i.y0=0,i.mouseDownPos=void 0,i.selectionBlock=void 0,Object(S.a)(i,"hoverBlock",Q,Object(E.a)(i)),i.myRef=b.a.createRef(),i}return Object(D.a)(e,t),Object(B.a)(e,[{key:"componentDidMount",value:function(){if(this.myRef.current){var t=this.myRef.current.getBoundingClientRect().width/2,e=this.myRef.current.getBoundingClientRect().height/2;this.props.diagramScene.sceneTranslate.x=t,this.props.diagramScene.sceneTranslate.y=e,this.x0=this.myRef.current.getBoundingClientRect().left,this.y0=this.myRef.current.getBoundingClientRect().top}}},{key:"render",value:function(){var t=this,e=this.props.diagramScene.sceneTranslate.x+this.props.diagramScene.sceneTranslateDelta.x,i=this.props.diagramScene.sceneTranslate.y+this.props.diagramScene.sceneTranslateDelta.y;return b.a.createElement("svg",{ref:this.myRef,width:"100%",height:"100%",xmlns:"http://www.w3.org/2000/svg",xmlnsXlink:"http://www.w3.org/1999/xlink",onMouseDown:function(e){return t.onMouseDown(e)},onMouseMove:function(e){return t.onMouseMove(e)},onMouseUp:function(e){return t.onMouseUp(e)},onClick:function(e){return t.onClick(e)}},b.a.createElement("g",{transform:"translate(".concat(e,",").concat(i,")")},this.props.diagramScene.diagramBlocks.map((function(e){return b.a.createElement(F,{key:e.uid,block:e,isSelected:t.props.diagramScene.selectedBlock===e,isHovered:t.hoverBlock===e,isEdited:t.props.diagramScene.editedBlock===e,onSelect:function(e,i){return t.onSelect(e,i)}})})),this.props.diagramScene.diagramConnections.map((function(t){return b.a.createElement(Y,{key:t.uid,connection:t})})),this.props.diagramScene.activeButtons.map((function(t){return b.a.createElement(X,{key:t.uid,button:t})}))))}},{key:"onSelect",value:function(t,e){this.mouseDownPos=this.clientToScene(e),this.selectionBlock=t,this.props.diagramScene.selectedBlock=t,this.props.diagramScene.setEditedBlock(void 0)}},{key:"onMouseDown",value:function(t){Rt.info("onMouseDown"),this.props.diagramScene.editedBlock&&(this.props.diagramScene.setEditedBlock(void 0),this.props.diagramScene.onEdit=!0),this.mouseDownPos=this.clientToScene({x:t.pageX,y:t.pageY})}},{key:"onMouseMove",value:function(t){if(this.mouseDownPos&&this.selectionBlock){Rt.info("onMouseMove block");var e=this.clientToScene({x:t.pageX,y:t.pageY});this.selectionBlock.translate={x:e.x-this.mouseDownPos.x,y:e.y-this.mouseDownPos.y},this.props.diagramScene.activeButtons=[],this.hoverBlock=void 0;var i=!0,o=!1,n=void 0;try{for(var r,a=this.props.diagramScene.diagramBlocks[Symbol.iterator]();!(i=(r=a.next()).done);i=!0){var c=r.value;if(c!=this.selectionBlock)c.rect.contains(e)&&(this.hoverBlock=c)}}catch(h){o=!0,n=h}finally{try{i||null==a.return||a.return()}finally{if(o)throw n}}}else if(this.mouseDownPos){Rt.info("onMouseMove scene");var l=this.clientToScene({x:t.pageX,y:t.pageY}),s=l.x-this.mouseDownPos.x,u=l.y-this.mouseDownPos.y;J({x:s,y:u})>40&&(this.props.diagramScene.sceneTranslateDelta={x:s,y:u})}}},{key:"onMouseUp",value:function(t){if(Rt.info("onMouseUp"),this.hoverBlock=void 0,this.selectionBlock&&this.mouseDownPos){var e=this.clientToScene({x:t.pageX,y:t.pageY});if(J({x:e.x-this.mouseDownPos.x,y:e.y-this.mouseDownPos.y})>20){var i={x:this.selectionBlock.rect.x+e.x-this.mouseDownPos.x,y:this.selectionBlock.rect.y+e.y-this.mouseDownPos.y};this.selectionBlock.setPosition(i),this.selectionBlock.dragEnd(e)}else this.selectionBlock.translate={x:0,y:0};this.selectionBlock=void 0,this.mouseDownPos=void 0}else if(this.mouseDownPos){var o=this.clientToScene({x:t.pageX,y:t.pageY}),n=o.x-this.mouseDownPos.x,r=o.y-this.mouseDownPos.y;J({x:n,y:r})>40&&(this.props.diagramScene.sceneTranslate.x+=n,this.props.diagramScene.sceneTranslate.y+=r),this.props.diagramScene.sceneTranslateDelta={x:0,y:0},this.mouseDownPos=void 0}}},{key:"clientToScene",value:function(t){return{x:t.x-this.props.diagramScene.sceneTranslate.x-this.x0,y:t.y-this.props.diagramScene.sceneTranslate.y-this.y0}}},{key:"onClick",value:function(t){this.props.diagramScene.activeButtons=[]}}]),e}(b.a.Component),Q=Object(P.a)(G.prototype,"hoverBlock",[W.y],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),Object(P.a)(G.prototype,"onMouseDown",[W.h],Object.getOwnPropertyDescriptor(G.prototype,"onMouseDown"),G.prototype),Object(P.a)(G.prototype,"onMouseUp",[W.h],Object.getOwnPropertyDescriptor(G.prototype,"onMouseUp"),G.prototype),$=G))||$,Tt=(Z=function(t){function e(t,i,o,n,r,a){var c;return Object(j.a)(this,e),(c=Object(x.a)(this,Object(C.a)(e).call(this))).uid=void 0,Object(S.a)(c,"name",tt,Object(E.a)(c)),c.type=void 0,Object(S.a)(c,"rect",et,Object(E.a)(c)),Object(S.a)(c,"translate",it,Object(E.a)(c)),Object(S.a)(c,"slots",ot,Object(E.a)(c)),Object(S.a)(c,"debugIdx",nt,Object(E.a)(c)),Object(S.a)(c,"finishedEditing",rt,Object(E.a)(c)),Object(S.a)(c,"requestedWidth",at,Object(E.a)(c)),Object(S.a)(c,"image",ct,Object(E.a)(c)),Object(S.a)(c,"imageUrl",lt,Object(E.a)(c)),c.uid=t,c.name=i,c.type=o,c.slots=n,c.rect=r,c.debugIdx=0,c.translate={x:0,y:0},c.image=a,c}return Object(D.a)(e,t),Object(B.a)(e,[{key:"setPosition",value:function(t){this.translate={x:0,y:0},this.rect.x=t.x,this.rect.y=t.y,this.fireChangeRect(this)}},{key:"click",value:function(){this.fireClick(this)}},{key:"doubleClick",value:function(){this.fireDoubleClick(this)}},{key:"dragEnd",value:function(t){this.fireDragEnd(this,t)}},{key:"name2slot",get:function(){var t=new Map,e=!0,i=!1,o=void 0;try{for(var n,r=this.slots[Symbol.iterator]();!(e=(n=r.next()).done);e=!0){var a=n.value;t.set(a.name,a)}}catch(c){i=!0,o=c}finally{try{e||null==r.return||r.return()}finally{if(i)throw o}}return t}}]),e}(function(){function t(){Object(j.a)(this,t),this.clickCallbacks=[],this.doubleClickCallbacks=[],this.changeRectCallbacks=[],this.dragEndCallbacks=[]}return Object(B.a)(t,[{key:"on",value:function(t,e){switch(t){case"click":this.clickCallbacks.push(e);break;case"doubleClick":this.doubleClickCallbacks.push(e);break;case"changeRect":this.changeRectCallbacks.push(e);break;case"dragEnd":this.dragEndCallbacks.push(e)}}},{key:"fireClick",value:function(t){var e=!0,i=!1,o=void 0;try{for(var n,r=this.clickCallbacks[Symbol.iterator]();!(e=(n=r.next()).done);e=!0){(0,n.value)(t)}}catch(a){i=!0,o=a}finally{try{e||null==r.return||r.return()}finally{if(i)throw o}}}},{key:"fireDoubleClick",value:function(t){var e=!0,i=!1,o=void 0;try{for(var n,r=this.doubleClickCallbacks[Symbol.iterator]();!(e=(n=r.next()).done);e=!0){(0,n.value)(t)}}catch(a){i=!0,o=a}finally{try{e||null==r.return||r.return()}finally{if(i)throw o}}}},{key:"fireChangeRect",value:function(t){var e=!0,i=!1,o=void 0;try{for(var n,r=this.changeRectCallbacks[Symbol.iterator]();!(e=(n=r.next()).done);e=!0){(0,n.value)(t)}}catch(a){i=!0,o=a}finally{try{e||null==r.return||r.return()}finally{if(i)throw o}}}},{key:"fireDragEnd",value:function(t,e){var i=!0,o=!1,n=void 0;try{for(var r,a=this.dragEndCallbacks[Symbol.iterator]();!(i=(r=a.next()).done);i=!0){(0,r.value)(t,e)}}catch(c){o=!0,n=c}finally{try{i||null==a.return||a.return()}finally{if(o)throw n}}}}]),t}()),tt=Object(P.a)(Z.prototype,"name",[W.y],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),et=Object(P.a)(Z.prototype,"rect",[W.y],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),it=Object(P.a)(Z.prototype,"translate",[W.y],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),ot=Object(P.a)(Z.prototype,"slots",[W.y],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),nt=Object(P.a)(Z.prototype,"debugIdx",[W.y],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),rt=Object(P.a)(Z.prototype,"finishedEditing",[W.y],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),at=Object(P.a)(Z.prototype,"requestedWidth",[W.y],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),ct=Object(P.a)(Z.prototype,"image",[W.y],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),lt=Object(P.a)(Z.prototype,"imageUrl",[W.y],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),Object(P.a)(Z.prototype,"setPosition",[W.h],Object.getOwnPropertyDescriptor(Z.prototype,"setPosition"),Z.prototype),Object(P.a)(Z.prototype,"name2slot",[W.j],Object.getOwnPropertyDescriptor(Z.prototype,"name2slot"),Z.prototype),Z),_t=function(){function t(e,i,o,n,r){Object(j.a)(this,t),this.uid=e,this.positionHint=i,this.icon=o,this.color=n,this.position={x:0,y:0},this.clickCallbacks=[],r&&this.on("click",r)}return Object(B.a)(t,[{key:"click",value:function(){var t=!0,e=!1,i=void 0;try{for(var o,n=this.clickCallbacks[Symbol.iterator]();!(t=(o=n.next()).done);t=!0){(0,o.value)()}}catch(r){e=!0,i=r}finally{try{t||null==n.return||n.return()}finally{if(e)throw i}}}},{key:"on",value:function(t,e){this.clickCallbacks.push(e)}}]),t}(),Ft=(st=function(){function t(e,i,o){Object(j.a)(this,t),this.from=e,this.to=i,this.type=o,Object(S.a)(this,"fromPoint",ut,this),Object(S.a)(this,"toPoint",ht,this),this.fromPoint={x:0,y:0},this.toPoint={x:0,y:0}}return Object(B.a)(t,[{key:"uid",get:function(){return"".concat(this.from.blockUid,":").concat(this.from.slot,":").concat(this.to.blockUid,":").concat(this.to.slot)}}]),t}(),ut=Object(P.a)(st.prototype,"fromPoint",[W.y],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),ht=Object(P.a)(st.prototype,"toPoint",[W.y],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),st),It=(dt=function(){function t(e,i){var o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{x:0,y:0};Object(j.a)(this,t),this.name=e,this.type=i,Object(S.a)(this,"position",pt,this),this.position=o}return Object(B.a)(t,[{key:"key",get:function(){return this.name}}]),t}(),pt=Object(P.a)(dt.prototype,"position",[W.y],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),dt),Lt=function(){function t(){Object(j.a)(this,t)}return Object(B.a)(t,[{key:"layoutBlockButtons",value:function(t,e){var i=new L,o=!0,n=!1,r=void 0;try{for(var a,c=e[Symbol.iterator]();!(o=(a=c.next()).done);o=!0){var l=a.value;i.push(l.positionHint,l)}}catch(f){n=!0,r=f}finally{try{o||null==c.return||c.return()}finally{if(n)throw r}}var s=t.rect,u=s.x+s.width-10,h=s.y-10-4,d=!0,p=!1,m=void 0;try{for(var y,g=i.get("topRight")[Symbol.iterator]();!(d=(y=g.next()).done);d=!0){y.value.position={x:u,y:h},u-=24}}catch(f){p=!0,m=f}finally{try{d||null==g.return||g.return()}finally{if(p)throw m}}}}]),t}(),qt=i(25),Ht=(mt=function(){function t(e){Object(j.a)(this,t),this.scene=e,Object(qt.a)(this,"blocks"),Object(qt.a)(this,"blockConnections"),Object(qt.a)(this,"columnBlocks")}return Object(B.a)(t,[{key:"getOutputSlotConnections",value:function(t,e){return this.blockConnections.output.get(t).filter((function(t){return t.from.slot===e}))}},{key:"getInputSlotConnections",value:function(t,e){return this.blockConnections.input.get(t).filter((function(t){return t.to.slot===e}))}},{key:"getChildBlocks",value:function(t){var e=[],i=!0,o=!1,n=void 0;try{for(var r,a=this.blockConnections.output.get(t)[Symbol.iterator]();!(i=(r=a.next()).done);i=!0){var c=r.value;e.push(c.to.blockUid),e.push.apply(e,Object(w.a)(this.getChildBlocks(c.to.blockUid)))}}catch(l){o=!0,n=l}finally{try{i||null==a.return||a.return()}finally{if(o)throw n}}return e}},{key:"getFistChildBlock",value:function(t,e){if("mmroot"===t.type){var i=this.blockConnections.output.get(t.uid);if((i=1===e?i.filter((function(t){return"or"===t.from.slot})):i.filter((function(t){return"ol"===t.from.slot}))).length>0)return this.blocks.get(i[0].to.blockUid)}else{var o=this.getChildBlocks(t.uid);if(o.length>0)return this.blocks.get(o[0])}}},{key:"getParentBlock",value:function(t){return"mmroot"===t.type?t:this.blocks.get(this.blockConnections.input.get(t.uid)[0].from.blockUid)}},{key:"updateBlockPosition",value:function(t,e,i,o){var n=this.blocks.get(e.to.blockUid);t.push(i+o,n);var r=!0,a=!1,c=void 0;try{for(var l,s=this.blockConnections.output.get(n.uid)[Symbol.iterator]();!(r=(l=s.next()).done);r=!0){var u=l.value;this.updateBlockPosition(t,u,i+o,o)}}catch(h){a=!0,c=h}finally{try{r||null==s.return||s.return()}finally{if(a)throw c}}}},{key:"getBlockColumnIdx",value:function(t){if("mmroot"===t.type)return 0;for(var e=0;;){var i=this.blockConnections.input.get(t.uid)[0];if(e+=1,"mmroot"===(t=this.blocks.get(i.from.blockUid)).type)return"ol"===i.from.slot?-e:e}}},{key:"blockSide",value:function(t){if("mmroot"===t.type)return 0;for(var e=this.blockConnections.input.get(t.uid)[0];"mmroot"!==t.type;)e=this.blockConnections.input.get(t.uid)[0],t=this.blocks.get(e.from.blockUid);return"ol"===e.from.slot?-1:1}},{key:"blocks",get:function(){var t=new Map,e=!0,i=!1,o=void 0;try{for(var n,r=this.scene.diagramBlocks[Symbol.iterator]();!(e=(n=r.next()).done);e=!0){var a=n.value;t.set(a.uid,a)}}catch(c){i=!0,o=c}finally{try{e||null==r.return||r.return()}finally{if(i)throw o}}return t}},{key:"blockConnections",get:function(){var t=new L,e=new L,i=!0,o=!1,n=void 0;try{for(var r,a=this.scene.diagramConnections[Symbol.iterator]();!(i=(r=a.next()).done);i=!0){var c=r.value;t.push(c.to.blockUid,c),e.push(c.from.blockUid,c)}}catch(l){o=!0,n=l}finally{try{i||null==a.return||a.return()}finally{if(o)throw n}}return{input:t,output:e}}},{key:"columnBlocks",get:function(){console.log("columnBlock");var t=new L,e=this.scene.diagramBlocks[0];t.push(0,e);var i=this.blockConnections.output.get(e.uid),o=i.filter((function(t){return"ol"===t.from.slot})),n=!0,r=!1,a=void 0;try{for(var c,l=o[Symbol.iterator]();!(n=(c=l.next()).done);n=!0){var s=c.value;this.updateBlockPosition(t,s,0,-1)}}catch(f){r=!0,a=f}finally{try{n||null==l.return||l.return()}finally{if(r)throw a}}var u=i.filter((function(t){return"or"===t.from.slot})),h=!0,d=!1,p=void 0;try{for(var m,y=u[Symbol.iterator]();!(h=(m=y.next()).done);h=!0){var g=m.value;this.updateBlockPosition(t,g,0,1)}}catch(f){d=!0,p=f}finally{try{h||null==y.return||y.return()}finally{if(d)throw p}}return t}}]),t}(),Object(P.a)(mt.prototype,"blocks",[W.j],Object.getOwnPropertyDescriptor(mt.prototype,"blocks"),mt.prototype),Object(P.a)(mt.prototype,"blockConnections",[W.j],Object.getOwnPropertyDescriptor(mt.prototype,"blockConnections"),mt.prototype),Object(P.a)(mt.prototype,"columnBlocks",[W.j],Object.getOwnPropertyDescriptor(mt.prototype,"columnBlocks"),mt.prototype),mt),Jt=(yt=function(){function t(e){Object(j.a)(this,t),this.diagramStructure=e}return Object(B.a)(t,[{key:"layout",value:function(){var t=this.diagramStructure.scene.diagramBlocks[0];if("mmroot"!==t.type)throw new Error("Invalid diagram structure");t.slots[0].position={x:0,y:t.rect.height/2},t.slots[1].position={x:t.rect.width,y:t.rect.height/2};var e=this.diagramStructure.getOutputSlotConnections(t.uid,"or"),i=[],o=!0,n=!1,r=void 0;try{for(var a,c=e[Symbol.iterator]();!(o=(a=c.next()).done);o=!0){var l=a.value;i.push(l.to.blockUid),i.push.apply(i,Object(w.a)(this.diagramStructure.getChildBlocks(l.to.blockUid)))}}catch(x){n=!0,r=x}finally{try{o||null==c.return||c.return()}finally{if(n)throw r}}var s=this.diagramStructure.getOutputSlotConnections(t.uid,"ol"),u=[],h=!0,d=!1,p=void 0;try{for(var m,y=s[Symbol.iterator]();!(h=(m=y.next()).done);h=!0){var g=m.value;u.push(g.to.blockUid),u.push.apply(u,Object(w.a)(this.diagramStructure.getChildBlocks(g.to.blockUid)))}}catch(x){d=!0,p=x}finally{try{h||null==y.return||y.return()}finally{if(d)throw p}}for(var f=0,b=i;f<b.length;f++){var k=b[f],v=this.diagramStructure.blocks.get(k);v.slots[0].position={x:0,y:v.rect.height/2},v.slots[1].position={x:v.rect.width,y:v.rect.height/2}}for(var O=0,S=u;O<S.length;O++){var j=S[O],B=this.diagramStructure.blocks.get(j);B.slots[0].position={x:B.rect.width,y:B.rect.height/2},B.slots[1].position={x:0,y:B.rect.height/2}}}}]),t}(),Object(P.a)(yt.prototype,"layout",[W.h],Object.getOwnPropertyDescriptor(yt.prototype,"layout"),yt.prototype),yt),At=function(){function t(e){Object(j.a)(this,t),this.diagramStructure=e,this.disposers=[]}return Object(B.a)(t,[{key:"layout",value:function(){var t=this,e=!0,i=!1,o=void 0;try{for(var n,r=this.disposers[Symbol.iterator]();!(e=(n=r.next()).done);e=!0){(0,n.value)()}}catch(d){i=!0,o=d}finally{try{e||null==r.return||r.return()}finally{if(i)throw o}}var a=!0,c=!1,l=void 0;try{for(var s,u=function(){var e=s.value,i=t.diagramStructure.blocks.get(e.from.blockUid),o=t.diagramStructure.blocks.get(e.to.blockUid);t.disposers.push(Object(W.i)((function(){return t.setConnectionPosition(e,i,o)}),{delay:30}))},h=this.diagramStructure.scene.diagramConnections[Symbol.iterator]();!(a=(s=h.next()).done);a=!0)u()}catch(d){c=!0,l=d}finally{try{a||null==h.return||h.return()}finally{if(c)throw l}}}},{key:"setConnectionPosition",value:function(t,e,i){var o=e.name2slot.get(t.from.slot).position,n=i.name2slot.get(t.to.slot).position;t.fromPoint={x:o.x+e.rect.x+e.translate.x,y:o.y+e.rect.y+e.translate.y},t.toPoint={x:n.x+i.rect.x+i.translate.x,y:n.y+i.rect.y+i.translate.y}}}]),t}(),Nt={hMargin:30,vMargin:10},Kt=function(){function t(e){var i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:Nt;Object(j.a)(this,t),this.diagramStructure=e,this.parameters=i,this.blockColumns=new Map,this.columnBlocks=new L,this.childShift=new Map,this.blockHeight=new Map,this.blockChildWidth=new Map,this.columnWidth=new Map,this.columnCenter=new Map,this.blockPosition=new Map}return Object(B.a)(t,[{key:"layoutColumns",value:function(){if(!this.diagramStructure)throw new Error("Diagram data not defined");var t=this.diagramStructure.scene.diagramBlocks;this.blockColumns=new Map,this.columnBlocks=new L;for(var e=this.diagramStructure.blockConnections.input,i=0;i<t.length;++i)if(0===i){if(this.blockColumns.set(t[i].uid,0),this.columnBlocks.push(i,t[i].uid),!e.empty(t[i].uid))throw new Error("Invalid mm diagram blocks structure (first block must be root block - no input connections)")}else{var o=e.get(t[i].uid);if(1!==o.length)throw new Error("Invalid mm diagram blocks structure (each block except root must have exactly one input connection )");var n=this.blockColumns.get(o[0].from.blockUid);if(void 0===n)throw new Error("Invalid mm diagram blocks structure (parent block must preceed child block)");var r=n;0===r?"or"===o[0].from.slot?r+=1:r-=1:r>0?r+=1:r<0&&(r-=1),this.blockColumns.set(t[i].uid,r),this.columnBlocks.push(r,t[i].uid)}}},{key:"layout",value:function(){var t=this.diagramStructure.blockConnections,e=t.input,i=t.output;this.layoutColumns();for(var o=Array.from(this.columnBlocks.keys()).sort((function(t,e){return t-e})),n=o[0],r=o[o.length-1],a=n;a<=r;++a){var c=0,l=!0,s=!1,u=void 0;try{for(var h,d=this.columnBlocks.get(a)[Symbol.iterator]();!(l=(h=d.next()).done);l=!0){var p=h.value;c=Math.max(c,this.diagramStructure.blocks.get(p).rect.width)}}catch(W){s=!0,u=W}finally{try{l||null==d.return||d.return()}finally{if(s)throw u}}this.columnWidth.set(a,c)}var m=0;this.columnCenter.set(0,0);for(var y=1;y<=r;++y){var g=this.columnWidth.get(y-1),f=this.columnWidth.get(y);m=m+g/2+this.parameters.hMargin+f/2,this.columnCenter.set(y,m)}m=0;for(var b=-1;b>=n;--b){var k=this.columnWidth.get(b+1),v=this.columnWidth.get(b);m=m-k/2-this.parameters.hMargin-v/2,this.columnCenter.set(b,m)}var O=this.diagramStructure.scene.diagramBlocks[0];if(e.get(O.uid).length>0)throw new Error("Invalid diagram structure, root block has input connections");var w=!0,S=!1,j=void 0;try{for(var B,x=i.get(O.uid)[Symbol.iterator]();!(w=(B=x.next()).done);w=!0){var C=B.value;this.updateChildHeight(C.to.blockUid)}}catch(W){S=!0,j=W}finally{try{w||null==x.return||x.return()}finally{if(S)throw j}}this.blockPosition.set(O.uid,{x:0,y:0}),this.updateChildPositions(1,this.columnBlocks.get(1),{x:0,y:0}),this.updateChildPositions(-1,this.columnBlocks.get(-1),{x:0,y:0});var E=!0,D=!1,P=void 0;try{for(var M,z=this.diagramStructure.scene.diagramBlocks[Symbol.iterator]();!(E=(M=z.next()).done);E=!0){var U=M.value,R=this.blockPosition.get(U.uid);U.rect=new I(R.x-U.rect.width/2,R.y-U.rect.height/2,U.rect.width,U.rect.height)}}catch(W){D=!0,P=W}finally{try{E||null==z.return||z.return()}finally{if(D)throw P}}}},{key:"updateChildPositions",value:function(t,e,i){if(!this.diagramStructure)throw new Error("Diagram data not defined");var o=0,n=!0,r=!1,a=void 0;try{for(var c,l=e[Symbol.iterator]();!(n=(c=l.next()).done);n=!0){var s=c.value;o+=this.blockHeight.get(s)}}catch(O){r=!0,a=O}finally{try{n||null==l.return||l.return()}finally{if(r)throw a}}o+=(e.length-1)*this.parameters.vMargin;var u=i.y-o/2,h=this.columnCenter.get(t);t>0?t+=1:t-=1;var d=!0,p=!1,m=void 0;try{for(var y,g=e[Symbol.iterator]();!(d=(y=g.next()).done);d=!0){var f=y.value,b=this.blockHeight.get(f),k={x:h,y:u+b/2};this.blockPosition.set(f,k);var v=this.diagramStructure.blockConnections.output.get(f).map((function(t){return t.to.blockUid}));this.updateChildPositions(t,v,k),u+=b+this.parameters.vMargin}}catch(O){p=!0,m=O}finally{try{d||null==g.return||g.return()}finally{if(p)throw m}}}},{key:"updateChildHeight",value:function(t){var e=this.diagramStructure.blocks.get(t),i=this.diagramStructure.blockConnections.output.get(t),o=0,n=!0,r=!1,a=void 0;try{for(var c,l=i[Symbol.iterator]();!(n=(c=l.next()).done);n=!0){var s=c.value;o+=this.updateChildHeight(s.to.blockUid)}}catch(h){r=!0,a=h}finally{try{n||null==l.return||l.return()}finally{if(r)throw a}}o+=this.parameters.vMargin*(i.length-1);var u=Math.max(o,e.rect.height);return this.blockHeight.set(t,u),u}},{key:"getBlockColumn",value:function(t){return this.blockColumns.get(t)}},{key:"getBlocks",value:function(t){var e=[],i=!0,o=!1,n=void 0;try{for(var r,a=this.diagramStructure.scene.diagramBlocks[Symbol.iterator]();!(i=(r=a.next()).done);i=!0){var c=r.value,l=c.rect;t.x>l.x&&t.x<l.x+l.width&&t.y>l.y&&t.y<l.y+l.height&&e.push(c)}}catch(s){o=!0,n=s}finally{try{i||null==a.return||a.return()}finally{if(o)throw n}}return e}},{key:"getChildIdx",value:function(t,e,i){var o=this;if(!this.diagramStructure)throw new Error("Diagram data not defined");var n=[],r=this.diagramStructure.blockConnections.output,a=!0,c=!1,l=void 0;try{for(var s,u=r.get(e)[Symbol.iterator]();!(a=(s=u.next()).done);a=!0){var h=s.value;n.push(h.to.blockUid)}}catch(w){c=!0,l=w}finally{try{a||null==u.return||u.return()}finally{if(c)throw l}}n=n.filter((function(e){return t!==e})),Ut.info("Found child uids ".concat(n));var d=n.map((function(t){return o.diagramStructure.blocks.get(t)})).map((function(t){return o.diagramStructure.scene.diagramBlocks.indexOf(t)})).sort((function(t,e){return t-e})),p=d.map((function(t){return[t,o.diagramStructure.scene.diagramBlocks[t].rect.y,o.diagramStructure.scene.diagramBlocks[t].rect.height]}));Ut.info((function(){return"getChildIdx block rects ".concat(p)}));var m=0,y=!0,g=!1,f=void 0;try{for(var b,k=d[Symbol.iterator]();!(y=(b=k.next()).done);y=!0){var v=b.value,O=this.diagramStructure.scene.diagramBlocks[v].rect;if(i<O.y+O.height/2)break;m++}}catch(w){g=!0,f=w}finally{try{y||null==k.return||k.return()}finally{if(g)throw f}}return[m,d]}},{key:"getColumnIdx",value:function(t){var e=Math.max.apply(Math,Object(w.a)(Array.from(this.columnWidth.keys()))),i=Math.min.apply(Math,Object(w.a)(Array.from(this.columnWidth.keys()))),o=-this.columnWidth.get(0)/2;if(t>=o){for(var n=0;n<=e;++n){if(t<(o+=this.columnWidth.get(n)))return n;o+=this.parameters.hMargin}return null}for(var r=-1;r>=i;--r){if(t>(o-=this.columnWidth.get(r)))return r;o-=this.parameters.hMargin}return null}}]),t}(),Xt=(gt=function(){function t(){var e=this,i=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],o=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];Object(j.a)(this,t),Object(S.a)(this,"diagramBlocks",ft,this),Object(S.a)(this,"diagramConnections",bt,this),Object(S.a)(this,"activeButtons",kt,this),Object(S.a)(this,"_editedBlock",vt,this),Object(S.a)(this,"_selectedBlock",Ot,this),Object(S.a)(this,"_previousSelection",wt,this),Object(S.a)(this,"onEdit",St,this),Object(S.a)(this,"structureChanging",jt,this),Object(S.a)(this,"sceneTranslate",Bt,this),Object(S.a)(this,"sceneTranslateDelta",xt,this),Object(S.a)(this,"image",Ct,this),this.diagramStructure=void 0,this.buttonLayout=new Lt,this.slotLayout=void 0,this.blockLayout=void 0,this.connectionLayout=void 0,this._previouseName="",this.oldEditedBlock=void 0,this.diagramBlocks=i,this.diagramConnections=o,this.diagramStructure=new Ht(this),this.slotLayout=new Jt(this.diagramStructure),this.blockLayout=new Kt(this.diagramStructure),this.connectionLayout=new At(this.diagramStructure),Object(W.i)((function(){var t=!1,i=!0,o=!1,n=void 0;try{for(var r,a=e.diagramBlocks[Symbol.iterator]();!(i=(r=a.next()).done);i=!0){var c=r.value;c.requestedWidth&&c.finishedEditing&&c.rect.width!=c.requestedWidth&&(c.rect.width=c.requestedWidth,t=!0)}}catch(l){o=!0,n=l}finally{try{i||null==a.return||a.return()}finally{if(o)throw n}}t&&e.layout()}),{name:"asd"})}return Object(B.a)(t,[{key:"setEditedBlock",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]&&arguments[1];this._editedBlock&&this._editedBlock.requestedWidth&&this._editedBlock.requestedWidth!=this._editedBlock.rect.width&&(this._editedBlock.finishedEditing=!0),void 0!==t&&(this._previouseName=t.name),e&&this._editedBlock&&(this._editedBlock.name=this._previouseName),this._editedBlock=t}},{key:"showBlockButtons",value:function(t,e){var i=this;this.buttonLayout.layoutBlockButtons(t,e),this.activeButtons=e;var o=!0,n=!1,r=void 0;try{for(var a,c=e[Symbol.iterator]();!(o=(a=c.next()).done);o=!0){a.value.on("click",(function(){i.activeButtons=[]}))}}catch(l){n=!0,r=l}finally{try{o||null==c.return||c.return()}finally{if(n)throw r}}}},{key:"layout",value:function(){this.diagramBlocks.length>0&&(this.slotLayout.layout(),this.blockLayout.layout(),this.connectionLayout.layout())}},{key:"up",value:function(){if(this.selectedBlock){var t=this.diagramStructure.getBlockColumnIdx(this.selectedBlock),e=this.diagramStructure.columnBlocks.get(t),i=e.indexOf(this.selectedBlock);i>0&&(this.selectedBlock=e[i-1])}}},{key:"down",value:function(){if(this.selectedBlock){var t=this.diagramStructure.getBlockColumnIdx(this.selectedBlock),e=this.diagramStructure.columnBlocks.get(t),i=e.indexOf(this.selectedBlock);i<e.length-1&&(this.selectedBlock=e[i+1])}}},{key:"left",value:function(){this.selectedBlock&&(1===this.diagramStructure.blockSide(this.selectedBlock)?this.selectParent():this.selectChild(-1))}},{key:"right",value:function(){this.selectedBlock&&(-1===this.diagramStructure.blockSide(this.selectedBlock)?this.selectParent():this.selectChild(1))}},{key:"edit",value:function(){this.selectedBlock&&this.setEditedBlock(this.selectedBlock)}},{key:"selectParent",value:function(){this.selectedBlock&&(this.selectedBlock=this.diagramStructure.getParentBlock(this.selectedBlock))}},{key:"selectChild",value:function(t){if(this.selectedBlock){var e=this.diagramStructure.getFistChildBlock(this.selectedBlock,t);e&&(this.selectedBlock=e)}}},{key:"editedBlock",get:function(){return this._editedBlock}},{key:"selectedBlock",get:function(){return this._selectedBlock},set:function(t){t!=this._selectedBlock&&(void 0==t?this._selectedBlock=this._previousSelection:(this._previousSelection=this._selectedBlock,this._selectedBlock=t),console.log("select block",t,this._previousSelection))}}]),t}(),ft=Object(P.a)(gt.prototype,"diagramBlocks",[W.y],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),bt=Object(P.a)(gt.prototype,"diagramConnections",[W.y],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),kt=Object(P.a)(gt.prototype,"activeButtons",[W.y],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),vt=Object(P.a)(gt.prototype,"_editedBlock",[W.y],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),Ot=Object(P.a)(gt.prototype,"_selectedBlock",[W.y],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),wt=Object(P.a)(gt.prototype,"_previousSelection",[W.y],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),St=Object(P.a)(gt.prototype,"onEdit",[W.y],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),jt=Object(P.a)(gt.prototype,"structureChanging",[W.y],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Bt=Object(P.a)(gt.prototype,"sceneTranslate",[W.y],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return{x:512,y:500}}}),xt=Object(P.a)(gt.prototype,"sceneTranslateDelta",[W.y],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return{x:0,y:0}}}),Ct=Object(P.a)(gt.prototype,"image",[W.y],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),Object(P.a)(gt.prototype,"editedBlock",[W.j],Object.getOwnPropertyDescriptor(gt.prototype,"editedBlock"),gt.prototype),Object(P.a)(gt.prototype,"selectedBlock",[W.j],Object.getOwnPropertyDescriptor(gt.prototype,"selectedBlock"),gt.prototype),Object(P.a)(gt.prototype,"layout",[W.h],Object.getOwnPropertyDescriptor(gt.prototype,"layout"),gt.prototype),Object(P.a)(gt.prototype,"up",[W.h],Object.getOwnPropertyDescriptor(gt.prototype,"up"),gt.prototype),Object(P.a)(gt.prototype,"down",[W.h],Object.getOwnPropertyDescriptor(gt.prototype,"down"),gt.prototype),Object(P.a)(gt.prototype,"left",[W.h],Object.getOwnPropertyDescriptor(gt.prototype,"left"),gt.prototype),Object(P.a)(gt.prototype,"right",[W.h],Object.getOwnPropertyDescriptor(gt.prototype,"right"),gt.prototype),Object(P.a)(gt.prototype,"edit",[W.h],Object.getOwnPropertyDescriptor(gt.prototype,"edit"),gt.prototype),gt),Yt=function(){function t(){Object(j.a)(this,t)}return Object(B.a)(t,null,[{key:"fromJSON",value:function(t){var e=new Xt,i=new Tt(q(),t.root.name,"mmroot",[new It("ol","o"),new It("or","o")],new I(0,0,200,30));return e.diagramBlocks.push(i),t.root.children&&t.root.children.left&&this.addChildBlocksFromJson(t.root.children.left,e,i,!0),t.root.children&&t.root.children.right&&this.addChildBlocksFromJson(t.root.children.right,e,i,!1),e}},{key:"addChildBlocksFromJson",value:function(t,e,i,o){var n=!0,r=!1,a=void 0;try{for(var c,l=t[Symbol.iterator]();!(n=(c=l.next()).done);n=!0){var s=c.value,u=new Tt(q(),s.name,"mm",[new It("i","i"),new It("o","o")],new I(0,0,100,30));e.diagramBlocks.push(u),"mmroot"==i.type?o?e.diagramConnections.push(new Ft({blockUid:i.uid,slot:"ol"},{blockUid:u.uid,slot:"i"},"mm")):e.diagramConnections.push(new Ft({blockUid:i.uid,slot:"or"},{blockUid:u.uid,slot:"i"},"mm")):e.diagramConnections.push(new Ft({blockUid:i.uid,slot:"o"},{blockUid:u.uid,slot:"i"},"mm")),s.children&&this.addChildBlocksFromJson(s.children,e,u)}}catch(h){r=!0,a=h}finally{try{n||null==l.return||l.return()}finally{if(r)throw a}}}},{key:"toJSON",value:function(t){var e=t.diagramBlocks[0],i={root:{name:e.name}},o=t.diagramStructure.getOutputSlotConnections(e.uid,"ol");o.length>0&&(i.root.children={left:this.addChildBlocksFromScene(o,t)});var n=t.diagramStructure.getOutputSlotConnections(e.uid,"or");return n.length>0&&(i.root.children?i.root.children.right=this.addChildBlocksFromScene(n,t):i.root.children={right:this.addChildBlocksFromScene(n,t)}),i}},{key:"addChildBlocksFromScene",value:function(t,e){var i=[],o=!0,n=!1,r=void 0;try{for(var a,c=t[Symbol.iterator]();!(o=(a=c.next()).done);o=!0){var l=a.value,s=e.diagramStructure.blocks.get(l.to.blockUid),u={name:s.name},h=e.diagramStructure.getOutputSlotConnections(s.uid,"o");h.length>0&&(u.children=this.addChildBlocksFromScene(h,e)),i.push(u)}}catch(d){n=!0,r=d}finally{try{o||null==c.return||c.return()}finally{if(n)throw r}}return i}}]),t}();function Vt(){var t=Object(M.a)(["\nwidth: 80%;\nheight: 60%;\nmargin-left: 7%;\nmargin-top:3px;\n"]);return Vt=function(){return t},t}function $t(){var t=Object(M.a)(["\n    position:absolute;\n    left :","px;\n    top : ","px;\n    width : ","px;\n    height : ","px;\n"]);return $t=function(){return t},t}var Gt,Qt,Zt,te=z.a.div($t(),(function(t){return t.rect.x}),(function(t){return t.rect.y}),(function(t){return t.rect.width}),(function(t){return t.rect.height})),ee=z.a.input(Vt()),ie=Object(U.a)(Et=function(t){function e(t){var i;return Object(j.a)(this,e),(i=Object(x.a)(this,Object(C.a)(e).call(this,t))).myRef=b.a.createRef(),i.focusOut=!1,i.handleBlur=function(t){t.currentTarget.contains(t.relatedTarget)||(i.props.block.name=t.target.value,i.focusOut=!0)},i}return Object(D.a)(e,t),Object(B.a)(e,[{key:"componentDidMount",value:function(){this.props.block.finishedEditing=!1,this.myRef.current&&(this.myRef.current.focus(),this.myRef.current.setSelectionRange(0,this.props.block.name.length))}},{key:"componentWillUnmount",value:function(){this.props.block.finishedEditing=!0}},{key:"render",value:function(){var t=this;return b.a.createElement(ee,{ref:this.myRef,type:"text",value:this.props.block.name,onFocus:function(e){t.focusOut=!1},onBlur:function(e){return t.handleBlur(e)},onChange:function(e){t.focusOut||(t.props.block.name=e.target.value)},onKeyDown:this.props.onKeyDown})}}]),e}(b.a.Component))||Et,oe=Object(U.a)((Pt=function(t){function e(){return Object(j.a)(this,e),Object(x.a)(this,Object(C.a)(e).apply(this,arguments))}return Object(D.a)(e,t),Object(B.a)(e,[{key:"render",value:function(){var t=this;if(this.props.scene.editedBlock){var e=I.copy(this.props.scene.editedBlock.rect);return e.x+=this.props.scene.sceneTranslate.x,e.y+=this.props.scene.sceneTranslate.y,b.a.createElement(te,{rect:e},b.a.createElement(ie,{block:this.props.scene.editedBlock,onKeyDown:function(e){return t.handleKeyDown(e)}}))}return null}},{key:"handleKeyDown",value:function(t){this.props.scene.editedBlock&&"Enter"===t.key&&(this.props.scene.setEditedBlock(void 0),this.props.scene.onEdit=!0,this.props.scene.activeButtons=[])}}]),e}(b.a.Component),Object(P.a)(Pt.prototype,"handleKeyDown",[W.h],Object.getOwnPropertyDescriptor(Pt.prototype,"handleKeyDown"),Pt.prototype),Dt=Pt))||Dt;function ne(){var t=Object(M.a)(["\n    position:absolute;\n    width : 100%;\n    height : 100%;\n"]);return ne=function(){return t},t}var re=z.a.div(ne()),ae=Object(U.a)((Qt=function(t){function e(t){var i;Object(j.a)(this,e),i=Object(x.a)(this,Object(C.a)(e).call(this,t)),Object(S.a)(i,"diagramScene",Zt,Object(E.a)(i)),i.addedBlock=void 0,i.vscode=void 0,i.vscode=i.props.vscode,i.diagramScene=i.props.scene;var o=new Tt(q(),"Enter diagram name","mmroot",[new It("ol","o"),new It("or","o")],new I(0,0,100,30));return i.diagramScene.diagramBlocks.push(o),i.addCallbacks(i.diagramScene.diagramBlocks),i.diagramScene.layout(),window.addEventListener("message",(function(t){var e=t.data;switch(e.command){case"setJsonDocument":Mt.info("setJsonDocument",e.document);var o=e.document;i.vscode.setState(o),i.diagramScene=Yt.fromJSON(o),i.diagramScene.layout(),i.addCallbacks(i.diagramScene.diagramBlocks);break;case"addChild":Mt.info("addChild message"),i.diagramScene.selectedBlock&&(i.diagramScene.editedBlock&&i.diagramScene.setEditedBlock(void 0),i.addBlock(i.diagramScene.selectedBlock));break;case"addSibling":Mt.info("addSibling message"),i.diagramScene.selectedBlock&&(i.diagramScene.editedBlock&&i.diagramScene.setEditedBlock(void 0),i.addSibling(i.diagramScene.selectedBlock));break;case"remove":Mt.info("removeBlock message"),i.diagramScene.selectedBlock&&(i.diagramScene.editedBlock&&i.diagramScene.setEditedBlock(void 0),i.removeBlock(i.diagramScene.selectedBlock));break;case"moveLeft":Mt.info("moveLeft message"),i.diagramScene.left();break;case"moveRight":Mt.info("moveRight message"),i.diagramScene.right();break;case"moveUp":Mt.info("moveUp message"),i.diagramScene.up();break;case"moveDown":Mt.info("moveDown message"),i.diagramScene.down();break;case"cancel":Mt.info("cancel message"),i.cancel();break;case"edit":Mt.info("edit message"),i.diagramScene.edit()}})),Object(W.i)((function(){if(i.diagramScene.onEdit&&!i.diagramScene.editedBlock){if(i.vscode){var t=Yt.toJSON(i.diagramScene);i.vscode.postMessage({message:"setDocument",document:t}),i.vscode.setState(t)}i.diagramScene.onEdit=!1,i.addedBlock=void 0}})),i}return Object(D.a)(e,t),Object(B.a)(e,[{key:"addCallbacks",value:function(t){var e=this,i=!0,o=!1,n=void 0;try{for(var r,a=t[Symbol.iterator]();!(i=(r=a.next()).done);i=!0){var c=r.value;c.on("click",(function(t){var i=new _t("addB","topRight","add","red",(function(){e.addBlock(t)})),o=new _t("removeB","topRight","remove","red",(function(){e.removeBlock(t)}));e.diagramScene.showBlockButtons(t,[i,o])})),c.on("dragEnd",(function(t,i){Mt.info("Block drag end '".concat(t.name,"' (").concat(i.x,",").concat(i.y,")")),e.endDragging(t,i),e.diagramScene.layout()})),c.on("doubleClick",(function(t){Mt.info("Block double click ".concat(t.uid)),e.diagramScene.setEditedBlock(t),e.diagramScene.activeButtons=[]}))}}catch(l){o=!0,n=l}finally{try{i||null==a.return||a.return()}finally{if(o)throw n}}}},{key:"componentDidMount",value:function(){this.vscode&&this.vscode.postMessage({message:"getDocument"})}},{key:"removeBlock",value:function(t){var e=this;if("mmroot"!==t.type){Mt.info("removeBlock ".concat(t.name));var i=this.diagramScene.diagramStructure.getChildBlocks(t.uid).map((function(t){return e.diagramScene.diagramStructure.blocks.get(t)}));i.push(t);var o=[],n=!0,r=!1,a=void 0;try{for(var c,l=i[Symbol.iterator]();!(n=(c=l.next()).done);n=!0){var s=c.value;o.push(this.diagramScene.diagramStructure.blockConnections.input.get(s.uid)[0])}}catch(O){r=!0,a=O}finally{try{n||null==l.return||l.return()}finally{if(r)throw a}}var u=!0,h=!1,d=void 0;try{for(var p,m=i[Symbol.iterator]();!(u=(p=m.next()).done);u=!0){var y=p.value,g=this.diagramScene.diagramBlocks.indexOf(y);this.diagramScene.diagramBlocks.splice(g,1)}}catch(O){h=!0,d=O}finally{try{u||null==m.return||m.return()}finally{if(h)throw d}}for(var f=0,b=o;f<b.length;f++){var k=b[f],v=this.diagramScene.diagramConnections.indexOf(k);this.diagramScene.diagramConnections.splice(v,1)}this.diagramScene.layout(),this.diagramScene.onEdit=!0,this.diagramScene.selectedBlock=void 0,this.diagramScene.activeButtons=[]}}},{key:"addSibling",value:function(t){if("mmroot"!=t.type){var e=this.diagramScene.diagramStructure.blockConnections.input.get(t.uid)[0].from.blockUid,i=this.diagramScene.diagramStructure.blocks.get(e);this.addBlock(i),this.diagramScene.activeButtons=[]}}},{key:"addBlock",value:function(t){Mt.info("addBlock (parent=".concat(t.name,")"));var e,i=new Tt(q(),"Unnamed element","mm",[new It("i","i"),new It("o","o")],new I(0,0,100,30));this.addCallbacks([i]),e="mmroot"===t.type?new Ft({blockUid:t.uid,slot:"or"},{blockUid:i.uid,slot:"i"},"mm"):new Ft({blockUid:t.uid,slot:"o"},{blockUid:i.uid,slot:"i"},"mm"),this.diagramScene.diagramBlocks.push(i),this.diagramScene.diagramConnections.push(e),this.diagramScene.layout(),this.diagramScene.setEditedBlock(i),this.diagramScene.selectedBlock=i,this.diagramScene.onEdit=!0,this.diagramScene.activeButtons=[],this.addedBlock=i}},{key:"cancel",value:function(){this.addedBlock?(this.removeBlock(this.addedBlock),this.addedBlock=void 0,this.diagramScene.setEditedBlock(void 0),this.diagramScene.selectedBlock=void 0):this.diagramScene.editedBlock&&this.diagramScene.setEditedBlock(void 0,!0)}},{key:"endDragging",value:function(t,e){var i=this;if(Mt.info("endDragging ".concat(t.name," : (").concat(e.x,", ").concat(e.y,")")),"mmroot"!==t.type){var o=this.diagramScene.blockLayout,n=this.diagramScene,r=n.diagramStructure,a=r.blockConnections.input.get(t.uid),c=r.blocks.get(a[0].from.blockUid),l=this.diagramScene.diagramStructure.getChildBlocks(t.uid).map((function(t){return i.diagramScene.diagramStructure.blocks.get(t)})),s=o.getBlocks(e);if(s=H.apply(void 0,[s,t].concat(Object(w.a)(l))),zt.info("found N occupied blocks ".concat(s.length)),s.length>0){var u,h=s[0],d=[t.uid].concat(r.getChildBlocks(t.uid)),p=d.map((function(t){return r.blocks.get(t)}));this.diagramScene.diagramConnections=H(n.diagramConnections,r.blockConnections.input.get(t.uid)[0]),this.diagramScene.diagramBlocks=H.apply(void 0,[this.diagramScene.diagramBlocks].concat(Object(w.a)(p)));var m=n.diagramBlocks.indexOf(h);(u=n.diagramBlocks).splice.apply(u,[m+1,0].concat(Object(w.a)(p))),"mmroot"===h.type?e.x>0?n.diagramConnections.push(new Ft({blockUid:h.uid,slot:"or"},{blockUid:d[0],slot:"i"},"mm")):n.diagramConnections.push(new Ft({blockUid:h.uid,slot:"ol"},{blockUid:d[0],slot:"i"},"mm")):n.diagramConnections.push(new Ft({blockUid:h.uid,slot:"o"},{blockUid:d[0],slot:"i"},"mm")),n.layout(),this.diagramScene.onEdit=!0}else{"mmroot"===c.type&&(e.x>0?a[0].from.slot="or":a[0].from.slot="ol");var y=a[0],g=o.getChildIdx(t.uid,y.from.blockUid,e.y),f=Object(O.a)(g,2),b=f[0],k=f[1];if(zt.info("Child idx ".concat(k,"[").concat(b,"]")),k.length>0){var v=-1,S=null;b===k.length||(v=k[b],S=n.diagramBlocks[v]);var j=[t.uid].concat(r.getChildBlocks(t.uid)).map((function(t){return r.blocks.get(t)}));if(n.diagramBlocks=H.apply(void 0,[n.diagramBlocks].concat(Object(w.a)(j))),S){var B,x=n.diagramStructure.blockConnections.input.get(S.uid)[0],C=n.diagramConnections.indexOf(x),E=this.diagramScene.diagramConnections.indexOf(y);this.diagramScene.diagramConnections.splice(E,1),this.diagramScene.diagramConnections.splice(C-1,0,y);var D=n.diagramBlocks.indexOf(S);(B=n.diagramBlocks).splice.apply(B,[D,0].concat(Object(w.a)(j)))}else{var P;(P=n.diagramBlocks).push.apply(P,Object(w.a)(j));var M=this.diagramScene.diagramConnections.indexOf(y);this.diagramScene.diagramConnections.splice(M,1),this.diagramScene.diagramConnections.push(y)}}n.layout(),this.diagramScene.onEdit=!0}}}},{key:"render",value:function(){var t=this;return b.a.createElement("div",null,!this.props.vscode&&b.a.createElement("div",null,b.a.createElement("button",{onClick:function(e){return t.diagramScene.up()}},"up"),b.a.createElement("button",{onClick:function(e){return t.diagramScene.down()}},"down"),b.a.createElement("button",{onClick:function(e){return t.diagramScene.left()}},"left"),b.a.createElement("button",{onClick:function(e){return t.diagramScene.right()}},"right"),b.a.createElement("button",{onClick:function(e){return t.cancel()}},"cancel"),b.a.createElement("button",{onClick:function(e){return t.diagramScene.edit()}},"edit")),b.a.createElement(re,null,b.a.createElement(oe,{scene:this.diagramScene}),b.a.createElement(Wt,{diagramScene:this.diagramScene})))}}]),e}(b.a.Component),Zt=Object(P.a)(Qt.prototype,"diagramScene",[W.y],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),Object(P.a)(Qt.prototype,"removeBlock",[W.h],Object.getOwnPropertyDescriptor(Qt.prototype,"removeBlock"),Qt.prototype),Object(P.a)(Qt.prototype,"addSibling",[W.h],Object.getOwnPropertyDescriptor(Qt.prototype,"addSibling"),Qt.prototype),Object(P.a)(Qt.prototype,"addBlock",[W.h],Object.getOwnPropertyDescriptor(Qt.prototype,"addBlock"),Qt.prototype),Object(P.a)(Qt.prototype,"cancel",[W.h],Object.getOwnPropertyDescriptor(Qt.prototype,"cancel"),Qt.prototype),Object(P.a)(Qt.prototype,"endDragging",[W.h],Object.getOwnPropertyDescriptor(Qt.prototype,"endDragging"),Qt.prototype),Gt=Qt))||Gt,ce=function t(e){Object(j.a)(this,t),this.image=void 0,this.image=e},le=function(){var t=new Xt;if("undefined"!==typeof acquireVsCodeApi){var e=acquireVsCodeApi(),i=e.getState();return b.a.createElement("div",null,b.a.createElement(ae,{scene:t,jsonDiagram:i,vscode:e}))}return b.a.createElement("div",null,b.a.createElement("input",{type:"file",name:"picField",id:"picField",onChange:function(e){!function(e){if(e.target.files&&e.target.files.length>0){var i=new FileReader;i.onload=function(){var e=new ce(i.result);t.diagramBlocks[0].image=e},i.readAsDataURL(e.target.files[0])}}(e)}}),b.a.createElement(ae,{scene:t}))};Boolean("localhost"===window.location.hostname||"[::1]"===window.location.hostname||window.location.hostname.match(/^127(?:\.(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)){3}$/));v.a.render(b.a.createElement(le,null),document.getElementById("root")),"serviceWorker"in navigator&&navigator.serviceWorker.ready.then((function(t){t.unregister()}))}},[[50,1,2]]]);
//# sourceMappingURL=main.d4716741.chunk.js.map