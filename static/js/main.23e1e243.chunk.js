(this.webpackJsonpdiagexp1=this.webpackJsonpdiagexp1||[]).push([[0],{51:function(e,t,o){e.exports=o(83)},56:function(e,t,o){},57:function(e,t,o){},83:function(e,t,o){"use strict";o.r(t);var r,i,n,a,c,l,s=o(1),u=o.n(s),d=o(18),h=o.n(d),f=(o(56),o(57),o(12)),y=o(16),p=o(30),m=o(5),g=o(3),b=o(4),k=o(7),v=o(6),O=o(9),S=o(8),w=o(2),j=(o(14),o(19)),B=o(20),x=o(11),C=Object(x.a)(r=function(e){function t(){return Object(g.a)(this,t),Object(k.a)(this,Object(v.a)(t).apply(this,arguments))}return Object(S.a)(t,e),Object(b.a)(t,[{key:"render",value:function(){var e=this;return u.a.createElement("g",{transform:"translate(".concat(this.props.slot.position.x,",").concat(this.props.slot.position.y,") rotate(0)"),onClick:function(t){return e.onClick(t)}},u.a.createElement("circle",{r:"3",fill:"gray"}))}},{key:"onClick",value:function(e){}}]),t}(u.a.Component))||r,E=o(0),D=(i=function(){function e(t,o,r,i){Object(g.a)(this,e),Object(m.a)(this,"x",n,this),Object(m.a)(this,"y",a,this),Object(m.a)(this,"width",c,this),Object(m.a)(this,"height",l,this),this.x=t,this.y=o,this.width=r,this.height=i}return Object(b.a)(e,[{key:"contains",value:function(e){return!(e.x<this.x||e.x>this.x+this.width||e.y<this.y||e.y>this.y+this.height)}}],[{key:"copy",value:function(t){return new e(t.x,t.y,t.width,t.height)}}]),e}(),n=Object(w.a)(i.prototype,"x",[E.y],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),a=Object(w.a)(i.prototype,"y",[E.y],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),c=Object(w.a)(i.prototype,"width",[E.y],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),l=Object(w.a)(i.prototype,"height",[E.y],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),i),P=function(){function e(){Object(g.a)(this,e),this.map=new Map}return Object(b.a)(e,[{key:"push",value:function(e,t){var o=this.map.get(e)||[];o.push(t),this.map.set(e,o)}},{key:"get",value:function(e){return this.map.get(e)||[]}},{key:"empty",value:function(e){return 0===this.get(e).length}},{key:"keys",value:function(){return this.map.keys()}}]),e}();function z(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(e){var t=16*Math.random()|0;return("x"===e?t:3&t|8).toString(16)}))}function R(e){for(var t=arguments.length,o=new Array(t>1?t-1:0),r=1;r<t;r++)o[r-1]=arguments[r];for(var i=0,n=o;i<n.length;i++){var a=n[i],c=e.indexOf(a);-1!==c&&e.splice(c,1)}return e}function M(e,t){var o=e;return t&&(o={x:e.x-t.x,y:e.y-t.y}),Math.sqrt(o.x*o.x+o.y*o.y)}function U(e){var t=new Map(Object.entries({aliceblue:"#f0f8ff",antiquewhite:"#faebd7",aqua:"#00ffff",aquamarine:"#7fffd4",azure:"#f0ffff",beige:"#f5f5dc",bisque:"#ffe4c4",black:"#000000",blanchedalmond:"#ffebcd",blue:"#0000ff",blueviolet:"#8a2be2",brown:"#a52a2a",burlywood:"#deb887",cadetblue:"#5f9ea0",chartreuse:"#7fff00",chocolate:"#d2691e",coral:"#ff7f50",cornflowerblue:"#6495ed",cornsilk:"#fff8dc",crimson:"#dc143c",cyan:"#00ffff",darkblue:"#00008b",darkcyan:"#008b8b",darkgoldenrod:"#b8860b",darkgray:"#a9a9a9",darkgreen:"#006400",darkkhaki:"#bdb76b",darkmagenta:"#8b008b",darkolivegreen:"#556b2f",darkorange:"#ff8c00",darkorchid:"#9932cc",darkred:"#8b0000",darksalmon:"#e9967a",darkseagreen:"#8fbc8f",darkslateblue:"#483d8b",darkslategray:"#2f4f4f",darkturquoise:"#00ced1",darkviolet:"#9400d3",deeppink:"#ff1493",deepskyblue:"#00bfff",dimgray:"#696969",dodgerblue:"#1e90ff",firebrick:"#b22222",floralwhite:"#fffaf0",forestgreen:"#228b22",fuchsia:"#ff00ff",gainsboro:"#dcdcdc",ghostwhite:"#f8f8ff",gold:"#ffd700",goldenrod:"#daa520",gray:"#808080",green:"#008000",greenyellow:"#adff2f",honeydew:"#f0fff0",hotpink:"#ff69b4","indianred ":"#cd5c5c",indigo:"#4b0082",ivory:"#fffff0",khaki:"#f0e68c",lavender:"#e6e6fa",lavenderblush:"#fff0f5",lawngreen:"#7cfc00",lemonchiffon:"#fffacd",lightblue:"#add8e6",lightcoral:"#f08080",lightcyan:"#e0ffff",lightgoldenrodyellow:"#fafad2",lightgrey:"#d3d3d3",lightgreen:"#90ee90",lightpink:"#ffb6c1",lightsalmon:"#ffa07a",lightseagreen:"#20b2aa",lightskyblue:"#87cefa",lightslategray:"#778899",lightsteelblue:"#b0c4de",lightyellow:"#ffffe0",lime:"#00ff00",limegreen:"#32cd32",linen:"#faf0e6",magenta:"#ff00ff",maroon:"#800000",mediumaquamarine:"#66cdaa",mediumblue:"#0000cd",mediumorchid:"#ba55d3",mediumpurple:"#9370d8",mediumseagreen:"#3cb371",mediumslateblue:"#7b68ee",mediumspringgreen:"#00fa9a",mediumturquoise:"#48d1cc",mediumvioletred:"#c71585",midnightblue:"#191970",mintcream:"#f5fffa",mistyrose:"#ffe4e1",moccasin:"#ffe4b5",navajowhite:"#ffdead",navy:"#000080",oldlace:"#fdf5e6",olive:"#808000",olivedrab:"#6b8e23",orange:"#ffa500",orangered:"#ff4500",orchid:"#da70d6",palegoldenrod:"#eee8aa",palegreen:"#98fb98",paleturquoise:"#afeeee",palevioletred:"#d87093",papayawhip:"#ffefd5",peachpuff:"#ffdab9",peru:"#cd853f",pink:"#ffc0cb",plum:"#dda0dd",powderblue:"#b0e0e6",purple:"#800080",rebeccapurple:"#663399",red:"#ff0000",rosybrown:"#bc8f8f",royalblue:"#4169e1",saddlebrown:"#8b4513",salmon:"#fa8072",sandybrown:"#f4a460",seagreen:"#2e8b57",seashell:"#fff5ee",sienna:"#a0522d",silver:"#c0c0c0",skyblue:"#87ceeb",slateblue:"#6a5acd",slategray:"#708090",snow:"#fffafa",springgreen:"#00ff7f",steelblue:"#4682b4",tan:"#d2b48c",teal:"#008080",thistle:"#d8bfd8",tomato:"#ff6347",turquoise:"#40e0d0",violet:"#ee82ee",wheat:"#f5deb3",white:"#ffffff",whitesmoke:"#f5f5f5",yellow:"#ffff00",yellowgreen:"#9acd32"}));return t.has(e)?t.get(e):e}function W(e,t){var o=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),o.push.apply(o,r)}return o}var q,T,_,F,I,A,H,L,J,K,N,X={fontSize:24,fontColor:"red",backgroundColor:"green",margin:{top:5,bottom:5,left:5,right:5},borderRepeat:1,rx:5,strokeColor:"#00HH00",strokeWidth:1};function Y(e){q=e,X=function(e){for(var t=1;t<arguments.length;t++){var o=null!=arguments[t]?arguments[t]:{};t%2?W(o,!0).forEach((function(t){Object(y.a)(e,t,o[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(o)):W(o).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(o,t))}))}return e}({},X,{},e)}var V,Z=Object(x.a)(T=function(e){function t(){var e,o;Object(g.a)(this,t);for(var r=arguments.length,i=new Array(r),n=0;n<r;n++)i[n]=arguments[n];return(o=Object(k.a)(this,(e=Object(v.a)(t)).call.apply(e,[this].concat(i)))).myRef=u.a.createRef(),o}return Object(S.a)(t,e),Object(b.a)(t,[{key:"componentDidMount",value:function(){if(this.myRef.current){var e=this.myRef.current.getBoundingClientRect();this.props.onSize({x:e.width,y:e.height})}}},{key:"componentDidUpdate",value:function(){if(this.myRef.current){var e=this.myRef.current.getBoundingClientRect();this.props.onSize({x:e.width,y:e.height})}}},{key:"render",value:function(){return this.props.block.image?u.a.createElement("image",{width:"100",ref:this.myRef,xlinkHref:this.props.block.image.image}):null}}]),t}(u.a.Component))||T,$=Object(x.a)(_=function(e){function t(e){var o;return Object(g.a)(this,t),(o=Object(k.a)(this,Object(v.a)(t).call(this,e))).size={x:0,y:0},o.myRef=u.a.createRef(),o}return Object(S.a)(t,e),Object(b.a)(t,[{key:"componentDidMount",value:function(){this.myRef.current&&(this.size={x:this.myRef.current.getBBox().width,y:this.myRef.current.getBBox().height},this.props.onSize(this.size))}},{key:"componentDidUpdate",value:function(){if(this.myRef.current){var e={x:this.myRef.current.getBBox().width,y:this.myRef.current.getBBox().height};M(this.size,e)>1&&(console.log("Component did update ".concat(this.size.x," ").concat(e.x," ").concat(this.size.y," ").concat(e.y)),this.props.onSize(e)),this.size=e}}},{key:"render",value:function(){var e=this.props.block.rect.height,t=this.props.style.margin||X.margin,o=e-t.top-t.bottom,r=t.top+o/2;return u.a.createElement("text",{fill:this.props.style.fontColor||X.fontColor,fontSize:this.props.style.fontSize||X.fontSize,ref:this.myRef,style:{pointerEvents:"none",userSelect:"none"},x:this.props.block.rect.width/2,y:r,dominantBaseline:"middle",textAnchor:"middle"},this.props.block.name)}}]),t}(u.a.Component))||_,G=(Object(x.a)((I=function(e){function t(){var e,o;Object(g.a)(this,t);for(var r=arguments.length,i=new Array(r),n=0;n<r;n++)i[n]=arguments[n];return o=Object(k.a)(this,(e=Object(v.a)(t)).call.apply(e,[this].concat(i))),Object(m.a)(o,"scale",A,Object(O.a)(o)),Object(m.a)(o,"translate",H,Object(O.a)(o)),o.myRef=u.a.createRef(),o}return Object(S.a)(t,e),Object(b.a)(t,[{key:"componentDidMount",value:function(){if(this.myRef&&this.myRef.current){var e=this.myRef.current.getBBox();console.log("bbox",e),this.translate.x=-e.x,this.translate.y=-e.y,this.scale=Math.min(20/e.width,20/e.height)}}},{key:"render",value:function(){return u.a.createElement("g",{ref:this.myRef,transform:" scale(".concat(this.scale,", ").concat(this.scale,") translate(").concat(this.translate.x,",").concat(this.translate.y,")")},u.a.createElement("path",{d:"m 58.39732,66.245535 11.150298,6.047618 4.157739,-9.827379 4.91369,10.394345 13.796132,-1.889882 -11.528274,10.772322 6.425595,13.229167 c -4.787698,-1.448909 -7.11725,-7.433098 -12.473214,-6.803571 -5.177375,0.413433 -7.942629,5.656018 -11.150298,8.504464 L 65.956845,84.955357 52.160714,81.742559 64.633929,77.395833 Z",style:{fill:"none",stroke:"#000000"}}))}}]),t}(u.a.Component),A=Object(w.a)(I.prototype,"scale",[E.y],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),H=Object(w.a)(I.prototype,"translate",[E.y],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return{x:0,y:0}}}),F=I)),Object(x.a)((J=function(e){function t(e){var o;return Object(g.a)(this,t),(o=Object(k.a)(this,Object(v.a)(t).call(this,e))).dispose=void 0,Object(m.a)(o,"imageSize",K,Object(O.a)(o)),Object(m.a)(o,"textSize",N,Object(O.a)(o)),o.onTextSize=function(e){o.textSize=e,o.updateRequestedSize()},o.onImageSize=function(e){o.imageSize=e,o.updateRequestedSize()},o}return Object(S.a)(t,e),Object(b.a)(t,[{key:"renderFrame",value:function(){for(var e=this.props.block.style,t=[],o=0;o<(e.borderRepeat||X.borderRepeat);++o)t.push(u.a.createElement("rect",{x:5*o,y:5*o,width:this.props.block.rect.width-10*o,height:this.props.block.rect.height-10*o,strokeWidth:e.strokeWidth||X.strokeWidth,fill:e.backgroundColor||X.backgroundColor,style:{stroke:e.strokeColor||X.strokeColor},rx:e.rx||X.rx}));return u.a.createElement(u.a.Fragment,null,t,this.props.isSelected&&u.a.createElement("rect",{x:-3,y:-3,width:this.props.block.rect.width+6,height:this.props.block.rect.height+6,fill:"none",style:{stroke:"#0000FF",strokeWidth:2},rx:5}),this.props.isHovered&&u.a.createElement("rect",{x:-3,y:-3,width:this.props.block.rect.width+6,height:this.props.block.rect.height+6,fill:"none",style:{stroke:"#00FF00",strokeWidth:2},rx:5}))}},{key:"render",value:function(){var e=this;return this.dispose&&this.dispose(),this.dispose=Object(E.i)((function(){return e.updateRequestedSize()})),u.a.createElement("g",{transform:"translate(".concat(this.props.block.rect.x+this.props.block.translate.x,",").concat(this.props.block.rect.y+this.props.block.translate.y,") "),onMouseDown:function(t){return e.onMouseDown(t)},onClick:function(t){return e.onClick(t)},onDoubleClick:function(t){return e.onDoubleClick(t)}},this.renderFrame(),this.props.isEdited?null:u.a.createElement($,{block:this.props.block,style:this.props.block.style,onSize:this.onTextSize}),"s",u.a.createElement(Z,{block:this.props.block,onSize:this.onImageSize}),this.props.block.slots.map((function(e){return u.a.createElement(C,{key:e.key,slot:e})})))}},{key:"componentWillMount",value:function(){this.dispose&&this.dispose()}},{key:"updateRequestedSize",value:function(){var e=this.props.block.style.margin||X.margin;this.props.block.requestedWidth=this.textSize.x+e.left+e.right,this.props.block.requestedHeight=this.textSize.y+e.top+e.bottom}},{key:"onMouseDown",value:function(e){this.props.onSelect(this.props.block,{x:e.clientX,y:e.clientY}),e.stopPropagation()}},{key:"onClick",value:function(e){this.props.block.click(),e.stopPropagation()}},{key:"onDoubleClick",value:function(e){this.props.block.doubleClick()}},{key:"fullSize",get:function(){return this.textSize}}]),t}(u.a.Component),K=Object(w.a)(J.prototype,"imageSize",[E.y],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return{x:0,y:0}}}),N=Object(w.a)(J.prototype,"textSize",[E.y],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return{x:80,y:20}}}),Object(w.a)(J.prototype,"updateRequestedSize",[E.h],Object.getOwnPropertyDescriptor(J.prototype,"updateRequestedSize"),J.prototype),Object(w.a)(J.prototype,"fullSize",[E.j],Object.getOwnPropertyDescriptor(J.prototype,"fullSize"),J.prototype),L=J))||L),Q=function(e){function t(){return Object(g.a)(this,t),Object(k.a)(this,Object(v.a)(t).apply(this,arguments))}return Object(S.a)(t,e),Object(b.a)(t,[{key:"render",value:function(){return u.a.createElement("g",null,u.a.createElement("g",{id:"g3979",transform:"translate(-0.10620686,-0.56696429)"},u.a.createElement("rect",{ry:"1.0444876",y:"-9.3742828",x:"-9.8492556",height:"19.63636",width:"19.425177",id:"rect3942",style:{fill:"white",stroke:"#000000",strokeWidth:"1"}}),u.a.createElement("path",{id:"rect3944",d:"m -3.3174074,-7.0890472 c -0.5786464,0 -1.0443792,0.4657354 -1.0443792,1.0443818 v 2.1626565 h -2.1626592 c -0.5786464,0 -1.0443818,0.4657355 -1.0443818,1.0443819 v 6.7313729 c 0,0.5786438 0.4657354,1.0443792 1.0443818,1.0443792 h 2.1626592 v 2.1626592 c 0,0.5786464 0.4657328,1.0443792 1.0443792,1.0443792 h 6.7313729 c 0.5786464,0 1.0443819,-0.4657328 1.0443819,-1.0443792 V 4.9381251 h 2.1626565 c 0.5786464,0 1.0443818,-0.4657354 1.0443818,-1.0443792 V -2.837627 c 0,-0.5786464 -0.4657354,-1.0443819 -1.0443818,-1.0443819 H 4.4583474 v -2.1626565 c 0,-0.5786464 -0.4657355,-1.0443818 -1.0443819,-1.0443818 z",style:{fill:"purple",stroke:"#000000",strokeWidth:"1"}})))}}]),t}(u.a.Component),ee=function(e){function t(){return Object(g.a)(this,t),Object(k.a)(this,Object(v.a)(t).apply(this,arguments))}return Object(S.a)(t,e),Object(b.a)(t,[{key:"render",value:function(){return u.a.createElement("g",null,u.a.createElement("g",{id:"g3979",transform:"translate(-0.10620686,-0.56696429)"},u.a.createElement("rect",{ry:"1.0444876",y:"-9.3742828",x:"-9.8492556",height:"19.63636",width:"19.425177",id:"rect3942",style:{fill:"white",stroke:"#000000",strokeWidth:"1"}}),u.a.createElement("rect",{style:{fill:"white",stroke:"#000000",strokeWidth:"1"},id:"rect4021",width:"15.485204",height:"8.2242823",x:"-7.7426019",y:"-4.1617403",ry:"0.98811853"})))}}]),t}(u.a.Component),te=function(e){function t(){return Object(g.a)(this,t),Object(k.a)(this,Object(v.a)(t).apply(this,arguments))}return Object(S.a)(t,e),Object(b.a)(t,[{key:"render",value:function(){var e=this,t=u.a.createElement("rect",{width:10,height:10,fill:this.props.button.color});switch(this.props.button.icon){case"add":t=u.a.createElement(Q,null);break;case"remove":t=u.a.createElement(ee,null)}return u.a.createElement("g",{transform:"translate(".concat(this.props.button.position.x,",").concat(this.props.button.position.y,") rotate(0)"),onClick:function(t){return e.onClick(t)}},t)}},{key:"onClick",value:function(e){this.props.button.click()}}]),t}(u.a.Component),oe=Object(x.a)(V=function(e){function t(){return Object(g.a)(this,t),Object(k.a)(this,Object(v.a)(t).apply(this,arguments))}return Object(S.a)(t,e),Object(b.a)(t,[{key:"render",value:function(){var e=this.props.connection.fromPoint.x,t=this.props.connection.fromPoint.y,o=this.props.connection.toPoint.x,r=this.props.connection.toPoint.y;return u.a.createElement("path",{style:{stroke:"rgb(255,0,0)",strokeWidth:"2",fill:"none"},d:"M ".concat(e," ").concat(t," C ").concat(o," ").concat(t," ").concat(e," ").concat(r," ").concat(o," ").concat(r)})}}]),t}(u.a.Component))||V,re=o(15);re.CategoryServiceFactory.setDefaultConfiguration(new re.CategoryConfiguration(re.LogLevel.Info));var ie,ne,ae,ce,le,se,ue,de,he,fe,ye,pe,me,ge,be,ke,ve,Oe,Se,we,je,Be,xe,Ce,Ee,De,Pe,ze,Re,Me,Ue,We,qe,Te,_e=new re.Category("mindMap"),Fe=new re.Category("draging",_e),Ie=new re.Category("diagramBlockLayout",_e),Ae=new re.Category("DiagramSceneComponent"),He=Object(x.a)((ne=function(e){function t(){var e,o;Object(g.a)(this,t);for(var r=arguments.length,i=new Array(r),n=0;n<r;n++)i[n]=arguments[n];return(o=Object(k.a)(this,(e=Object(v.a)(t)).call.apply(e,[this].concat(i)))).x0=0,o.y0=0,o.mouseDownPos=void 0,o.selectionBlock=void 0,Object(m.a)(o,"hoverBlock",ae,Object(O.a)(o)),o.myRef=u.a.createRef(),o}return Object(S.a)(t,e),Object(b.a)(t,[{key:"componentDidMount",value:function(){if(this.myRef.current){var e=this.myRef.current.getBoundingClientRect().width/2,t=this.myRef.current.getBoundingClientRect().height/2;this.props.diagramScene.sceneTranslate.x=e,this.props.diagramScene.sceneTranslate.y=t,this.x0=this.myRef.current.getBoundingClientRect().left,this.y0=this.myRef.current.getBoundingClientRect().top}}},{key:"render",value:function(){var e=this,t=this.props.diagramScene.sceneTranslate.x+this.props.diagramScene.sceneTranslateDelta.x,o=this.props.diagramScene.sceneTranslate.y+this.props.diagramScene.sceneTranslateDelta.y;return u.a.createElement("svg",{ref:this.myRef,width:"100%",height:"100%",xmlns:"http://www.w3.org/2000/svg",xmlnsXlink:"http://www.w3.org/1999/xlink",onMouseDown:function(t){return e.onMouseDown(t)},onMouseMove:function(t){return e.onMouseMove(t)},onMouseUp:function(t){return e.onMouseUp(t)},onClick:function(t){return e.onClick(t)}},u.a.createElement("g",{transform:"translate(".concat(t,",").concat(o,")")},this.props.diagramScene.diagramBlocks.map((function(t){return u.a.createElement(G,{key:t.uid,block:t,isSelected:e.props.diagramScene.selectedBlock===t,isHovered:e.hoverBlock===t,isEdited:e.props.diagramScene.editedBlock===t,onSelect:function(t,o){return e.onSelect(t,o)}})})),this.props.diagramScene.diagramConnections.map((function(e){return u.a.createElement(oe,{key:e.uid,connection:e})})),this.props.diagramScene.activeButtons.map((function(e){return u.a.createElement(te,{key:e.uid,button:e})}))))}},{key:"onSelect",value:function(e,t){this.mouseDownPos=this.clientToScene(t),this.selectionBlock=e,this.props.diagramScene.selectedBlock=e,this.props.diagramScene.setEditedBlock(void 0)}},{key:"onMouseDown",value:function(e){Ae.info("onMouseDown"),this.props.diagramScene.editedBlock&&(this.props.diagramScene.setEditedBlock(void 0),this.props.diagramScene.onEdit=!0),this.mouseDownPos=this.clientToScene({x:e.pageX,y:e.pageY})}},{key:"onMouseMove",value:function(e){if(this.mouseDownPos&&this.selectionBlock){Ae.info("onMouseMove block");var t=this.clientToScene({x:e.pageX,y:e.pageY});this.selectionBlock.translate={x:t.x-this.mouseDownPos.x,y:t.y-this.mouseDownPos.y},this.props.diagramScene.activeButtons=[],this.hoverBlock=void 0;var o=!0,r=!1,i=void 0;try{for(var n,a=this.props.diagramScene.diagramBlocks[Symbol.iterator]();!(o=(n=a.next()).done);o=!0){var c=n.value;if(c!=this.selectionBlock)c.rect.contains(t)&&(this.hoverBlock=c)}}catch(d){r=!0,i=d}finally{try{o||null==a.return||a.return()}finally{if(r)throw i}}}else if(this.mouseDownPos){Ae.info("onMouseMove scene");var l=this.clientToScene({x:e.pageX,y:e.pageY}),s=l.x-this.mouseDownPos.x,u=l.y-this.mouseDownPos.y;M({x:s,y:u})>40&&(this.props.diagramScene.sceneTranslateDelta={x:s,y:u})}}},{key:"onMouseUp",value:function(e){if(Ae.info("onMouseUp"),this.hoverBlock=void 0,this.selectionBlock&&this.mouseDownPos){var t=this.clientToScene({x:e.pageX,y:e.pageY});if(M({x:t.x-this.mouseDownPos.x,y:t.y-this.mouseDownPos.y})>20){var o={x:this.selectionBlock.rect.x+t.x-this.mouseDownPos.x,y:this.selectionBlock.rect.y+t.y-this.mouseDownPos.y};this.selectionBlock.setPosition(o),this.selectionBlock.dragEnd(t)}else this.selectionBlock.translate={x:0,y:0};this.selectionBlock=void 0,this.mouseDownPos=void 0}else if(this.mouseDownPos){var r=this.clientToScene({x:e.pageX,y:e.pageY}),i=r.x-this.mouseDownPos.x,n=r.y-this.mouseDownPos.y;M({x:i,y:n})>40&&(this.props.diagramScene.sceneTranslate.x+=i,this.props.diagramScene.sceneTranslate.y+=n),this.props.diagramScene.sceneTranslateDelta={x:0,y:0},this.mouseDownPos=void 0}}},{key:"clientToScene",value:function(e){return{x:e.x-this.props.diagramScene.sceneTranslate.x-this.x0,y:e.y-this.props.diagramScene.sceneTranslate.y-this.y0}}},{key:"onClick",value:function(e){this.props.diagramScene.activeButtons=[]}}]),t}(u.a.Component),ae=Object(w.a)(ne.prototype,"hoverBlock",[E.y],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),Object(w.a)(ne.prototype,"onMouseDown",[E.h],Object.getOwnPropertyDescriptor(ne.prototype,"onMouseDown"),ne.prototype),Object(w.a)(ne.prototype,"onMouseUp",[E.h],Object.getOwnPropertyDescriptor(ne.prototype,"onMouseUp"),ne.prototype),ie=ne))||ie,Le=(ce=function(e){function t(e,o,r,i,n,a,c){var l;return Object(g.a)(this,t),(l=Object(k.a)(this,Object(v.a)(t).call(this))).uid=void 0,Object(m.a)(l,"name",le,Object(O.a)(l)),l.type=void 0,Object(m.a)(l,"rect",se,Object(O.a)(l)),Object(m.a)(l,"translate",ue,Object(O.a)(l)),Object(m.a)(l,"slots",de,Object(O.a)(l)),Object(m.a)(l,"debugIdx",he,Object(O.a)(l)),Object(m.a)(l,"finishedEditing",fe,Object(O.a)(l)),Object(m.a)(l,"requestedWidth",ye,Object(O.a)(l)),Object(m.a)(l,"requestedHeight",pe,Object(O.a)(l)),Object(m.a)(l,"image",me,Object(O.a)(l)),Object(m.a)(l,"imageUrl",ge,Object(O.a)(l)),Object(m.a)(l,"style",be,Object(O.a)(l)),l.uid=e,l.name=o,l.type=r,l.slots=i,l.rect=n,l.debugIdx=0,l.translate={x:0,y:0},l.image=c,l.style=a||{},l}return Object(S.a)(t,e),Object(b.a)(t,[{key:"setPosition",value:function(e){this.translate={x:0,y:0},this.rect.x=e.x,this.rect.y=e.y,this.fireChangeRect(this)}},{key:"click",value:function(){this.fireClick(this)}},{key:"doubleClick",value:function(){this.fireDoubleClick(this)}},{key:"dragEnd",value:function(e){this.fireDragEnd(this,e)}},{key:"name2slot",get:function(){var e=new Map,t=!0,o=!1,r=void 0;try{for(var i,n=this.slots[Symbol.iterator]();!(t=(i=n.next()).done);t=!0){var a=i.value;e.set(a.name,a)}}catch(c){o=!0,r=c}finally{try{t||null==n.return||n.return()}finally{if(o)throw r}}return e}}]),t}(function(){function e(){Object(g.a)(this,e),this.clickCallbacks=[],this.doubleClickCallbacks=[],this.changeRectCallbacks=[],this.dragEndCallbacks=[]}return Object(b.a)(e,[{key:"on",value:function(e,t){switch(e){case"click":this.clickCallbacks.push(t);break;case"doubleClick":this.doubleClickCallbacks.push(t);break;case"changeRect":this.changeRectCallbacks.push(t);break;case"dragEnd":this.dragEndCallbacks.push(t)}}},{key:"fireClick",value:function(e){var t=!0,o=!1,r=void 0;try{for(var i,n=this.clickCallbacks[Symbol.iterator]();!(t=(i=n.next()).done);t=!0){(0,i.value)(e)}}catch(a){o=!0,r=a}finally{try{t||null==n.return||n.return()}finally{if(o)throw r}}}},{key:"fireDoubleClick",value:function(e){var t=!0,o=!1,r=void 0;try{for(var i,n=this.doubleClickCallbacks[Symbol.iterator]();!(t=(i=n.next()).done);t=!0){(0,i.value)(e)}}catch(a){o=!0,r=a}finally{try{t||null==n.return||n.return()}finally{if(o)throw r}}}},{key:"fireChangeRect",value:function(e){var t=!0,o=!1,r=void 0;try{for(var i,n=this.changeRectCallbacks[Symbol.iterator]();!(t=(i=n.next()).done);t=!0){(0,i.value)(e)}}catch(a){o=!0,r=a}finally{try{t||null==n.return||n.return()}finally{if(o)throw r}}}},{key:"fireDragEnd",value:function(e,t){var o=!0,r=!1,i=void 0;try{for(var n,a=this.dragEndCallbacks[Symbol.iterator]();!(o=(n=a.next()).done);o=!0){(0,n.value)(e,t)}}catch(c){r=!0,i=c}finally{try{o||null==a.return||a.return()}finally{if(r)throw i}}}}]),e}()),le=Object(w.a)(ce.prototype,"name",[E.y],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),se=Object(w.a)(ce.prototype,"rect",[E.y],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),ue=Object(w.a)(ce.prototype,"translate",[E.y],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),de=Object(w.a)(ce.prototype,"slots",[E.y],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),he=Object(w.a)(ce.prototype,"debugIdx",[E.y],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),fe=Object(w.a)(ce.prototype,"finishedEditing",[E.y],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),ye=Object(w.a)(ce.prototype,"requestedWidth",[E.y],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),pe=Object(w.a)(ce.prototype,"requestedHeight",[E.y],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),me=Object(w.a)(ce.prototype,"image",[E.y],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),ge=Object(w.a)(ce.prototype,"imageUrl",[E.y],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),be=Object(w.a)(ce.prototype,"style",[E.y],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),Object(w.a)(ce.prototype,"setPosition",[E.h],Object.getOwnPropertyDescriptor(ce.prototype,"setPosition"),ce.prototype),Object(w.a)(ce.prototype,"name2slot",[E.j],Object.getOwnPropertyDescriptor(ce.prototype,"name2slot"),ce.prototype),ce),Je=function(){function e(t,o,r,i,n){Object(g.a)(this,e),this.uid=t,this.positionHint=o,this.icon=r,this.color=i,this.position={x:0,y:0},this.clickCallbacks=[],n&&this.on("click",n)}return Object(b.a)(e,[{key:"click",value:function(){var e=!0,t=!1,o=void 0;try{for(var r,i=this.clickCallbacks[Symbol.iterator]();!(e=(r=i.next()).done);e=!0){(0,r.value)()}}catch(n){t=!0,o=n}finally{try{e||null==i.return||i.return()}finally{if(t)throw o}}}},{key:"on",value:function(e,t){this.clickCallbacks.push(t)}}]),e}(),Ke=(ke=function(){function e(t,o,r){Object(g.a)(this,e),this.from=t,this.to=o,this.type=r,Object(m.a)(this,"fromPoint",ve,this),Object(m.a)(this,"toPoint",Oe,this),this.fromPoint={x:0,y:0},this.toPoint={x:0,y:0}}return Object(b.a)(e,[{key:"uid",get:function(){return"".concat(this.from.blockUid,":").concat(this.from.slot,":").concat(this.to.blockUid,":").concat(this.to.slot)}}]),e}(),ve=Object(w.a)(ke.prototype,"fromPoint",[E.y],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),Oe=Object(w.a)(ke.prototype,"toPoint",[E.y],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),ke),Ne=(Se=function(){function e(t,o){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{x:0,y:0};Object(g.a)(this,e),this.name=t,this.type=o,Object(m.a)(this,"position",we,this),this.position=r}return Object(b.a)(e,[{key:"key",get:function(){return this.name}}]),e}(),we=Object(w.a)(Se.prototype,"position",[E.y],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),Se),Xe=function(){function e(){Object(g.a)(this,e)}return Object(b.a)(e,[{key:"layoutBlockButtons",value:function(e,t){var o=new P,r=!0,i=!1,n=void 0;try{for(var a,c=t[Symbol.iterator]();!(r=(a=c.next()).done);r=!0){var l=a.value;o.push(l.positionHint,l)}}catch(g){i=!0,n=g}finally{try{r||null==c.return||c.return()}finally{if(i)throw n}}var s=e.rect,u=s.x+s.width-10,d=s.y-10-4,h=!0,f=!1,y=void 0;try{for(var p,m=o.get("topRight")[Symbol.iterator]();!(h=(p=m.next()).done);h=!0){p.value.position={x:u,y:d},u-=24}}catch(g){f=!0,y=g}finally{try{h||null==m.return||m.return()}finally{if(f)throw y}}}}]),e}(),Ye=o(26),Ve=(je=function(){function e(t){Object(g.a)(this,e),this.scene=t,Object(Ye.a)(this,"blocks"),Object(Ye.a)(this,"blockConnections"),Object(Ye.a)(this,"columnBlocks")}return Object(b.a)(e,[{key:"getOutputSlotConnections",value:function(e,t){return this.blockConnections.output.get(e).filter((function(e){return e.from.slot===t}))}},{key:"getInputSlotConnections",value:function(e,t){return this.blockConnections.input.get(e).filter((function(e){return e.to.slot===t}))}},{key:"getChildBlocks",value:function(e){var t=[],o=!0,r=!1,i=void 0;try{for(var n,a=this.blockConnections.output.get(e)[Symbol.iterator]();!(o=(n=a.next()).done);o=!0){var c=n.value;t.push(c.to.blockUid),t.push.apply(t,Object(f.a)(this.getChildBlocks(c.to.blockUid)))}}catch(l){r=!0,i=l}finally{try{o||null==a.return||a.return()}finally{if(r)throw i}}return t}},{key:"getFistChildBlock",value:function(e,t){if("mmroot"===e.type){var o=this.blockConnections.output.get(e.uid);if((o=1===t?o.filter((function(e){return"or"===e.from.slot})):o.filter((function(e){return"ol"===e.from.slot}))).length>0)return this.blocks.get(o[0].to.blockUid)}else{var r=this.getChildBlocks(e.uid);if(r.length>0)return this.blocks.get(r[0])}}},{key:"getParentBlock",value:function(e){return"mmroot"===e.type?e:this.blocks.get(this.blockConnections.input.get(e.uid)[0].from.blockUid)}},{key:"updateBlockPosition",value:function(e,t,o,r){var i=this.blocks.get(t.to.blockUid);e.push(o+r,i);var n=!0,a=!1,c=void 0;try{for(var l,s=this.blockConnections.output.get(i.uid)[Symbol.iterator]();!(n=(l=s.next()).done);n=!0){var u=l.value;this.updateBlockPosition(e,u,o+r,r)}}catch(d){a=!0,c=d}finally{try{n||null==s.return||s.return()}finally{if(a)throw c}}}},{key:"getBlockColumnIdx",value:function(e){if("mmroot"===e.type)return 0;for(var t=0;;){var o=this.blockConnections.input.get(e.uid)[0];if(t+=1,"mmroot"===(e=this.blocks.get(o.from.blockUid)).type)return"ol"===o.from.slot?-t:t}}},{key:"blockSide",value:function(e){if("mmroot"===e.type)return 0;for(var t=this.blockConnections.input.get(e.uid)[0];"mmroot"!==e.type;)t=this.blockConnections.input.get(e.uid)[0],e=this.blocks.get(t.from.blockUid);return"ol"===t.from.slot?-1:1}},{key:"blocks",get:function(){var e=new Map,t=!0,o=!1,r=void 0;try{for(var i,n=this.scene.diagramBlocks[Symbol.iterator]();!(t=(i=n.next()).done);t=!0){var a=i.value;e.set(a.uid,a)}}catch(c){o=!0,r=c}finally{try{t||null==n.return||n.return()}finally{if(o)throw r}}return e}},{key:"blockConnections",get:function(){var e=new P,t=new P,o=!0,r=!1,i=void 0;try{for(var n,a=this.scene.diagramConnections[Symbol.iterator]();!(o=(n=a.next()).done);o=!0){var c=n.value;e.push(c.to.blockUid,c),t.push(c.from.blockUid,c)}}catch(l){r=!0,i=l}finally{try{o||null==a.return||a.return()}finally{if(r)throw i}}return{input:e,output:t}}},{key:"columnBlocks",get:function(){console.log("columnBlock");var e=new P,t=this.scene.diagramBlocks[0];e.push(0,t);var o=this.blockConnections.output.get(t.uid),r=o.filter((function(e){return"ol"===e.from.slot})),i=!0,n=!1,a=void 0;try{for(var c,l=r[Symbol.iterator]();!(i=(c=l.next()).done);i=!0){var s=c.value;this.updateBlockPosition(e,s,0,-1)}}catch(g){n=!0,a=g}finally{try{i||null==l.return||l.return()}finally{if(n)throw a}}var u=o.filter((function(e){return"or"===e.from.slot})),d=!0,h=!1,f=void 0;try{for(var y,p=u[Symbol.iterator]();!(d=(y=p.next()).done);d=!0){var m=y.value;this.updateBlockPosition(e,m,0,1)}}catch(g){h=!0,f=g}finally{try{d||null==p.return||p.return()}finally{if(h)throw f}}return e}}]),e}(),Object(w.a)(je.prototype,"blocks",[E.j],Object.getOwnPropertyDescriptor(je.prototype,"blocks"),je.prototype),Object(w.a)(je.prototype,"blockConnections",[E.j],Object.getOwnPropertyDescriptor(je.prototype,"blockConnections"),je.prototype),Object(w.a)(je.prototype,"columnBlocks",[E.j],Object.getOwnPropertyDescriptor(je.prototype,"columnBlocks"),je.prototype),je),Ze=(Be=function(){function e(t){Object(g.a)(this,e),this.diagramStructure=t}return Object(b.a)(e,[{key:"layout",value:function(){var e=this.diagramStructure.scene.diagramBlocks[0];if("mmroot"!==e.type)throw new Error("Invalid diagram structure");e.slots[0].position={x:0,y:e.rect.height/2},e.slots[1].position={x:e.rect.width,y:e.rect.height/2};var t=this.diagramStructure.getOutputSlotConnections(e.uid,"or"),o=[],r=!0,i=!1,n=void 0;try{for(var a,c=t[Symbol.iterator]();!(r=(a=c.next()).done);r=!0){var l=a.value;o.push(l.to.blockUid),o.push.apply(o,Object(f.a)(this.diagramStructure.getChildBlocks(l.to.blockUid)))}}catch(x){i=!0,n=x}finally{try{r||null==c.return||c.return()}finally{if(i)throw n}}var s=this.diagramStructure.getOutputSlotConnections(e.uid,"ol"),u=[],d=!0,h=!1,y=void 0;try{for(var p,m=s[Symbol.iterator]();!(d=(p=m.next()).done);d=!0){var g=p.value;u.push(g.to.blockUid),u.push.apply(u,Object(f.a)(this.diagramStructure.getChildBlocks(g.to.blockUid)))}}catch(x){h=!0,y=x}finally{try{d||null==m.return||m.return()}finally{if(h)throw y}}for(var b=0,k=o;b<k.length;b++){var v=k[b],O=this.diagramStructure.blocks.get(v);O.slots[0].position={x:0,y:O.rect.height/2},O.slots[1].position={x:O.rect.width,y:O.rect.height/2}}for(var S=0,w=u;S<w.length;S++){var j=w[S],B=this.diagramStructure.blocks.get(j);B.slots[0].position={x:B.rect.width,y:B.rect.height/2},B.slots[1].position={x:0,y:B.rect.height/2}}}}]),e}(),Object(w.a)(Be.prototype,"layout",[E.h],Object.getOwnPropertyDescriptor(Be.prototype,"layout"),Be.prototype),Be),$e=function(){function e(t){Object(g.a)(this,e),this.diagramStructure=t,this.disposers=[]}return Object(b.a)(e,[{key:"layout",value:function(){var e=this,t=!0,o=!1,r=void 0;try{for(var i,n=this.disposers[Symbol.iterator]();!(t=(i=n.next()).done);t=!0){(0,i.value)()}}catch(h){o=!0,r=h}finally{try{t||null==n.return||n.return()}finally{if(o)throw r}}var a=!0,c=!1,l=void 0;try{for(var s,u=function(){var t=s.value,o=e.diagramStructure.blocks.get(t.from.blockUid),r=e.diagramStructure.blocks.get(t.to.blockUid);e.disposers.push(Object(E.i)((function(){return e.setConnectionPosition(t,o,r)}),{delay:30}))},d=this.diagramStructure.scene.diagramConnections[Symbol.iterator]();!(a=(s=d.next()).done);a=!0)u()}catch(h){c=!0,l=h}finally{try{a||null==d.return||d.return()}finally{if(c)throw l}}}},{key:"setConnectionPosition",value:function(e,t,o){var r=t.name2slot.get(e.from.slot).position,i=o.name2slot.get(e.to.slot).position;e.fromPoint={x:r.x+t.rect.x+t.translate.x,y:r.y+t.rect.y+t.translate.y},e.toPoint={x:i.x+o.rect.x+o.translate.x,y:i.y+o.rect.y+o.translate.y}}}]),e}(),Ge={hMargin:30,vMargin:10},Qe=function(){function e(t){var o=arguments.length>1&&void 0!==arguments[1]?arguments[1]:Ge;Object(g.a)(this,e),this.diagramStructure=t,this.parameters=o,this.blockColumns=new Map,this.columnBlocks=new P,this.childShift=new Map,this.blockHeight=new Map,this.blockChildWidth=new Map,this.columnWidth=new Map,this.columnCenter=new Map,this.blockPosition=new Map}return Object(b.a)(e,[{key:"layoutColumns",value:function(){if(!this.diagramStructure)throw new Error("Diagram data not defined");var e=this.diagramStructure.scene.diagramBlocks;this.blockColumns=new Map,this.columnBlocks=new P;for(var t=this.diagramStructure.blockConnections.input,o=0;o<e.length;++o)if(0===o){if(this.blockColumns.set(e[o].uid,0),this.columnBlocks.push(o,e[o].uid),!t.empty(e[o].uid))throw new Error("Invalid mm diagram blocks structure (first block must be root block - no input connections)")}else{var r=t.get(e[o].uid);if(1!==r.length)throw new Error("Invalid mm diagram blocks structure (each block except root must have exactly one input connection )");var i=this.blockColumns.get(r[0].from.blockUid);if(void 0===i)throw new Error("Invalid mm diagram blocks structure (parent block must preceed child block)");var n=i;0===n?"or"===r[0].from.slot?n+=1:n-=1:n>0?n+=1:n<0&&(n-=1),this.blockColumns.set(e[o].uid,n),this.columnBlocks.push(n,e[o].uid)}}},{key:"layout",value:function(){var e=this.diagramStructure.blockConnections,t=e.input,o=e.output;this.layoutColumns();for(var r=Array.from(this.columnBlocks.keys()).sort((function(e,t){return e-t})),i=r[0],n=r[r.length-1],a=i;a<=n;++a){var c=0,l=!0,s=!1,u=void 0;try{for(var d,h=this.columnBlocks.get(a)[Symbol.iterator]();!(l=(d=h.next()).done);l=!0){var f=d.value;c=Math.max(c,this.diagramStructure.blocks.get(f).rect.width)}}catch(q){s=!0,u=q}finally{try{l||null==h.return||h.return()}finally{if(s)throw u}}this.columnWidth.set(a,c)}var y=0;this.columnCenter.set(0,0);for(var p=1;p<=n;++p){var m=this.columnWidth.get(p-1),g=this.columnWidth.get(p);y=y+m/2+this.parameters.hMargin+g/2,this.columnCenter.set(p,y)}y=0;for(var b=-1;b>=i;--b){var k=this.columnWidth.get(b+1),v=this.columnWidth.get(b);y=y-k/2-this.parameters.hMargin-v/2,this.columnCenter.set(b,y)}var O=this.diagramStructure.scene.diagramBlocks[0];if(t.get(O.uid).length>0)throw new Error("Invalid diagram structure, root block has input connections");var S=!0,w=!1,j=void 0;try{for(var B,x=o.get(O.uid)[Symbol.iterator]();!(S=(B=x.next()).done);S=!0){var C=B.value;this.updateChildHeight(C.to.blockUid)}}catch(q){w=!0,j=q}finally{try{S||null==x.return||x.return()}finally{if(w)throw j}}this.blockPosition.set(O.uid,{x:0,y:0}),this.updateChildPositions(1,this.columnBlocks.get(1),{x:0,y:0}),this.updateChildPositions(-1,this.columnBlocks.get(-1),{x:0,y:0});var E=!0,P=!1,z=void 0;try{for(var R,M=this.diagramStructure.scene.diagramBlocks[Symbol.iterator]();!(E=(R=M.next()).done);E=!0){var U=R.value,W=this.blockPosition.get(U.uid);U.rect=new D(W.x-U.rect.width/2,W.y-U.rect.height/2,U.rect.width,U.rect.height)}}catch(q){P=!0,z=q}finally{try{E||null==M.return||M.return()}finally{if(P)throw z}}}},{key:"updateChildPositions",value:function(e,t,o){if(!this.diagramStructure)throw new Error("Diagram data not defined");var r=0,i=!0,n=!1,a=void 0;try{for(var c,l=t[Symbol.iterator]();!(i=(c=l.next()).done);i=!0){var s=c.value;r+=this.blockHeight.get(s)}}catch(O){n=!0,a=O}finally{try{i||null==l.return||l.return()}finally{if(n)throw a}}r+=(t.length-1)*this.parameters.vMargin;var u=o.y-r/2,d=this.columnCenter.get(e);e>0?e+=1:e-=1;var h=!0,f=!1,y=void 0;try{for(var p,m=t[Symbol.iterator]();!(h=(p=m.next()).done);h=!0){var g=p.value,b=this.blockHeight.get(g),k={x:d,y:u+b/2};this.blockPosition.set(g,k);var v=this.diagramStructure.blockConnections.output.get(g).map((function(e){return e.to.blockUid}));this.updateChildPositions(e,v,k),u+=b+this.parameters.vMargin}}catch(O){f=!0,y=O}finally{try{h||null==m.return||m.return()}finally{if(f)throw y}}}},{key:"updateChildHeight",value:function(e){var t=this.diagramStructure.blocks.get(e),o=this.diagramStructure.blockConnections.output.get(e),r=0,i=!0,n=!1,a=void 0;try{for(var c,l=o[Symbol.iterator]();!(i=(c=l.next()).done);i=!0){var s=c.value;r+=this.updateChildHeight(s.to.blockUid)}}catch(d){n=!0,a=d}finally{try{i||null==l.return||l.return()}finally{if(n)throw a}}r+=this.parameters.vMargin*(o.length-1);var u=Math.max(r,t.rect.height);return this.blockHeight.set(e,u),u}},{key:"getBlockColumn",value:function(e){return this.blockColumns.get(e)}},{key:"getBlocks",value:function(e){var t=[],o=!0,r=!1,i=void 0;try{for(var n,a=this.diagramStructure.scene.diagramBlocks[Symbol.iterator]();!(o=(n=a.next()).done);o=!0){var c=n.value,l=c.rect;e.x>l.x&&e.x<l.x+l.width&&e.y>l.y&&e.y<l.y+l.height&&t.push(c)}}catch(s){r=!0,i=s}finally{try{o||null==a.return||a.return()}finally{if(r)throw i}}return t}},{key:"getChildIdx",value:function(e,t,o){var r=this;if(!this.diagramStructure)throw new Error("Diagram data not defined");var i=[],n=this.diagramStructure.blockConnections.output,a=!0,c=!1,l=void 0;try{for(var s,u=n.get(t)[Symbol.iterator]();!(a=(s=u.next()).done);a=!0){var d=s.value;i.push(d.to.blockUid)}}catch(S){c=!0,l=S}finally{try{a||null==u.return||u.return()}finally{if(c)throw l}}i=i.filter((function(t){return e!==t})),Ie.info("Found child uids ".concat(i));var h=i.map((function(e){return r.diagramStructure.blocks.get(e)})).map((function(e){return r.diagramStructure.scene.diagramBlocks.indexOf(e)})).sort((function(e,t){return e-t})),f=h.map((function(e){return[e,r.diagramStructure.scene.diagramBlocks[e].rect.y,r.diagramStructure.scene.diagramBlocks[e].rect.height]}));Ie.info((function(){return"getChildIdx block rects ".concat(f)}));var y=0,p=!0,m=!1,g=void 0;try{for(var b,k=h[Symbol.iterator]();!(p=(b=k.next()).done);p=!0){var v=b.value,O=this.diagramStructure.scene.diagramBlocks[v].rect;if(o<O.y+O.height/2)break;y++}}catch(S){m=!0,g=S}finally{try{p||null==k.return||k.return()}finally{if(m)throw g}}return[y,h]}},{key:"getColumnIdx",value:function(e){var t=Math.max.apply(Math,Object(f.a)(Array.from(this.columnWidth.keys()))),o=Math.min.apply(Math,Object(f.a)(Array.from(this.columnWidth.keys()))),r=-this.columnWidth.get(0)/2;if(e>=r){for(var i=0;i<=t;++i){if(e<(r+=this.columnWidth.get(i)))return i;r+=this.parameters.hMargin}return null}for(var n=-1;n>=o;--n){if(e>(r-=this.columnWidth.get(n)))return n;r-=this.parameters.hMargin}return null}}]),e}();function et(e,t){var o=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),o.push.apply(o,r)}return o}var tt,ot,rt,it=(xe=function(){function e(){var t=this,o=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];Object(g.a)(this,e),Object(m.a)(this,"diagramBlocks",Ce,this),Object(m.a)(this,"diagramConnections",Ee,this),Object(m.a)(this,"activeButtons",De,this),Object(m.a)(this,"_editedBlock",Pe,this),Object(m.a)(this,"_selectedBlock",ze,this),Object(m.a)(this,"_previousSelection",Re,this),Object(m.a)(this,"onEdit",Me,this),Object(m.a)(this,"structureChanging",Ue,this),Object(m.a)(this,"sceneTranslate",We,this),Object(m.a)(this,"sceneTranslateDelta",qe,this),Object(m.a)(this,"image",Te,this),this.diagramStructure=void 0,this.buttonLayout=new Xe,this.slotLayout=void 0,this.blockLayout=void 0,this.connectionLayout=void 0,this._previouseName="",this.oldEditedBlock=void 0,this.diagramBlocks=o,this.diagramConnections=r,this.diagramStructure=new Ve(this),this.slotLayout=new Ze(this.diagramStructure),this.blockLayout=new Qe(this.diagramStructure),this.connectionLayout=new $e(this.diagramStructure),Object(E.i)((function(){var e=!1,o=!0,r=!1,i=void 0;try{for(var n,a=t.diagramBlocks[Symbol.iterator]();!(o=(n=a.next()).done);o=!0){var c=n.value;c.requestedWidth&&c.requestedHeight&&c.finishedEditing&&(c.rect.width!=c.requestedWidth||c.rect.height!=c.requestedHeight)&&(c.rect.width=c.requestedWidth,c.rect.height=c.requestedHeight,e=!0)}}catch(l){r=!0,i=l}finally{try{o||null==a.return||a.return()}finally{if(r)throw i}}e&&t.layout()}),{name:"asd"})}return Object(b.a)(e,[{key:"setEditedBlock",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];this._editedBlock&&this._editedBlock.requestedWidth&&this._editedBlock.requestedWidth!=this._editedBlock.rect.width&&(this._editedBlock.finishedEditing=!0),void 0!==e&&(this._previouseName=e.name),t&&this._editedBlock&&(this._editedBlock.name=this._previouseName),this._editedBlock=e}},{key:"setStyle",value:function(e){this._selectedBlock&&(this._selectedBlock.style=e?function(e){for(var t=1;t<arguments.length;t++){var o=null!=arguments[t]?arguments[t]:{};t%2?et(o,!0).forEach((function(t){Object(y.a)(e,t,o[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(o)):et(o).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(o,t))}))}return e}({},this._selectedBlock.style,{},e):{},this.onEdit=!0)}},{key:"showBlockButtons",value:function(e,t){var o=this;this.buttonLayout.layoutBlockButtons(e,t),this.activeButtons=t;var r=!0,i=!1,n=void 0;try{for(var a,c=t[Symbol.iterator]();!(r=(a=c.next()).done);r=!0){a.value.on("click",(function(){o.activeButtons=[]}))}}catch(l){i=!0,n=l}finally{try{r||null==c.return||c.return()}finally{if(i)throw n}}}},{key:"layout",value:function(){this.diagramBlocks.length>0&&(this.slotLayout.layout(),this.blockLayout.layout(),this.connectionLayout.layout())}},{key:"up",value:function(){if(this.selectedBlock){var e=this.diagramStructure.getBlockColumnIdx(this.selectedBlock),t=this.diagramStructure.columnBlocks.get(e),o=t.indexOf(this.selectedBlock);o>0&&(this.selectedBlock=t[o-1])}}},{key:"down",value:function(){if(this.selectedBlock){var e=this.diagramStructure.getBlockColumnIdx(this.selectedBlock),t=this.diagramStructure.columnBlocks.get(e),o=t.indexOf(this.selectedBlock);o<t.length-1&&(this.selectedBlock=t[o+1])}}},{key:"left",value:function(){this.selectedBlock&&(1===this.diagramStructure.blockSide(this.selectedBlock)?this.selectParent():this.selectChild(-1))}},{key:"right",value:function(){this.selectedBlock&&(-1===this.diagramStructure.blockSide(this.selectedBlock)?this.selectParent():this.selectChild(1))}},{key:"edit",value:function(){this.selectedBlock&&this.setEditedBlock(this.selectedBlock)}},{key:"selectParent",value:function(){this.selectedBlock&&(this.selectedBlock=this.diagramStructure.getParentBlock(this.selectedBlock))}},{key:"selectChild",value:function(e){if(this.selectedBlock){var t=this.diagramStructure.getFistChildBlock(this.selectedBlock,e);t&&(this.selectedBlock=t)}}},{key:"editedBlock",get:function(){return this._editedBlock}},{key:"selectedBlock",get:function(){return this._selectedBlock},set:function(e){e!=this._selectedBlock&&(void 0==e?this._selectedBlock=this._previousSelection:(this._previousSelection=this._selectedBlock,this._selectedBlock=e),console.log("select block",e,this._previousSelection))}}]),e}(),Ce=Object(w.a)(xe.prototype,"diagramBlocks",[E.y],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),Ee=Object(w.a)(xe.prototype,"diagramConnections",[E.y],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),De=Object(w.a)(xe.prototype,"activeButtons",[E.y],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Pe=Object(w.a)(xe.prototype,"_editedBlock",[E.y],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),ze=Object(w.a)(xe.prototype,"_selectedBlock",[E.y],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),Re=Object(w.a)(xe.prototype,"_previousSelection",[E.y],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),Me=Object(w.a)(xe.prototype,"onEdit",[E.y],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Ue=Object(w.a)(xe.prototype,"structureChanging",[E.y],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),We=Object(w.a)(xe.prototype,"sceneTranslate",[E.y],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return{x:512,y:500}}}),qe=Object(w.a)(xe.prototype,"sceneTranslateDelta",[E.y],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return{x:0,y:0}}}),Te=Object(w.a)(xe.prototype,"image",[E.y],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),Object(w.a)(xe.prototype,"editedBlock",[E.j],Object.getOwnPropertyDescriptor(xe.prototype,"editedBlock"),xe.prototype),Object(w.a)(xe.prototype,"selectedBlock",[E.j],Object.getOwnPropertyDescriptor(xe.prototype,"selectedBlock"),xe.prototype),Object(w.a)(xe.prototype,"setStyle",[E.h],Object.getOwnPropertyDescriptor(xe.prototype,"setStyle"),xe.prototype),Object(w.a)(xe.prototype,"layout",[E.h],Object.getOwnPropertyDescriptor(xe.prototype,"layout"),xe.prototype),Object(w.a)(xe.prototype,"up",[E.h],Object.getOwnPropertyDescriptor(xe.prototype,"up"),xe.prototype),Object(w.a)(xe.prototype,"down",[E.h],Object.getOwnPropertyDescriptor(xe.prototype,"down"),xe.prototype),Object(w.a)(xe.prototype,"left",[E.h],Object.getOwnPropertyDescriptor(xe.prototype,"left"),xe.prototype),Object(w.a)(xe.prototype,"right",[E.h],Object.getOwnPropertyDescriptor(xe.prototype,"right"),xe.prototype),Object(w.a)(xe.prototype,"edit",[E.h],Object.getOwnPropertyDescriptor(xe.prototype,"edit"),xe.prototype),xe),nt=function(){function e(){Object(g.a)(this,e)}return Object(b.a)(e,null,[{key:"fromJSON",value:function(e){var t=new it,o=new Le(z(),e.root.name,"mmroot",[new Ne("ol","o"),new Ne("or","o")],new D(0,0,200,30),e.root.style);return t.diagramBlocks.push(o),e.root.children&&e.root.children.left&&this.addChildBlocksFromJson(e.root.children.left,t,o,!0),e.root.children&&e.root.children.right&&this.addChildBlocksFromJson(e.root.children.right,t,o,!1),e.defaultStyle&&Y(e.defaultStyle),t}},{key:"addChildBlocksFromJson",value:function(e,t,o,r){var i=!0,n=!1,a=void 0;try{for(var c,l=e[Symbol.iterator]();!(i=(c=l.next()).done);i=!0){var s=c.value,u=new Le(z(),s.name,"mm",[new Ne("i","i"),new Ne("o","o")],new D(0,0,100,30),s.style);t.diagramBlocks.push(u),"mmroot"==o.type?r?t.diagramConnections.push(new Ke({blockUid:o.uid,slot:"ol"},{blockUid:u.uid,slot:"i"},"mm")):t.diagramConnections.push(new Ke({blockUid:o.uid,slot:"or"},{blockUid:u.uid,slot:"i"},"mm")):t.diagramConnections.push(new Ke({blockUid:o.uid,slot:"o"},{blockUid:u.uid,slot:"i"},"mm")),s.children&&this.addChildBlocksFromJson(s.children,t,u)}}catch(d){n=!0,a=d}finally{try{i||null==l.return||l.return()}finally{if(n)throw a}}}},{key:"toJSON",value:function(e){var t=e.diagramBlocks[0],o={root:{name:t.name,style:Object(E.D)(t.style)},defaultStyle:q},r=e.diagramStructure.getOutputSlotConnections(t.uid,"ol");r.length>0&&(o.root.children={left:this.addChildBlocksFromScene(r,e)});var i=e.diagramStructure.getOutputSlotConnections(t.uid,"or");return i.length>0&&(o.root.children?o.root.children.right=this.addChildBlocksFromScene(i,e):o.root.children={right:this.addChildBlocksFromScene(i,e)}),o}},{key:"addChildBlocksFromScene",value:function(e,t){var o=[],r=!0,i=!1,n=void 0;try{for(var a,c=e[Symbol.iterator]();!(r=(a=c.next()).done);r=!0){var l=a.value,s=t.diagramStructure.blocks.get(l.to.blockUid),u={name:s.name,style:Object(E.D)(s.style)},d=t.diagramStructure.getOutputSlotConnections(s.uid,"o");d.length>0&&(u.children=this.addChildBlocksFromScene(d,t)),o.push(u)}}catch(h){i=!0,n=h}finally{try{r||null==c.return||c.return()}finally{if(i)throw n}}return o}}]),e}();function at(){var e=Object(j.a)(["\nwidth: 80%;\nheight: 60%;\nmargin-left: 7%;\nmargin-top:3px;\n"]);return at=function(){return e},e}function ct(){var e=Object(j.a)(["\n    position:absolute;\n    left :","px;\n    top : ","px;\n    width : 100px;\n    height : 30px;\n"]);return ct=function(){return e},e}var lt,st,ut,dt,ht=B.a.div(ct(),(function(e){return e.rect.x}),(function(e){return e.rect.y})),ft=B.a.input(at()),yt=Object(x.a)(tt=function(e){function t(e){var o;return Object(g.a)(this,t),(o=Object(k.a)(this,Object(v.a)(t).call(this,e))).myRef=u.a.createRef(),o.focusOut=!1,o.handleBlur=function(e){e.currentTarget.contains(e.relatedTarget)||(o.props.block.name=e.target.value,o.focusOut=!0)},o}return Object(S.a)(t,e),Object(b.a)(t,[{key:"componentDidMount",value:function(){this.props.block.finishedEditing=!1,this.myRef.current&&(this.myRef.current.focus(),this.myRef.current.setSelectionRange(0,this.props.block.name.length))}},{key:"componentWillUnmount",value:function(){this.props.block.finishedEditing=!0}},{key:"render",value:function(){var e=this;return u.a.createElement(ft,{ref:this.myRef,type:"text",value:this.props.block.name,onFocus:function(t){e.focusOut=!1},onBlur:function(t){return e.handleBlur(t)},onChange:function(t){e.focusOut||(e.props.block.name=t.target.value)},onKeyDown:this.props.onKeyDown})}}]),t}(u.a.Component))||tt,pt=Object(x.a)((rt=function(e){function t(){return Object(g.a)(this,t),Object(k.a)(this,Object(v.a)(t).apply(this,arguments))}return Object(S.a)(t,e),Object(b.a)(t,[{key:"render",value:function(){var e=this;if(this.props.scene.editedBlock){var t=D.copy(this.props.scene.editedBlock.rect);return t.x+=this.props.scene.sceneTranslate.x,t.y+=this.props.scene.sceneTranslate.y,u.a.createElement(ht,{rect:t},u.a.createElement(yt,{block:this.props.scene.editedBlock,onKeyDown:function(t){return e.handleKeyDown(t)}}))}return null}},{key:"handleKeyDown",value:function(e){this.props.scene.editedBlock&&"Enter"===e.key&&(this.props.scene.setEditedBlock(void 0),this.props.scene.onEdit=!0,this.props.scene.activeButtons=[])}}]),t}(u.a.Component),Object(w.a)(rt.prototype,"handleKeyDown",[E.h],Object.getOwnPropertyDescriptor(rt.prototype,"handleKeyDown"),rt.prototype),ot=rt))||ot,mt=function(e){var t=Object(s.useRef)(null);return u.a.createElement("select",{ref:t,onChange:function(e){function t(t){return e.apply(this,arguments)}return t.toString=function(){return e.toString()},t}((function(o){return r=o.target.value,t&&t.current&&(t.current.selectedIndex=0),void e.onChange(r);var r}))},e.options.map((function(e){return u.a.createElement("option",{key:e},e)})))},gt=function e(t){Object(g.a)(this,e),this.ctrl=!1,this.alt=!1,this.key="";var o=t.split("+"),r=!0,i=!1,n=void 0;try{for(var a,c=o[Symbol.iterator]();!(r=(a=c.next()).done);r=!0){var l=a.value;if("ctrl"===l)this.ctrl=!0;else if("alt"===l)this.alt=!0;else{if(1!==l.length){this.key="";break}if(""!==this.key){this.key="";break}this.key=l}}}catch(s){i=!0,n=s}finally{try{r||null==c.return||c.return()}finally{if(i)throw n}}};function bt(e,t){var o=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),o.push.apply(o,r)}return o}function kt(){var e=Object(j.a)(["\n    position:absolute;\n    width : 100%;\n    height : 100%;\n"]);return kt=function(){return e},e}var vt=B.a.div(kt()),Ot=Object(x.a)((st=function(e){function t(e){var o;if(Object(g.a)(this,t),o=Object(k.a)(this,Object(v.a)(t).call(this,e)),Object(m.a)(o,"diagramScene",ut,Object(O.a)(o)),o.addedBlock=void 0,o.vscode=void 0,o.mainRef=u.a.createRef(),o.selectRef=u.a.createRef(),Object(m.a)(o,"styles",dt,Object(O.a)(o)),o.fontsSizes=[8,10,12,14,16,18,22,26,32,36,40],o.strokeSize=[1,2,3,4,5,6],o.margins=[5,10,15,20,30,40,50],o.hotkeys=[],o.keyDown=function(e){if(document.activeElement===o.mainRef.current){console.log(" ".concat(e.key," ").concat(e.altKey," ").concat(e.ctrlKey));var t=!0,r=!1,i=void 0;try{for(var n,a=o.hotkeys[Symbol.iterator]();!(t=(n=a.next()).done);t=!0){var c=n.value,l=Object(p.a)(c,2),s=l[0],u=l[1];s.key===e.key&&s.alt===e.altKey&&s.ctrl===e.ctrlKey&&o.setStyle(u)}}catch(d){r=!0,i=d}finally{try{t||null==a.return||a.return()}finally{if(r)throw i}}switch(e.key){case"ArrowUp":o.diagramScene.up(),e.preventDefault();break;case"ArrowDown":o.diagramScene.down(),e.preventDefault();break;case"ArrowLeft":o.diagramScene.left(),e.preventDefault();break;case"ArrowRight":o.diagramScene.right(),e.preventDefault()}}},o.setStyle=function(e){var t=o.styles.get(e);o.diagramScene.setStyle(t),o.selectRef&&o.selectRef.current&&(o.selectRef.current.selectedIndex=0)},o.setFont=function(e){var t=parseInt(e);o.diagramScene.setStyle({fontSize:t})},o.setStrokeWidth=function(e){var t=parseInt(e);o.diagramScene.setStyle({strokeWidth:t})},o.setMargin=function(e){var t=parseInt(e);o.diagramScene.setStyle({margin:{top:t,bottom:t,left:t,right:t}})},o.setBackgroundColor=function(e){o.diagramScene.setStyle({backgroundColor:e})},o.vscode=o.props.vscode,o.diagramScene=o.props.scene,0===o.diagramScene.diagramBlocks.length){var r=new Le(z(),"Enter diagram name","mmroot",[new Ne("ol","o"),new Ne("or","o")],new D(0,0,100,30));o.diagramScene.diagramBlocks.push(r)}return o.setStyles(o.props.styles),o.addCallbacks(o.diagramScene.diagramBlocks),o.diagramScene.layout(),window.addEventListener("message",(function(e){var t=e.data;switch(t.command){case"setJsonDocument":_e.info("setJsonDocument",t.document);var r=t.document;o.vscode.setState(r),o.diagramScene=nt.fromJSON(r),o.diagramScene.layout(),o.addCallbacks(o.diagramScene.diagramBlocks),o.selectRootElement(),o.focus();break;case"addChild":_e.info("addChild message"),o.diagramScene.selectedBlock&&(o.diagramScene.editedBlock&&o.diagramScene.setEditedBlock(void 0),o.addBlock(o.diagramScene.selectedBlock));break;case"addSibling":_e.info("addSibling message"),o.diagramScene.selectedBlock&&(o.diagramScene.editedBlock&&o.diagramScene.setEditedBlock(void 0),o.addSibling(o.diagramScene.selectedBlock));break;case"remove":_e.info("removeBlock message"),o.diagramScene.selectedBlock&&(o.diagramScene.editedBlock&&o.diagramScene.setEditedBlock(void 0),o.removeBlock(o.diagramScene.selectedBlock));break;case"moveLeft":_e.info("moveLeft message"),o.diagramScene.left();break;case"moveRight":_e.info("moveRight message"),o.diagramScene.right();break;case"moveUp":_e.info("moveUp message"),o.diagramScene.up();break;case"moveDown":_e.info("moveDown message"),o.diagramScene.down();break;case"cancel":_e.info("cancel message"),o.cancel();break;case"edit":_e.info("edit message"),o.diagramScene.edit();break;case"setStyles":o.setStyles(t.styles);break;case"focus":_e.info("focus"),o.focus()}})),Object(E.i)((function(){if(o.diagramScene.onEdit&&!o.diagramScene.editedBlock){if(o.vscode){var e=nt.toJSON(o.diagramScene);o.vscode.postMessage({message:"setDocument",document:e}),o.vscode.setState(e)}o.diagramScene.onEdit=!1,o.addedBlock=void 0}})),o}return Object(S.a)(t,e),Object(b.a)(t,[{key:"setStyles",value:function(e){_e.info("setStyles"),this.styles.clear(),this.hotkeys=[];var t=!0,o=!1,r=void 0;try{for(var i,n=e[Symbol.iterator]();!(t=(i=n.next()).done);t=!0){var a=i.value;if(a.name&&(this.styles.set(a.name,a),a.hotkey)){var c=new gt(a.hotkey);""!=c.key&&this.hotkeys.push([c,a.name])}}}catch(l){o=!0,r=l}finally{try{t||null==n.return||n.return()}finally{if(o)throw r}}}},{key:"addCallbacks",value:function(e){var t=this,o=!0,r=!1,i=void 0;try{for(var n,a=e[Symbol.iterator]();!(o=(n=a.next()).done);o=!0){var c=n.value;c.on("click",(function(e){var o=new Je("addB","topRight","add","red",(function(){t.addBlock(e)})),r=new Je("removeB","topRight","remove","red",(function(){t.removeBlock(e)}));t.diagramScene.showBlockButtons(e,[o,r])})),c.on("dragEnd",(function(e,o){_e.info("Block drag end '".concat(e.name,"' (").concat(o.x,",").concat(o.y,")")),t.endDragging(e,o),t.diagramScene.layout()})),c.on("doubleClick",(function(e){_e.info("Block double click ".concat(e.uid)),t.diagramScene.setEditedBlock(e),t.diagramScene.activeButtons=[]}))}}catch(l){r=!0,i=l}finally{try{o||null==a.return||a.return()}finally{if(r)throw i}}}},{key:"componentDidMount",value:function(){this.vscode&&this.vscode.postMessage({message:"getDocument"}),this.focus(),this.selectRootElement()}},{key:"selectRootElement",value:function(){this.diagramScene.diagramBlocks.length>0&&(this.diagramScene.selectedBlock=this.diagramScene.diagramBlocks[0])}},{key:"focus",value:function(){this.mainRef&&this.mainRef.current&&this.mainRef.current.focus()}},{key:"removeBlock",value:function(e){var t=this;if("mmroot"!==e.type){_e.info("removeBlock ".concat(e.name));var o=this.diagramScene.diagramStructure.getChildBlocks(e.uid).map((function(e){return t.diagramScene.diagramStructure.blocks.get(e)}));o.push(e);var r=[],i=!0,n=!1,a=void 0;try{for(var c,l=o[Symbol.iterator]();!(i=(c=l.next()).done);i=!0){var s=c.value;r.push(this.diagramScene.diagramStructure.blockConnections.input.get(s.uid)[0])}}catch(O){n=!0,a=O}finally{try{i||null==l.return||l.return()}finally{if(n)throw a}}var u=!0,d=!1,h=void 0;try{for(var f,y=o[Symbol.iterator]();!(u=(f=y.next()).done);u=!0){var p=f.value,m=this.diagramScene.diagramBlocks.indexOf(p);this.diagramScene.diagramBlocks.splice(m,1)}}catch(O){d=!0,h=O}finally{try{u||null==y.return||y.return()}finally{if(d)throw h}}for(var g=0,b=r;g<b.length;g++){var k=b[g],v=this.diagramScene.diagramConnections.indexOf(k);this.diagramScene.diagramConnections.splice(v,1)}this.diagramScene.layout(),this.diagramScene.onEdit=!0,this.diagramScene.selectedBlock=void 0,this.diagramScene.activeButtons=[]}}},{key:"addSibling",value:function(e){if("mmroot"!=e.type){var t=this.diagramScene.diagramStructure.blockConnections.input.get(e.uid)[0].from.blockUid,o=this.diagramScene.diagramStructure.blocks.get(t);this.addBlock(o),this.diagramScene.activeButtons=[]}}},{key:"addBlock",value:function(e){_e.info("addBlock (parent=".concat(e.name,")"));var t,o=new Le(z(),"Unnamed element","mm",[new Ne("i","i"),new Ne("o","o")],new D(0,0,100,30));"mmroot"!==e.type&&(o.style=function(e){for(var t=1;t<arguments.length;t++){var o=null!=arguments[t]?arguments[t]:{};t%2?bt(o,!0).forEach((function(t){Object(y.a)(e,t,o[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(o)):bt(o).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(o,t))}))}return e}({},e.style)),this.addCallbacks([o]),t="mmroot"===e.type?new Ke({blockUid:e.uid,slot:"or"},{blockUid:o.uid,slot:"i"},"mm"):new Ke({blockUid:e.uid,slot:"o"},{blockUid:o.uid,slot:"i"},"mm"),this.diagramScene.diagramBlocks.push(o),this.diagramScene.diagramConnections.push(t),this.diagramScene.layout(),this.diagramScene.setEditedBlock(o),this.diagramScene.selectedBlock=o,this.diagramScene.onEdit=!0,this.diagramScene.activeButtons=[],this.addedBlock=o}},{key:"cancel",value:function(){this.addedBlock?(this.removeBlock(this.addedBlock),this.addedBlock=void 0,this.diagramScene.setEditedBlock(void 0),this.diagramScene.selectedBlock=void 0):this.diagramScene.editedBlock&&this.diagramScene.setEditedBlock(void 0,!0)}},{key:"endDragging",value:function(e,t){var o=this;if(_e.info("endDragging ".concat(e.name," : (").concat(t.x,", ").concat(t.y,")")),"mmroot"!==e.type){var r=this.diagramScene.blockLayout,i=this.diagramScene,n=i.diagramStructure,a=n.blockConnections.input.get(e.uid),c=n.blocks.get(a[0].from.blockUid),l=this.diagramScene.diagramStructure.getChildBlocks(e.uid).map((function(e){return o.diagramScene.diagramStructure.blocks.get(e)})),s=r.getBlocks(t);if(s=R.apply(void 0,[s,e].concat(Object(f.a)(l))),Fe.info("found N occupied blocks ".concat(s.length)),s.length>0){var u,d=s[0],h=[e.uid].concat(n.getChildBlocks(e.uid)),y=h.map((function(e){return n.blocks.get(e)}));this.diagramScene.diagramConnections=R(i.diagramConnections,n.blockConnections.input.get(e.uid)[0]),this.diagramScene.diagramBlocks=R.apply(void 0,[this.diagramScene.diagramBlocks].concat(Object(f.a)(y)));var m=i.diagramBlocks.indexOf(d);(u=i.diagramBlocks).splice.apply(u,[m+1,0].concat(Object(f.a)(y))),"mmroot"===d.type?t.x>0?i.diagramConnections.push(new Ke({blockUid:d.uid,slot:"or"},{blockUid:h[0],slot:"i"},"mm")):i.diagramConnections.push(new Ke({blockUid:d.uid,slot:"ol"},{blockUid:h[0],slot:"i"},"mm")):i.diagramConnections.push(new Ke({blockUid:d.uid,slot:"o"},{blockUid:h[0],slot:"i"},"mm")),i.layout(),this.diagramScene.onEdit=!0}else{"mmroot"===c.type&&(t.x>0?a[0].from.slot="or":a[0].from.slot="ol");var g=a[0],b=r.getChildIdx(e.uid,g.from.blockUid,t.y),k=Object(p.a)(b,2),v=k[0],O=k[1];if(Fe.info("Child idx ".concat(O,"[").concat(v,"]")),O.length>0){var S=-1,w=null;v===O.length||(S=O[v],w=i.diagramBlocks[S]);var j=[e.uid].concat(n.getChildBlocks(e.uid)).map((function(e){return n.blocks.get(e)}));if(i.diagramBlocks=R.apply(void 0,[i.diagramBlocks].concat(Object(f.a)(j))),w){var B,x=i.diagramStructure.blockConnections.input.get(w.uid)[0],C=i.diagramConnections.indexOf(x),E=this.diagramScene.diagramConnections.indexOf(g);this.diagramScene.diagramConnections.splice(E,1),this.diagramScene.diagramConnections.splice(C-1,0,g);var D=i.diagramBlocks.indexOf(w);(B=i.diagramBlocks).splice.apply(B,[D,0].concat(Object(f.a)(j)))}else{var P;(P=i.diagramBlocks).push.apply(P,Object(f.a)(j));var z=this.diagramScene.diagramConnections.indexOf(g);this.diagramScene.diagramConnections.splice(z,1),this.diagramScene.diagramConnections.push(g)}}i.layout(),this.diagramScene.onEdit=!0}}}},{key:"render",value:function(){var e=this,t=X.backgroundColor,o=X.strokeColor,r=X.fontColor;return this.diagramScene.selectedBlock&&(this.diagramScene.selectedBlock.style.backgroundColor&&(t=this.diagramScene.selectedBlock.style.backgroundColor),this.diagramScene.selectedBlock.style.strokeColor&&(o=this.diagramScene.selectedBlock.style.strokeColor),this.diagramScene.selectedBlock.style.fontColor&&(r=this.diagramScene.selectedBlock.style.fontColor)),t=U(t),o=U(o),r=U(r),u.a.createElement("div",{ref:this.mainRef,tabIndex:-1,onKeyDown:function(t){e.keyDown(t)}},u.a.createElement("div",null,!this.props.vscode&&u.a.createElement(u.a.Fragment,null,u.a.createElement("button",{onClick:function(t){return e.diagramScene.up()}},"up"),u.a.createElement("button",{onClick:function(t){return e.diagramScene.down()}},"down"),u.a.createElement("button",{onClick:function(t){return e.diagramScene.left()}},"left"),u.a.createElement("button",{onClick:function(t){return e.diagramScene.right()}},"right"),u.a.createElement("button",{onClick:function(t){return e.cancel()}},"cancel"),u.a.createElement("button",{onClick:function(t){return e.diagramScene.edit()}},"edit"),u.a.createElement("button",{onClick:function(t){return e.diagramScene.setStyle({fontSize:36})}},"setStyle")),u.a.createElement(mt,{onChange:this.setStyle,options:["Change style","Default style"].concat(Array.from(this.styles.keys()))}),u.a.createElement(mt,{onChange:this.setFont,options:["Set font size"].concat(this.fontsSizes.map((function(e){return e.toString()})))}),u.a.createElement(mt,{onChange:this.setStrokeWidth,options:["Set stroke width"].concat(this.strokeSize.map((function(e){return e.toString()})))}),u.a.createElement(mt,{onChange:this.setMargin,options:["Set margin"].concat(this.margins.map((function(e){return e.toString()})))}),u.a.createElement("input",{type:"color",value:t,onChange:function(t){return e.diagramScene.setStyle({backgroundColor:t.target.value})}}),u.a.createElement("input",{type:"color",value:o,onChange:function(t){return e.diagramScene.setStyle({strokeColor:t.target.value})}}),u.a.createElement("input",{type:"color",value:r,onChange:function(t){return e.diagramScene.setStyle({fontColor:t.target.value})}})),u.a.createElement(vt,null,u.a.createElement(pt,{scene:this.diagramScene}),u.a.createElement(He,{diagramScene:this.diagramScene})))}}]),t}(u.a.Component),ut=Object(w.a)(st.prototype,"diagramScene",[E.y],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),dt=Object(w.a)(st.prototype,"styles",[E.y],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Map}}),Object(w.a)(st.prototype,"removeBlock",[E.h],Object.getOwnPropertyDescriptor(st.prototype,"removeBlock"),st.prototype),Object(w.a)(st.prototype,"addSibling",[E.h],Object.getOwnPropertyDescriptor(st.prototype,"addSibling"),st.prototype),Object(w.a)(st.prototype,"addBlock",[E.h],Object.getOwnPropertyDescriptor(st.prototype,"addBlock"),st.prototype),Object(w.a)(st.prototype,"cancel",[E.h],Object.getOwnPropertyDescriptor(st.prototype,"cancel"),st.prototype),Object(w.a)(st.prototype,"endDragging",[E.h],Object.getOwnPropertyDescriptor(st.prototype,"endDragging"),st.prototype),lt=st))||lt,St=function e(t){Object(g.a)(this,e),this.image=void 0,this.image=t},wt=function(){console.log("Starting app!!!");var e=new it,t=[];if("undefined"===typeof acquireVsCodeApi){e=nt.fromJSON({root:{name:"Test document",style:{fontSize:24},children:{right:[{name:"one"}]}},defaultStyle:{fontSize:12,fontColor:"#AAAAAA",strokeColor:"#EE0000",strokeWidth:2,borderRepeat:1,rx:10,margin:{bottom:10,top:10,left:10,right:10}}}),t=[{name:"Big font",fontSize:24,hotkey:"ctrl+alt+b"},{name:"Normal font",fontSize:12,hotkey:"ctrl+alt+n"}],console.log(nt.toJSON(e))}if("undefined"!==typeof acquireVsCodeApi){var o=acquireVsCodeApi(),r=o.getState();return u.a.createElement("div",null,u.a.createElement(Ot,{scene:e,jsonDiagram:r,vscode:o,styles:[]}))}return u.a.createElement("div",null,u.a.createElement("input",{type:"file",name:"picField",id:"picField",onChange:function(t){!function(t){if(t.target.files&&t.target.files.length>0){var o=new FileReader;o.onload=function(){var t=new St(o.result);e.diagramBlocks[0].image=t},o.readAsDataURL(t.target.files[0])}}(t)}}),u.a.createElement(Ot,{scene:e,styles:t}))};Boolean("localhost"===window.location.hostname||"[::1]"===window.location.hostname||window.location.hostname.match(/^127(?:\.(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)){3}$/));h.a.render(u.a.createElement(wt,null),document.getElementById("root")),"serviceWorker"in navigator&&navigator.serviceWorker.ready.then((function(e){e.unregister()}))}},[[51,1,2]]]);
//# sourceMappingURL=main.23e1e243.chunk.js.map