(this.webpackJsonpdiagexp1=this.webpackJsonpdiagexp1||[]).push([[0],{49:function(t,e,i){t.exports=i(81)},54:function(t,e,i){},55:function(t,e,i){},81:function(t,e,i){"use strict";i.r(e);var n,o,r,a,c,l,s,u,h,d,m,p,y,g,f=i(0),b=i.n(f),k=i(17),v=i.n(k),O=(i(54),i(55),i(46)),w=i(12),S=i(5),j=i(3),x=i(4),B=i(7),C=i(6),E=i(9),D=i(8),M=i(2),P=(i(14),i(18)),z=i(19),U=i(11),R=Object(U.a)(n=function(t){function e(){return Object(j.a)(this,e),Object(B.a)(this,Object(C.a)(e).apply(this,arguments))}return Object(D.a)(e,t),Object(x.a)(e,[{key:"render",value:function(){var t=this;return b.a.createElement("g",{transform:"translate(".concat(this.props.slot.position.x,",").concat(this.props.slot.position.y,") rotate(0)"),onClick:function(e){return t.onClick(e)}},b.a.createElement("circle",{r:"3",fill:"gray"}))}},{key:"onClick",value:function(t){}}]),e}(b.a.Component))||n,W=i(1),T=Object(U.a)(o=function(t){function e(){var t,i;Object(j.a)(this,e);for(var n=arguments.length,o=new Array(n),r=0;r<n;r++)o[r]=arguments[r];return(i=Object(B.a)(this,(t=Object(C.a)(e)).call.apply(t,[this].concat(o)))).myRef=b.a.createRef(),i}return Object(D.a)(e,t),Object(x.a)(e,[{key:"componentDidMount",value:function(){if(this.myRef.current){var t=this.myRef.current.getBoundingClientRect();this.props.onSize({x:t.width,y:t.height})}}},{key:"componentDidUpdate",value:function(){if(this.myRef.current){var t=this.myRef.current.getBoundingClientRect();this.props.onSize({x:t.width,y:t.height})}}},{key:"render",value:function(){return this.props.block.image?b.a.createElement("image",{width:"100",ref:this.myRef,xlinkHref:this.props.block.image.image}):null}}]),e}(b.a.Component))||o,F=Object(U.a)((a=function(t){function e(t){var i;return Object(j.a)(this,e),i=Object(B.a)(this,Object(C.a)(e).call(this,t)),Object(S.a)(i,"size",c,Object(E.a)(i)),i.myRef=b.a.createRef(),i}return Object(D.a)(e,t),Object(x.a)(e,[{key:"componentDidMount",value:function(){console.log("DID mount",this.props.block.name),this.myRef.current&&this.props.onSize({x:this.myRef.current.getBBox().width,y:this.myRef.current.getBBox().height})}},{key:"render",value:function(){return b.a.createElement("text",{ref:this.myRef,style:{pointerEvents:"none",userSelect:"none"},x:this.props.block.rect.width/2,y:this.props.block.rect.height/2,dominantBaseline:"middle",textAnchor:"middle"},this.props.block.name)}}]),e}(b.a.Component),c=Object(M.a)(a.prototype,"size",[W.m],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return{x:0,y:0}}}),r=a))||r,I=Object(U.a)((s=function(t){function e(t){var i;return Object(j.a)(this,e),i=Object(B.a)(this,Object(C.a)(e).call(this,t)),Object(S.a)(i,"imageSize",u,Object(E.a)(i)),Object(S.a)(i,"textSize",h,Object(E.a)(i)),i.onTextSize=function(t){i.textSize=t,i.updateRequestedSize()},i.onImageSize=function(t){i.imageSize=t,i.updateRequestedSize()},i}return Object(D.a)(e,t),Object(x.a)(e,[{key:"render",value:function(){var t=this;return b.a.createElement("g",{transform:"translate(".concat(this.props.block.rect.x+this.props.block.translate.x,",").concat(this.props.block.rect.y+this.props.block.translate.y,") rotate(0)"),onMouseDown:function(e){return t.onMouseDown(e)},onClick:function(e){return t.onClick(e)},onDoubleClick:function(e){return t.onDoubleClick(e)}},b.a.createElement("rect",{width:this.props.block.rect.width,height:this.props.block.rect.height,fill:"white",style:{stroke:"#006600"},rx:5}),this.props.isSelected&&b.a.createElement("rect",{x:-3,y:-3,width:this.props.block.rect.width+6,height:this.props.block.rect.height+6,fill:"none",style:{stroke:"#0000FF",strokeWidth:2},rx:5}),this.props.isHovered&&b.a.createElement("rect",{x:-3,y:-3,width:this.props.block.rect.width+6,height:this.props.block.rect.height+6,fill:"none",style:{stroke:"#00FF00",strokeWidth:2},rx:5}),"mmroot"===this.props.block.type?b.a.createElement("rect",{x:"3",y:"3",width:this.props.block.rect.width-6,height:this.props.block.rect.height-6,fill:"white",style:{stroke:"#006600"},rx:5}):null,this.props.isEdited?null:b.a.createElement(F,{block:this.props.block,onSize:this.onTextSize}),b.a.createElement(T,{block:this.props.block,onSize:this.onImageSize}),this.props.block.slots.map((function(t){return b.a.createElement(R,{key:t.key,slot:t})})))}},{key:"updateRequestedSize",value:function(){this.props.block.requestedWidth=this.textSize.x+20}},{key:"onMouseDown",value:function(t){this.props.onSelect(this.props.block,{x:t.clientX,y:t.clientY}),t.stopPropagation()}},{key:"onClick",value:function(t){this.props.block.click(),t.stopPropagation()}},{key:"onDoubleClick",value:function(t){this.props.block.doubleClick()}},{key:"fullSize",get:function(){return this.textSize}}]),e}(b.a.Component),u=Object(M.a)(s.prototype,"imageSize",[W.m],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return{x:0,y:0}}}),h=Object(M.a)(s.prototype,"textSize",[W.m],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return{x:0,y:0}}}),Object(M.a)(s.prototype,"fullSize",[W.f],Object.getOwnPropertyDescriptor(s.prototype,"fullSize"),s.prototype),l=s))||l,L=(d=function(){function t(e,i,n,o){Object(j.a)(this,t),Object(S.a)(this,"x",m,this),Object(S.a)(this,"y",p,this),Object(S.a)(this,"width",y,this),Object(S.a)(this,"height",g,this),this.x=e,this.y=i,this.width=n,this.height=o}return Object(x.a)(t,[{key:"contains",value:function(t){return!(t.x<this.x||t.x>this.x+this.width||t.y<this.y||t.y>this.y+this.height)}}],[{key:"copy",value:function(e){return new t(e.x,e.y,e.width,e.height)}}]),t}(),m=Object(M.a)(d.prototype,"x",[W.m],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),p=Object(M.a)(d.prototype,"y",[W.m],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),y=Object(M.a)(d.prototype,"width",[W.m],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),g=Object(M.a)(d.prototype,"height",[W.m],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),d),q=function(){function t(){Object(j.a)(this,t),this.map=new Map}return Object(x.a)(t,[{key:"push",value:function(t,e){var i=this.map.get(t)||[];i.push(e),this.map.set(t,i)}},{key:"get",value:function(t){return this.map.get(t)||[]}},{key:"empty",value:function(t){return 0===this.get(t).length}},{key:"keys",value:function(){return this.map.keys()}}]),t}();function H(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(t){var e=16*Math.random()|0;return("x"===t?e:3&e|8).toString(16)}))}function J(t){for(var e=arguments.length,i=new Array(e>1?e-1:0),n=1;n<e;n++)i[n-1]=arguments[n];for(var o=0,r=i;o<r.length;o++){var a=r[o],c=t.indexOf(a);-1!==c&&t.splice(c,1)}return t}function A(t){return Math.sqrt(t.x*t.x+t.y*t.y)}var _,K=function(t){function e(){return Object(j.a)(this,e),Object(B.a)(this,Object(C.a)(e).apply(this,arguments))}return Object(D.a)(e,t),Object(x.a)(e,[{key:"render",value:function(){return b.a.createElement("g",null,b.a.createElement("g",{id:"g3979",transform:"translate(-0.10620686,-0.56696429)"},b.a.createElement("rect",{ry:"1.0444876",y:"-9.3742828",x:"-9.8492556",height:"19.63636",width:"19.425177",id:"rect3942",style:{fill:"white",stroke:"#000000",strokeWidth:"1"}}),b.a.createElement("path",{id:"rect3944",d:"m -3.3174074,-7.0890472 c -0.5786464,0 -1.0443792,0.4657354 -1.0443792,1.0443818 v 2.1626565 h -2.1626592 c -0.5786464,0 -1.0443818,0.4657355 -1.0443818,1.0443819 v 6.7313729 c 0,0.5786438 0.4657354,1.0443792 1.0443818,1.0443792 h 2.1626592 v 2.1626592 c 0,0.5786464 0.4657328,1.0443792 1.0443792,1.0443792 h 6.7313729 c 0.5786464,0 1.0443819,-0.4657328 1.0443819,-1.0443792 V 4.9381251 h 2.1626565 c 0.5786464,0 1.0443818,-0.4657354 1.0443818,-1.0443792 V -2.837627 c 0,-0.5786464 -0.4657354,-1.0443819 -1.0443818,-1.0443819 H 4.4583474 v -2.1626565 c 0,-0.5786464 -0.4657355,-1.0443818 -1.0443819,-1.0443818 z",style:{fill:"purple",stroke:"#000000",strokeWidth:"1"}})))}}]),e}(b.a.Component),X=function(t){function e(){return Object(j.a)(this,e),Object(B.a)(this,Object(C.a)(e).apply(this,arguments))}return Object(D.a)(e,t),Object(x.a)(e,[{key:"render",value:function(){return b.a.createElement("g",null,b.a.createElement("g",{id:"g3979",transform:"translate(-0.10620686,-0.56696429)"},b.a.createElement("rect",{ry:"1.0444876",y:"-9.3742828",x:"-9.8492556",height:"19.63636",width:"19.425177",id:"rect3942",style:{fill:"white",stroke:"#000000",strokeWidth:"1"}}),b.a.createElement("rect",{style:{fill:"white",stroke:"#000000",strokeWidth:"1"},id:"rect4021",width:"15.485204",height:"8.2242823",x:"-7.7426019",y:"-4.1617403",ry:"0.98811853"})))}}]),e}(b.a.Component),Y=function(t){function e(){return Object(j.a)(this,e),Object(B.a)(this,Object(C.a)(e).apply(this,arguments))}return Object(D.a)(e,t),Object(x.a)(e,[{key:"render",value:function(){var t=this,e=b.a.createElement("rect",{width:10,height:10,fill:this.props.button.color});switch(this.props.button.icon){case"add":e=b.a.createElement(K,null);break;case"remove":e=b.a.createElement(X,null)}return b.a.createElement("g",{transform:"translate(".concat(this.props.button.position.x,",").concat(this.props.button.position.y,") rotate(0)"),onClick:function(e){return t.onClick(e)}},e)}},{key:"onClick",value:function(t){this.props.button.click()}}]),e}(b.a.Component),N=Object(U.a)(_=function(t){function e(){return Object(j.a)(this,e),Object(B.a)(this,Object(C.a)(e).apply(this,arguments))}return Object(D.a)(e,t),Object(x.a)(e,[{key:"render",value:function(){var t=this.props.connection.fromPoint.x,e=this.props.connection.fromPoint.y,i=this.props.connection.toPoint.x,n=this.props.connection.toPoint.y;return b.a.createElement("path",{style:{stroke:"rgb(255,0,0)",strokeWidth:"2",fill:"none"},d:"M ".concat(t," ").concat(e," C ").concat(i," ").concat(e," ").concat(t," ").concat(n," ").concat(i," ").concat(n)})}}]),e}(b.a.Component))||_,V=i(15);V.CategoryServiceFactory.setDefaultConfiguration(new V.CategoryConfiguration(V.LogLevel.Info));var $,G,Q,Z,tt,et,it,nt,ot,rt,at,ct,lt,st,ut,ht,dt,mt,pt,yt,gt,ft,bt,kt,vt,Ot,wt,St,jt,xt,Bt,Ct,Et,Dt,Mt=new V.Category("mindMap"),Pt=new V.Category("draging",Mt),zt=new V.Category("diagramBlockLayout",Mt),Ut=new V.Category("DiagramSceneComponent"),Rt=Object(U.a)((G=function(t){function e(){var t,i;Object(j.a)(this,e);for(var n=arguments.length,o=new Array(n),r=0;r<n;r++)o[r]=arguments[r];return(i=Object(B.a)(this,(t=Object(C.a)(e)).call.apply(t,[this].concat(o)))).x0=0,i.y0=0,i.mouseDownPos=void 0,i.selectionBlock=void 0,Object(S.a)(i,"hoverBlock",Q,Object(E.a)(i)),i.myRef=b.a.createRef(),i}return Object(D.a)(e,t),Object(x.a)(e,[{key:"componentDidMount",value:function(){if(this.myRef.current){console.log("changing scene translaote");var t=this.myRef.current.getBoundingClientRect().width/2,e=this.myRef.current.getBoundingClientRect().height/2;this.props.diagramScene.sceneTranslate.x=t,this.props.diagramScene.sceneTranslate.y=e,console.log(t,e),this.x0=this.myRef.current.getBoundingClientRect().left,this.y0=this.myRef.current.getBoundingClientRect().top}}},{key:"render",value:function(){var t=this,e=this.props.diagramScene.sceneTranslate.x+this.props.diagramScene.sceneTranslateDelta.x,i=this.props.diagramScene.sceneTranslate.y+this.props.diagramScene.sceneTranslateDelta.y;return b.a.createElement("svg",{ref:this.myRef,width:"100%",height:"100%",xmlns:"http://www.w3.org/2000/svg",xmlnsXlink:"http://www.w3.org/1999/xlink",onMouseDown:function(e){return t.onMouseDown(e)},onMouseMove:function(e){return t.onMouseMove(e)},onMouseUp:function(e){return t.onMouseUp(e)},onClick:function(e){return t.onClick(e)}},b.a.createElement("g",{transform:"translate(".concat(e,",").concat(i,")")},this.props.diagramScene.diagramBlocks.map((function(e){return b.a.createElement(I,{key:e.uid,block:e,isSelected:t.props.diagramScene.selectedBlock===e,isHovered:t.hoverBlock===e,isEdited:t.props.diagramScene.editedBlock===e,onSelect:function(e,i){return t.onSelect(e,i)}})})),this.props.diagramScene.diagramConnections.map((function(t){return b.a.createElement(N,{key:t.uid,connection:t})})),this.props.diagramScene.activeButtons.map((function(t){return b.a.createElement(Y,{key:t.uid,button:t})}))))}},{key:"onSelect",value:function(t,e){this.mouseDownPos=this.clientToScene(e),this.selectionBlock=t,this.props.diagramScene.selectedBlock=t,this.props.diagramScene.setEditedBlock(void 0)}},{key:"onMouseDown",value:function(t){Ut.info("onMouseDown"),this.props.diagramScene.editedBlock&&(this.props.diagramScene.setEditedBlock(void 0),this.props.diagramScene.onEdit=!0),this.mouseDownPos=this.clientToScene({x:t.pageX,y:t.pageY})}},{key:"onMouseMove",value:function(t){if(this.mouseDownPos&&this.selectionBlock){Ut.info("onMouseMove block");var e=this.clientToScene({x:t.pageX,y:t.pageY});this.selectionBlock.translate={x:e.x-this.mouseDownPos.x,y:e.y-this.mouseDownPos.y},this.props.diagramScene.activeButtons=[],this.hoverBlock=void 0;var i=!0,n=!1,o=void 0;try{for(var r,a=this.props.diagramScene.diagramBlocks[Symbol.iterator]();!(i=(r=a.next()).done);i=!0){var c=r.value;if(c!=this.selectionBlock)c.rect.contains(e)&&(this.hoverBlock=c)}}catch(h){n=!0,o=h}finally{try{i||null==a.return||a.return()}finally{if(n)throw o}}}else if(this.mouseDownPos){Ut.info("onMouseMove scene");var l=this.clientToScene({x:t.pageX,y:t.pageY}),s=l.x-this.mouseDownPos.x,u=l.y-this.mouseDownPos.y;A({x:s,y:u})>40&&(this.props.diagramScene.sceneTranslateDelta={x:s,y:u})}}},{key:"onMouseUp",value:function(t){if(Ut.info("onMouseUp"),this.hoverBlock=void 0,this.selectionBlock&&this.mouseDownPos){var e=this.clientToScene({x:t.pageX,y:t.pageY});if(A({x:e.x-this.mouseDownPos.x,y:e.y-this.mouseDownPos.y})>20){var i={x:this.selectionBlock.rect.x+e.x-this.mouseDownPos.x,y:this.selectionBlock.rect.y+e.y-this.mouseDownPos.y};this.selectionBlock.setPosition(i),this.selectionBlock.dragEnd(e)}else this.selectionBlock.translate={x:0,y:0};this.selectionBlock=void 0,this.mouseDownPos=void 0}else if(this.mouseDownPos){var n=this.clientToScene({x:t.pageX,y:t.pageY}),o=n.x-this.mouseDownPos.x,r=n.y-this.mouseDownPos.y;A({x:o,y:r})>40&&(this.props.diagramScene.sceneTranslate.x+=o,this.props.diagramScene.sceneTranslate.y+=r),this.props.diagramScene.sceneTranslateDelta={x:0,y:0},this.mouseDownPos=void 0}}},{key:"clientToScene",value:function(t){return{x:t.x-this.props.diagramScene.sceneTranslate.x-this.x0,y:t.y-this.props.diagramScene.sceneTranslate.y-this.y0}}},{key:"onClick",value:function(t){this.props.diagramScene.activeButtons=[]}}]),e}(b.a.Component),Q=Object(M.a)(G.prototype,"hoverBlock",[W.m],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),Object(M.a)(G.prototype,"onMouseDown",[W.d],Object.getOwnPropertyDescriptor(G.prototype,"onMouseDown"),G.prototype),Object(M.a)(G.prototype,"onMouseMove",[W.d],Object.getOwnPropertyDescriptor(G.prototype,"onMouseMove"),G.prototype),Object(M.a)(G.prototype,"onMouseUp",[W.d],Object.getOwnPropertyDescriptor(G.prototype,"onMouseUp"),G.prototype),$=G))||$,Wt=(Z=function(t){function e(t,i,n,o,r,a){var c;return Object(j.a)(this,e),(c=Object(B.a)(this,Object(C.a)(e).call(this))).uid=void 0,Object(S.a)(c,"name",tt,Object(E.a)(c)),c.type=void 0,Object(S.a)(c,"rect",et,Object(E.a)(c)),Object(S.a)(c,"translate",it,Object(E.a)(c)),Object(S.a)(c,"slots",nt,Object(E.a)(c)),Object(S.a)(c,"debugIdx",ot,Object(E.a)(c)),Object(S.a)(c,"finishedEditing",rt,Object(E.a)(c)),Object(S.a)(c,"requestedWidth",at,Object(E.a)(c)),Object(S.a)(c,"image",ct,Object(E.a)(c)),Object(S.a)(c,"imageUrl",lt,Object(E.a)(c)),c.uid=t,c.name=i,c.type=n,c.slots=o,c.rect=r,c.debugIdx=0,c.translate={x:0,y:0},c.image=a,c}return Object(D.a)(e,t),Object(x.a)(e,[{key:"setPosition",value:function(t){this.translate={x:0,y:0},this.rect.x=t.x,this.rect.y=t.y,this.fireChangeRect(this)}},{key:"click",value:function(){this.fireClick(this)}},{key:"doubleClick",value:function(){this.fireDoubleClick(this)}},{key:"dragEnd",value:function(t){this.fireDragEnd(this,t)}},{key:"name2slot",get:function(){var t=new Map,e=!0,i=!1,n=void 0;try{for(var o,r=this.slots[Symbol.iterator]();!(e=(o=r.next()).done);e=!0){var a=o.value;t.set(a.name,a)}}catch(c){i=!0,n=c}finally{try{e||null==r.return||r.return()}finally{if(i)throw n}}return t}}]),e}(function(){function t(){Object(j.a)(this,t),this.clickCallbacks=[],this.doubleClickCallbacks=[],this.changeRectCallbacks=[],this.dragEndCallbacks=[]}return Object(x.a)(t,[{key:"on",value:function(t,e){switch(t){case"click":this.clickCallbacks.push(e);break;case"doubleClick":this.doubleClickCallbacks.push(e);break;case"changeRect":this.changeRectCallbacks.push(e);break;case"dragEnd":this.dragEndCallbacks.push(e)}}},{key:"fireClick",value:function(t){var e=!0,i=!1,n=void 0;try{for(var o,r=this.clickCallbacks[Symbol.iterator]();!(e=(o=r.next()).done);e=!0){(0,o.value)(t)}}catch(a){i=!0,n=a}finally{try{e||null==r.return||r.return()}finally{if(i)throw n}}}},{key:"fireDoubleClick",value:function(t){var e=!0,i=!1,n=void 0;try{for(var o,r=this.doubleClickCallbacks[Symbol.iterator]();!(e=(o=r.next()).done);e=!0){(0,o.value)(t)}}catch(a){i=!0,n=a}finally{try{e||null==r.return||r.return()}finally{if(i)throw n}}}},{key:"fireChangeRect",value:function(t){var e=!0,i=!1,n=void 0;try{for(var o,r=this.changeRectCallbacks[Symbol.iterator]();!(e=(o=r.next()).done);e=!0){(0,o.value)(t)}}catch(a){i=!0,n=a}finally{try{e||null==r.return||r.return()}finally{if(i)throw n}}}},{key:"fireDragEnd",value:function(t,e){var i=!0,n=!1,o=void 0;try{for(var r,a=this.dragEndCallbacks[Symbol.iterator]();!(i=(r=a.next()).done);i=!0){(0,r.value)(t,e)}}catch(c){n=!0,o=c}finally{try{i||null==a.return||a.return()}finally{if(n)throw o}}}}]),t}()),tt=Object(M.a)(Z.prototype,"name",[W.m],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),et=Object(M.a)(Z.prototype,"rect",[W.m],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),it=Object(M.a)(Z.prototype,"translate",[W.m],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),nt=Object(M.a)(Z.prototype,"slots",[W.m],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),ot=Object(M.a)(Z.prototype,"debugIdx",[W.m],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),rt=Object(M.a)(Z.prototype,"finishedEditing",[W.m],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),at=Object(M.a)(Z.prototype,"requestedWidth",[W.m],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),ct=Object(M.a)(Z.prototype,"image",[W.m],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),lt=Object(M.a)(Z.prototype,"imageUrl",[W.m],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),Object(M.a)(Z.prototype,"setPosition",[W.d],Object.getOwnPropertyDescriptor(Z.prototype,"setPosition"),Z.prototype),Object(M.a)(Z.prototype,"name2slot",[W.f],Object.getOwnPropertyDescriptor(Z.prototype,"name2slot"),Z.prototype),Z),Tt=function(){function t(e,i,n,o,r){Object(j.a)(this,t),this.uid=e,this.positionHint=i,this.icon=n,this.color=o,this.position={x:0,y:0},this.clickCallbacks=[],r&&this.on("click",r)}return Object(x.a)(t,[{key:"click",value:function(){var t=!0,e=!1,i=void 0;try{for(var n,o=this.clickCallbacks[Symbol.iterator]();!(t=(n=o.next()).done);t=!0){(0,n.value)()}}catch(r){e=!0,i=r}finally{try{t||null==o.return||o.return()}finally{if(e)throw i}}}},{key:"on",value:function(t,e){this.clickCallbacks.push(e)}}]),t}(),Ft=(st=function(){function t(e,i,n){Object(j.a)(this,t),this.from=e,this.to=i,this.type=n,Object(S.a)(this,"fromPoint",ut,this),Object(S.a)(this,"toPoint",ht,this),this.fromPoint={x:0,y:0},this.toPoint={x:0,y:0}}return Object(x.a)(t,[{key:"uid",get:function(){return"".concat(this.from.blockUid,":").concat(this.from.slot,":").concat(this.to.blockUid,":").concat(this.to.slot)}}]),t}(),ut=Object(M.a)(st.prototype,"fromPoint",[W.m],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),ht=Object(M.a)(st.prototype,"toPoint",[W.m],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),st),It=(dt=function(){function t(e,i){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{x:0,y:0};Object(j.a)(this,t),this.name=e,this.type=i,Object(S.a)(this,"position",mt,this),this.position=n}return Object(x.a)(t,[{key:"key",get:function(){return this.name}}]),t}(),mt=Object(M.a)(dt.prototype,"position",[W.m],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),dt),Lt=function(){function t(){Object(j.a)(this,t)}return Object(x.a)(t,[{key:"layoutBlockButtons",value:function(t,e){var i=new q,n=!0,o=!1,r=void 0;try{for(var a,c=e[Symbol.iterator]();!(n=(a=c.next()).done);n=!0){var l=a.value;i.push(l.positionHint,l)}}catch(f){o=!0,r=f}finally{try{n||null==c.return||c.return()}finally{if(o)throw r}}var s=t.rect,u=s.x+s.width-10,h=s.y-10-4,d=!0,m=!1,p=void 0;try{for(var y,g=i.get("topRight")[Symbol.iterator]();!(d=(y=g.next()).done);d=!0){y.value.position={x:u,y:h},u-=24}}catch(f){m=!0,p=f}finally{try{d||null==g.return||g.return()}finally{if(m)throw p}}}}]),t}(),qt=(pt=function(){function t(e){Object(j.a)(this,t),this.scene=e}return Object(x.a)(t,[{key:"getOutputSlotConnections",value:function(t,e){return this.blockConnections.output.get(t).filter((function(t){return t.from.slot===e}))}},{key:"getInputSlotConnections",value:function(t,e){return this.blockConnections.input.get(t).filter((function(t){return t.to.slot===e}))}},{key:"getChildBlocks",value:function(t){var e=[],i=!0,n=!1,o=void 0;try{for(var r,a=this.blockConnections.output.get(t)[Symbol.iterator]();!(i=(r=a.next()).done);i=!0){var c=r.value;e.push(c.to.blockUid),e.push.apply(e,Object(w.a)(this.getChildBlocks(c.to.blockUid)))}}catch(l){n=!0,o=l}finally{try{i||null==a.return||a.return()}finally{if(n)throw o}}return e}},{key:"blocks",get:function(){var t=new Map,e=!0,i=!1,n=void 0;try{for(var o,r=this.scene.diagramBlocks[Symbol.iterator]();!(e=(o=r.next()).done);e=!0){var a=o.value;t.set(a.uid,a)}}catch(c){i=!0,n=c}finally{try{e||null==r.return||r.return()}finally{if(i)throw n}}return t}},{key:"blockConnections",get:function(){var t=new q,e=new q,i=!0,n=!1,o=void 0;try{for(var r,a=this.scene.diagramConnections[Symbol.iterator]();!(i=(r=a.next()).done);i=!0){var c=r.value;t.push(c.to.blockUid,c),e.push(c.from.blockUid,c)}}catch(l){n=!0,o=l}finally{try{i||null==a.return||a.return()}finally{if(n)throw o}}return{input:t,output:e}}}]),t}(),Object(M.a)(pt.prototype,"blocks",[W.f],Object.getOwnPropertyDescriptor(pt.prototype,"blocks"),pt.prototype),Object(M.a)(pt.prototype,"blockConnections",[W.f],Object.getOwnPropertyDescriptor(pt.prototype,"blockConnections"),pt.prototype),pt),Ht=(yt=function(){function t(e){Object(j.a)(this,t),this.diagramStructure=e}return Object(x.a)(t,[{key:"layout",value:function(){var t=this.diagramStructure.scene.diagramBlocks[0];if("mmroot"!==t.type)throw new Error("Invalid diagram structure");t.slots[0].position={x:0,y:t.rect.height/2},t.slots[1].position={x:t.rect.width,y:t.rect.height/2};var e=this.diagramStructure.getOutputSlotConnections(t.uid,"or"),i=[],n=!0,o=!1,r=void 0;try{for(var a,c=e[Symbol.iterator]();!(n=(a=c.next()).done);n=!0){var l=a.value;i.push(l.to.blockUid),i.push.apply(i,Object(w.a)(this.diagramStructure.getChildBlocks(l.to.blockUid)))}}catch(B){o=!0,r=B}finally{try{n||null==c.return||c.return()}finally{if(o)throw r}}var s=this.diagramStructure.getOutputSlotConnections(t.uid,"ol"),u=[],h=!0,d=!1,m=void 0;try{for(var p,y=s[Symbol.iterator]();!(h=(p=y.next()).done);h=!0){var g=p.value;u.push(g.to.blockUid),u.push.apply(u,Object(w.a)(this.diagramStructure.getChildBlocks(g.to.blockUid)))}}catch(B){d=!0,m=B}finally{try{h||null==y.return||y.return()}finally{if(d)throw m}}for(var f=0,b=i;f<b.length;f++){var k=b[f],v=this.diagramStructure.blocks.get(k);v.slots[0].position={x:0,y:v.rect.height/2},v.slots[1].position={x:v.rect.width,y:v.rect.height/2}}for(var O=0,S=u;O<S.length;O++){var j=S[O],x=this.diagramStructure.blocks.get(j);x.slots[0].position={x:x.rect.width,y:x.rect.height/2},x.slots[1].position={x:0,y:x.rect.height/2}}}}]),t}(),Object(M.a)(yt.prototype,"layout",[W.d],Object.getOwnPropertyDescriptor(yt.prototype,"layout"),yt.prototype),yt),Jt=function(){function t(e){Object(j.a)(this,t),this.diagramStructure=e,this.disposers=[]}return Object(x.a)(t,[{key:"layout",value:function(){var t=this,e=!0,i=!1,n=void 0;try{for(var o,r=this.disposers[Symbol.iterator]();!(e=(o=r.next()).done);e=!0){(0,o.value)()}}catch(d){i=!0,n=d}finally{try{e||null==r.return||r.return()}finally{if(i)throw n}}var a=!0,c=!1,l=void 0;try{for(var s,u=function(){var e=s.value,i=t.diagramStructure.blocks.get(e.from.blockUid),n=t.diagramStructure.blocks.get(e.to.blockUid);t.disposers.push(Object(W.e)((function(){return t.setConnectionPosition(e,i,n)}),{delay:30}))},h=this.diagramStructure.scene.diagramConnections[Symbol.iterator]();!(a=(s=h.next()).done);a=!0)u()}catch(d){c=!0,l=d}finally{try{a||null==h.return||h.return()}finally{if(c)throw l}}}},{key:"setConnectionPosition",value:function(t,e,i){var n=e.name2slot.get(t.from.slot).position,o=i.name2slot.get(t.to.slot).position;t.fromPoint={x:n.x+e.rect.x+e.translate.x,y:n.y+e.rect.y+e.translate.y},t.toPoint={x:o.x+i.rect.x+i.translate.x,y:o.y+i.rect.y+i.translate.y}}}]),t}(),At={hMargin:30,vMargin:10},_t=function(){function t(e){var i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:At;Object(j.a)(this,t),this.diagramStructure=e,this.parameters=i,this.blockColumns=new Map,this.columnBlocks=new q,this.childShift=new Map,this.blockHeight=new Map,this.blockChildWidth=new Map,this.columnWidth=new Map,this.columnCenter=new Map,this.blockPosition=new Map}return Object(x.a)(t,[{key:"layoutColumns",value:function(){if(!this.diagramStructure)throw new Error("Diagram data not defined");var t=this.diagramStructure.scene.diagramBlocks;this.blockColumns=new Map,this.columnBlocks=new q;for(var e=this.diagramStructure.blockConnections.input,i=0;i<t.length;++i)if(0===i){if(this.blockColumns.set(t[i].uid,0),this.columnBlocks.push(i,t[i].uid),!e.empty(t[i].uid))throw new Error("Invalid mm diagram blocks structure (first block must be root block - no input connections)")}else{var n=e.get(t[i].uid);if(1!==n.length)throw new Error("Invalid mm diagram blocks structure (each block except root must have exactly one input connection )");var o=this.blockColumns.get(n[0].from.blockUid);if(void 0===o)throw new Error("Invalid mm diagram blocks structure (parent block must preceed child block)");var r=o;0===r?"or"===n[0].from.slot?r+=1:r-=1:r>0?r+=1:r<0&&(r-=1),this.blockColumns.set(t[i].uid,r),this.columnBlocks.push(r,t[i].uid)}}},{key:"layout",value:function(){var t=this.diagramStructure.blockConnections,e=t.input,i=t.output;this.layoutColumns();for(var n=Array.from(this.columnBlocks.keys()).sort((function(t,e){return t-e})),o=n[0],r=n[n.length-1],a=o;a<=r;++a){var c=0,l=!0,s=!1,u=void 0;try{for(var h,d=this.columnBlocks.get(a)[Symbol.iterator]();!(l=(h=d.next()).done);l=!0){var m=h.value;c=Math.max(c,this.diagramStructure.blocks.get(m).rect.width)}}catch(W){s=!0,u=W}finally{try{l||null==d.return||d.return()}finally{if(s)throw u}}this.columnWidth.set(a,c)}var p=0;this.columnCenter.set(0,0);for(var y=1;y<=r;++y){var g=this.columnWidth.get(y-1),f=this.columnWidth.get(y);p=p+g/2+this.parameters.hMargin+f/2,this.columnCenter.set(y,p)}p=0;for(var b=-1;b>=o;--b){var k=this.columnWidth.get(b+1),v=this.columnWidth.get(b);p=p-k/2-this.parameters.hMargin-v/2,this.columnCenter.set(b,p)}var O=this.diagramStructure.scene.diagramBlocks[0];if(e.get(O.uid).length>0)throw new Error("Invalid diagram structure, root block has input connections");var w=!0,S=!1,j=void 0;try{for(var x,B=i.get(O.uid)[Symbol.iterator]();!(w=(x=B.next()).done);w=!0){var C=x.value;this.updateChildHeight(C.to.blockUid)}}catch(W){S=!0,j=W}finally{try{w||null==B.return||B.return()}finally{if(S)throw j}}this.blockPosition.set(O.uid,{x:0,y:0}),this.updateChildPositions(1,this.columnBlocks.get(1),{x:0,y:0}),this.updateChildPositions(-1,this.columnBlocks.get(-1),{x:0,y:0});var E=!0,D=!1,M=void 0;try{for(var P,z=this.diagramStructure.scene.diagramBlocks[Symbol.iterator]();!(E=(P=z.next()).done);E=!0){var U=P.value,R=this.blockPosition.get(U.uid);U.rect=new L(R.x-U.rect.width/2,R.y-U.rect.height/2,U.rect.width,U.rect.height)}}catch(W){D=!0,M=W}finally{try{E||null==z.return||z.return()}finally{if(D)throw M}}}},{key:"updateChildPositions",value:function(t,e,i){if(!this.diagramStructure)throw new Error("Diagram data not defined");var n=0,o=!0,r=!1,a=void 0;try{for(var c,l=e[Symbol.iterator]();!(o=(c=l.next()).done);o=!0){var s=c.value;n+=this.blockHeight.get(s)}}catch(O){r=!0,a=O}finally{try{o||null==l.return||l.return()}finally{if(r)throw a}}n+=(e.length-1)*this.parameters.vMargin;var u=i.y-n/2,h=this.columnCenter.get(t);t>0?t+=1:t-=1;var d=!0,m=!1,p=void 0;try{for(var y,g=e[Symbol.iterator]();!(d=(y=g.next()).done);d=!0){var f=y.value,b=this.blockHeight.get(f),k={x:h,y:u+b/2};this.blockPosition.set(f,k);var v=this.diagramStructure.blockConnections.output.get(f).map((function(t){return t.to.blockUid}));this.updateChildPositions(t,v,k),u+=b+this.parameters.vMargin}}catch(O){m=!0,p=O}finally{try{d||null==g.return||g.return()}finally{if(m)throw p}}}},{key:"updateChildHeight",value:function(t){var e=this.diagramStructure.blocks.get(t),i=this.diagramStructure.blockConnections.output.get(t),n=0,o=!0,r=!1,a=void 0;try{for(var c,l=i[Symbol.iterator]();!(o=(c=l.next()).done);o=!0){var s=c.value;n+=this.updateChildHeight(s.to.blockUid)}}catch(h){r=!0,a=h}finally{try{o||null==l.return||l.return()}finally{if(r)throw a}}n+=this.parameters.vMargin*(i.length-1);var u=Math.max(n,e.rect.height);return this.blockHeight.set(t,u),u}},{key:"getBlockColumn",value:function(t){return this.blockColumns.get(t)}},{key:"getBlocks",value:function(t){var e=[],i=!0,n=!1,o=void 0;try{for(var r,a=this.diagramStructure.scene.diagramBlocks[Symbol.iterator]();!(i=(r=a.next()).done);i=!0){var c=r.value,l=c.rect;t.x>l.x&&t.x<l.x+l.width&&t.y>l.y&&t.y<l.y+l.height&&e.push(c)}}catch(s){n=!0,o=s}finally{try{i||null==a.return||a.return()}finally{if(n)throw o}}return e}},{key:"getChildIdx",value:function(t,e,i){var n=this;if(!this.diagramStructure)throw new Error("Diagram data not defined");var o=[],r=this.diagramStructure.blockConnections.output,a=!0,c=!1,l=void 0;try{for(var s,u=r.get(e)[Symbol.iterator]();!(a=(s=u.next()).done);a=!0){var h=s.value;o.push(h.to.blockUid)}}catch(w){c=!0,l=w}finally{try{a||null==u.return||u.return()}finally{if(c)throw l}}o=o.filter((function(e){return t!==e})),zt.info("Found child uids ".concat(o));var d=o.map((function(t){return n.diagramStructure.blocks.get(t)})).map((function(t){return n.diagramStructure.scene.diagramBlocks.indexOf(t)})).sort((function(t,e){return t-e})),m=d.map((function(t){return[t,n.diagramStructure.scene.diagramBlocks[t].rect.y,n.diagramStructure.scene.diagramBlocks[t].rect.height]}));zt.info((function(){return"getChildIdx block rects ".concat(m)}));var p=0,y=!0,g=!1,f=void 0;try{for(var b,k=d[Symbol.iterator]();!(y=(b=k.next()).done);y=!0){var v=b.value,O=this.diagramStructure.scene.diagramBlocks[v].rect;if(i<O.y+O.height/2)break;p++}}catch(w){g=!0,f=w}finally{try{y||null==k.return||k.return()}finally{if(g)throw f}}return[p,d]}},{key:"getColumnIdx",value:function(t){var e=Math.max.apply(Math,Object(w.a)(Array.from(this.columnWidth.keys()))),i=Math.min.apply(Math,Object(w.a)(Array.from(this.columnWidth.keys()))),n=-this.columnWidth.get(0)/2;if(t>=n){for(var o=0;o<=e;++o){if(t<(n+=this.columnWidth.get(o)))return o;n+=this.parameters.hMargin}return null}for(var r=-1;r>=i;--r){if(t>(n-=this.columnWidth.get(r)))return r;n-=this.parameters.hMargin}return null}}]),t}(),Kt=(gt=function(){function t(){var e=this,i=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];Object(j.a)(this,t),Object(S.a)(this,"diagramBlocks",ft,this),Object(S.a)(this,"diagramConnections",bt,this),Object(S.a)(this,"activeButtons",kt,this),Object(S.a)(this,"_editedBlock",vt,this),Object(S.a)(this,"selectedBlock",Ot,this),Object(S.a)(this,"onEdit",wt,this),Object(S.a)(this,"structureChanging",St,this),Object(S.a)(this,"sceneTranslate",jt,this),Object(S.a)(this,"sceneTranslateDelta",xt,this),Object(S.a)(this,"image",Bt,this),this.diagramStructure=void 0,this.buttonLayout=new Lt,this.slotLayout=void 0,this.blockLayout=void 0,this.connectionLayout=void 0,this.oldEditedBlock=void 0,this.diagramBlocks=i,this.diagramConnections=n,this.diagramStructure=new qt(this),this.slotLayout=new Ht(this.diagramStructure),this.blockLayout=new _t(this.diagramStructure),this.connectionLayout=new Jt(this.diagramStructure),Object(W.e)((function(){var t=!1,i=!0,n=!1,o=void 0;try{for(var r,a=e.diagramBlocks[Symbol.iterator]();!(i=(r=a.next()).done);i=!0){var c=r.value;c.requestedWidth&&c.finishedEditing&&c.rect.width!=c.requestedWidth&&(c.rect.width=c.requestedWidth,t=!0)}}catch(l){n=!0,o=l}finally{try{i||null==a.return||a.return()}finally{if(n)throw o}}t&&e.layout()}),{name:"asd"})}return Object(x.a)(t,[{key:"setEditedBlock",value:function(t){this._editedBlock&&this._editedBlock.requestedWidth&&this._editedBlock.requestedWidth!=this._editedBlock.rect.width&&(this._editedBlock.finishedEditing=!0),this._editedBlock=t}},{key:"showBlockButtons",value:function(t,e){var i=this;this.buttonLayout.layoutBlockButtons(t,e),this.activeButtons=e;var n=!0,o=!1,r=void 0;try{for(var a,c=e[Symbol.iterator]();!(n=(a=c.next()).done);n=!0){a.value.on("click",(function(){i.activeButtons=[]}))}}catch(l){o=!0,r=l}finally{try{n||null==c.return||c.return()}finally{if(o)throw r}}}},{key:"layout",value:function(){this.diagramBlocks.length>0&&(this.slotLayout.layout(),this.blockLayout.layout(),this.connectionLayout.layout())}},{key:"editedBlock",get:function(){return this._editedBlock}}]),t}(),ft=Object(M.a)(gt.prototype,"diagramBlocks",[W.m],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),bt=Object(M.a)(gt.prototype,"diagramConnections",[W.m],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),kt=Object(M.a)(gt.prototype,"activeButtons",[W.m],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),vt=Object(M.a)(gt.prototype,"_editedBlock",[W.m],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),Ot=Object(M.a)(gt.prototype,"selectedBlock",[W.m],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),wt=Object(M.a)(gt.prototype,"onEdit",[W.m],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),St=Object(M.a)(gt.prototype,"structureChanging",[W.m],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),jt=Object(M.a)(gt.prototype,"sceneTranslate",[W.m],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return{x:512,y:500}}}),xt=Object(M.a)(gt.prototype,"sceneTranslateDelta",[W.m],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return{x:0,y:0}}}),Bt=Object(M.a)(gt.prototype,"image",[W.m],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),Object(M.a)(gt.prototype,"editedBlock",[W.f],Object.getOwnPropertyDescriptor(gt.prototype,"editedBlock"),gt.prototype),Object(M.a)(gt.prototype,"layout",[W.d],Object.getOwnPropertyDescriptor(gt.prototype,"layout"),gt.prototype),gt),Xt=function(){function t(){Object(j.a)(this,t)}return Object(x.a)(t,null,[{key:"fromJSON",value:function(t){var e=new Kt,i=new Wt(H(),t.root.name,"mmroot",[new It("ol","o"),new It("or","o")],new L(0,0,200,30));return e.diagramBlocks.push(i),t.root.children&&t.root.children.left&&this.addChildBlocksFromJson(t.root.children.left,e,i,!0),t.root.children&&t.root.children.right&&this.addChildBlocksFromJson(t.root.children.right,e,i,!1),e}},{key:"addChildBlocksFromJson",value:function(t,e,i,n){var o=!0,r=!1,a=void 0;try{for(var c,l=t[Symbol.iterator]();!(o=(c=l.next()).done);o=!0){var s=c.value,u=new Wt(H(),s.name,"mm",[new It("i","i"),new It("o","o")],new L(0,0,100,30));e.diagramBlocks.push(u),"mmroot"==i.type?n?e.diagramConnections.push(new Ft({blockUid:i.uid,slot:"ol"},{blockUid:u.uid,slot:"i"},"mm")):e.diagramConnections.push(new Ft({blockUid:i.uid,slot:"or"},{blockUid:u.uid,slot:"i"},"mm")):e.diagramConnections.push(new Ft({blockUid:i.uid,slot:"o"},{blockUid:u.uid,slot:"i"},"mm")),s.children&&this.addChildBlocksFromJson(s.children,e,u)}}catch(h){r=!0,a=h}finally{try{o||null==l.return||l.return()}finally{if(r)throw a}}}},{key:"toJSON",value:function(t){var e=t.diagramBlocks[0],i={root:{name:e.name}},n=t.diagramStructure.getOutputSlotConnections(e.uid,"ol");n.length>0&&(i.root.children={left:this.addChildBlocksFromScene(n,t)});var o=t.diagramStructure.getOutputSlotConnections(e.uid,"or");return o.length>0&&(i.root.children?i.root.children.right=this.addChildBlocksFromScene(o,t):i.root.children={right:this.addChildBlocksFromScene(o,t)}),i}},{key:"addChildBlocksFromScene",value:function(t,e){var i=[],n=!0,o=!1,r=void 0;try{for(var a,c=t[Symbol.iterator]();!(n=(a=c.next()).done);n=!0){var l=a.value,s=e.diagramStructure.blocks.get(l.to.blockUid),u={name:s.name},h=e.diagramStructure.getOutputSlotConnections(s.uid,"o");h.length>0&&(u.children=this.addChildBlocksFromScene(h,e)),i.push(u)}}catch(d){o=!0,r=d}finally{try{n||null==c.return||c.return()}finally{if(o)throw r}}return i}}]),t}();function Yt(){var t=Object(P.a)(["\nwidth: 80%;\nheight: 60%;\nmargin-left: 7%;\nmargin-top:3px;\n"]);return Yt=function(){return t},t}function Nt(){var t=Object(P.a)(["\n    position:absolute;\n    left :","px;\n    top : ","px;\n    width : ","px;\n    height : ","px;\n"]);return Nt=function(){return t},t}var Vt,$t,Gt,Qt=z.a.div(Nt(),(function(t){return t.rect.x}),(function(t){return t.rect.y}),(function(t){return t.rect.width}),(function(t){return t.rect.height})),Zt=z.a.input(Yt()),te=Object(U.a)(Ct=function(t){function e(t){var i;return Object(j.a)(this,e),(i=Object(B.a)(this,Object(C.a)(e).call(this,t))).myRef=b.a.createRef(),i.focusOut=!1,i.handleBlur=function(t){t.currentTarget.contains(t.relatedTarget)||(i.props.block.name=t.target.value,i.focusOut=!0)},i}return Object(D.a)(e,t),Object(x.a)(e,[{key:"componentDidMount",value:function(){this.props.block.finishedEditing=!1,this.myRef.current&&(this.myRef.current.focus(),this.myRef.current.setSelectionRange(0,this.props.block.name.length))}},{key:"componentWillUnmount",value:function(){console.log("Will unmount"),this.props.block.finishedEditing=!0}},{key:"render",value:function(){var t=this;return b.a.createElement(Zt,{ref:this.myRef,type:"text",value:this.props.block.name,onFocus:function(e){t.focusOut=!1},onBlur:function(e){return t.handleBlur(e)},onChange:function(e){t.focusOut||(t.props.block.name=e.target.value)},onKeyDown:this.props.onKeyDown})}}]),e}(b.a.Component))||Ct,ee=Object(U.a)((Dt=function(t){function e(){return Object(j.a)(this,e),Object(B.a)(this,Object(C.a)(e).apply(this,arguments))}return Object(D.a)(e,t),Object(x.a)(e,[{key:"render",value:function(){var t=this;if(this.props.scene.editedBlock){var e=L.copy(this.props.scene.editedBlock.rect);return e.x+=this.props.scene.sceneTranslate.x,e.y+=this.props.scene.sceneTranslate.y,b.a.createElement(Qt,{rect:e},b.a.createElement(te,{block:this.props.scene.editedBlock,onKeyDown:function(e){return t.handleKeyDown(e)}}))}return null}},{key:"handleKeyDown",value:function(t){this.props.scene.editedBlock&&"Enter"===t.key&&(this.props.scene.setEditedBlock(void 0),this.props.scene.onEdit=!0,this.props.scene.activeButtons=[])}}]),e}(b.a.Component),Object(M.a)(Dt.prototype,"handleKeyDown",[W.d],Object.getOwnPropertyDescriptor(Dt.prototype,"handleKeyDown"),Dt.prototype),Et=Dt))||Et;function ie(){var t=Object(P.a)(["\n    position:absolute;\n    width : 100%;\n    height : 100%;\n"]);return ie=function(){return t},t}var ne=z.a.div(ie()),oe=Object(U.a)(($t=function(t){function e(t){var i;Object(j.a)(this,e),i=Object(B.a)(this,Object(C.a)(e).call(this,t)),Object(S.a)(i,"diagramScene",Gt,Object(E.a)(i)),i.vscode=void 0,i.vscode=i.props.vscode,i.diagramScene=i.props.scene;var n=new Wt(H(),"Enter diagram name","mmroot",[new It("ol","o"),new It("or","o")],new L(0,0,100,30));return i.diagramScene.diagramBlocks.push(n),i.addCallbacks(i.diagramScene.diagramBlocks),i.diagramScene.layout(),window.addEventListener("message",(function(t){var e=t.data;switch(e.command){case"setJsonDocument":Mt.info("setJsonDocument",e.document);var n=e.document;i.vscode.setState(n),i.diagramScene=Xt.fromJSON(n),i.diagramScene.layout(),i.addCallbacks(i.diagramScene.diagramBlocks);break;case"addChild":Mt.info("addChild message"),i.diagramScene.selectedBlock&&(i.diagramScene.editedBlock&&i.diagramScene.setEditedBlock(void 0),i.addBlock(i.diagramScene.selectedBlock));break;case"addSibling":Mt.info("addSibling message"),i.diagramScene.selectedBlock&&(i.diagramScene.editedBlock&&i.diagramScene.setEditedBlock(void 0),i.addSibling(i.diagramScene.selectedBlock));break;case"remove":Mt.info("removeBlock message"),i.diagramScene.selectedBlock&&(i.diagramScene.editedBlock&&i.diagramScene.setEditedBlock(void 0),i.removeBlock(i.diagramScene.selectedBlock))}})),Object(W.e)((function(){if(i.diagramScene.onEdit&&i.vscode&&!i.diagramScene.editedBlock){var t=Xt.toJSON(i.diagramScene);i.vscode.postMessage({message:"setDocument",document:t}),i.vscode.setState(t),i.diagramScene.onEdit=!1}})),i}return Object(D.a)(e,t),Object(x.a)(e,[{key:"addCallbacks",value:function(t){var e=this,i=!0,n=!1,o=void 0;try{for(var r,a=t[Symbol.iterator]();!(i=(r=a.next()).done);i=!0){var c=r.value;c.on("click",(function(t){var i=new Tt("addB","topRight","add","red",(function(){e.addBlock(t)})),n=new Tt("removeB","topRight","remove","red",(function(){e.removeBlock(t)}));e.diagramScene.showBlockButtons(t,[i,n])})),c.on("dragEnd",(function(t,i){Mt.info("Block drag end '".concat(t.name,"' (").concat(i.x,",").concat(i.y,")")),e.endDragging(t,i),e.diagramScene.layout()})),c.on("doubleClick",(function(t){Mt.info("Block double click ".concat(t.uid)),e.diagramScene.setEditedBlock(t),e.diagramScene.activeButtons=[]}))}}catch(l){n=!0,o=l}finally{try{i||null==a.return||a.return()}finally{if(n)throw o}}}},{key:"componentDidMount",value:function(){this.vscode&&this.vscode.postMessage({message:"getDocument"})}},{key:"render",value:function(){return b.a.createElement(ne,null,b.a.createElement(ee,{scene:this.diagramScene}),b.a.createElement(Rt,{diagramScene:this.diagramScene}))}},{key:"removeBlock",value:function(t){var e=this;if("mmroot"!==t.type){Mt.info("removeBlock ".concat(t.name));var i=this.diagramScene.diagramStructure.getChildBlocks(t.uid).map((function(t){return e.diagramScene.diagramStructure.blocks.get(t)}));i.push(t);var n=[],o=!0,r=!1,a=void 0;try{for(var c,l=i[Symbol.iterator]();!(o=(c=l.next()).done);o=!0){var s=c.value;n.push(this.diagramScene.diagramStructure.blockConnections.input.get(s.uid)[0])}}catch(O){r=!0,a=O}finally{try{o||null==l.return||l.return()}finally{if(r)throw a}}var u=!0,h=!1,d=void 0;try{for(var m,p=i[Symbol.iterator]();!(u=(m=p.next()).done);u=!0){var y=m.value,g=this.diagramScene.diagramBlocks.indexOf(y);this.diagramScene.diagramBlocks.splice(g,1)}}catch(O){h=!0,d=O}finally{try{u||null==p.return||p.return()}finally{if(h)throw d}}for(var f=0,b=n;f<b.length;f++){var k=b[f],v=this.diagramScene.diagramConnections.indexOf(k);this.diagramScene.diagramConnections.splice(v,1)}this.diagramScene.layout(),this.diagramScene.onEdit=!0,this.diagramScene.selectedBlock=void 0,this.diagramScene.activeButtons=[]}}},{key:"addSibling",value:function(t){if("mmroot"!=t.type){var e=this.diagramScene.diagramStructure.blockConnections.input.get(t.uid)[0].from.blockUid,i=this.diagramScene.diagramStructure.blocks.get(e);this.addBlock(i),this.diagramScene.activeButtons=[]}}},{key:"addBlock",value:function(t){Mt.info("addBlock (parent=".concat(t.name,")"));var e,i=new Wt(H(),"Unnamed element","mm",[new It("i","i"),new It("o","o")],new L(0,0,100,30));this.addCallbacks([i]),e="mmroot"===t.type?new Ft({blockUid:t.uid,slot:"or"},{blockUid:i.uid,slot:"i"},"mm"):new Ft({blockUid:t.uid,slot:"o"},{blockUid:i.uid,slot:"i"},"mm"),this.diagramScene.diagramBlocks.push(i),this.diagramScene.diagramConnections.push(e),this.diagramScene.layout(),this.diagramScene.setEditedBlock(i),this.diagramScene.selectedBlock=i,this.diagramScene.onEdit=!0,this.diagramScene.activeButtons=[]}},{key:"endDragging",value:function(t,e){var i=this;if(Mt.info("endDragging ".concat(t.name," : (").concat(e.x,", ").concat(e.y,")")),"mmroot"!==t.type){var n=this.diagramScene.blockLayout,o=this.diagramScene,r=o.diagramStructure,a=r.blockConnections.input.get(t.uid),c=r.blocks.get(a[0].from.blockUid),l=this.diagramScene.diagramStructure.getChildBlocks(t.uid).map((function(t){return i.diagramScene.diagramStructure.blocks.get(t)})),s=n.getBlocks(e);if(s=J.apply(void 0,[s,t].concat(Object(w.a)(l))),Pt.info("found N occupied blocks ".concat(s.length)),s.length>0){var u,h=s[0],d=[t.uid].concat(r.getChildBlocks(t.uid)),m=d.map((function(t){return r.blocks.get(t)}));this.diagramScene.diagramConnections=J(o.diagramConnections,r.blockConnections.input.get(t.uid)[0]),this.diagramScene.diagramBlocks=J.apply(void 0,[this.diagramScene.diagramBlocks].concat(Object(w.a)(m)));var p=o.diagramBlocks.indexOf(h);(u=o.diagramBlocks).splice.apply(u,[p+1,0].concat(Object(w.a)(m))),"mmroot"===h.type?e.x>0?o.diagramConnections.push(new Ft({blockUid:h.uid,slot:"or"},{blockUid:d[0],slot:"i"},"mm")):o.diagramConnections.push(new Ft({blockUid:h.uid,slot:"ol"},{blockUid:d[0],slot:"i"},"mm")):o.diagramConnections.push(new Ft({blockUid:h.uid,slot:"o"},{blockUid:d[0],slot:"i"},"mm")),o.layout(),this.diagramScene.onEdit=!0}else{"mmroot"===c.type&&(e.x>0?a[0].from.slot="or":a[0].from.slot="ol");var y=a[0],g=n.getChildIdx(t.uid,y.from.blockUid,e.y),f=Object(O.a)(g,2),b=f[0],k=f[1];if(Pt.info("Child idx ".concat(k,"[").concat(b,"]")),k.length>0){var v=-1,S=null;b===k.length||(v=k[b],S=o.diagramBlocks[v]);var j=[t.uid].concat(r.getChildBlocks(t.uid)).map((function(t){return r.blocks.get(t)}));if(o.diagramBlocks=J.apply(void 0,[o.diagramBlocks].concat(Object(w.a)(j))),S){var x,B=o.diagramStructure.blockConnections.input.get(S.uid)[0],C=o.diagramConnections.indexOf(B),E=this.diagramScene.diagramConnections.indexOf(y);this.diagramScene.diagramConnections.splice(E,1),this.diagramScene.diagramConnections.splice(C-1,0,y);var D=o.diagramBlocks.indexOf(S);(x=o.diagramBlocks).splice.apply(x,[D,0].concat(Object(w.a)(j)))}else{var M;(M=o.diagramBlocks).push.apply(M,Object(w.a)(j));var P=this.diagramScene.diagramConnections.indexOf(y);this.diagramScene.diagramConnections.splice(P,1),this.diagramScene.diagramConnections.push(y)}}o.layout(),this.diagramScene.onEdit=!0}}}}]),e}(b.a.Component),Gt=Object(M.a)($t.prototype,"diagramScene",[W.m],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),Object(M.a)($t.prototype,"removeBlock",[W.d],Object.getOwnPropertyDescriptor($t.prototype,"removeBlock"),$t.prototype),Object(M.a)($t.prototype,"addSibling",[W.d],Object.getOwnPropertyDescriptor($t.prototype,"addSibling"),$t.prototype),Object(M.a)($t.prototype,"addBlock",[W.d],Object.getOwnPropertyDescriptor($t.prototype,"addBlock"),$t.prototype),Object(M.a)($t.prototype,"endDragging",[W.d],Object.getOwnPropertyDescriptor($t.prototype,"endDragging"),$t.prototype),Vt=$t))||Vt,re=function t(e){Object(j.a)(this,t),this.image=void 0,this.image=e},ae=function(){var t=new Kt;if("undefined"!==typeof acquireVsCodeApi){var e=acquireVsCodeApi(),i=e.getState();return b.a.createElement("div",null,b.a.createElement(oe,{scene:t,jsonDiagram:i,vscode:e}))}return b.a.createElement("div",null,b.a.createElement("input",{type:"file",name:"picField",id:"picField",onChange:function(e){!function(e){if(e.target.files&&e.target.files.length>0){var i=new FileReader;i.onload=function(){var e=new re(i.result);t.diagramBlocks[0].image=e},i.readAsDataURL(e.target.files[0])}}(e)}}),b.a.createElement(oe,{scene:t}))};Boolean("localhost"===window.location.hostname||"[::1]"===window.location.hostname||window.location.hostname.match(/^127(?:\.(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)){3}$/));v.a.render(b.a.createElement(ae,null),document.getElementById("root")),"serviceWorker"in navigator&&navigator.serviceWorker.ready.then((function(t){t.unregister()}))}},[[49,1,2]]]);
//# sourceMappingURL=main.c20ffd91.chunk.js.map